# ============================================
# TRAEFIK DYNAMIC CONFIGURATION - MIDDLEWARES
# ============================================

http:
  middlewares:
    # === Real IP Forwarding ===
    real-ip:
      headers:
        customRequestHeaders:
          X-Real-IP: ""

    # === CORS Middleware ===
    cors-headers:
      headers:
        accessControlAllowMethods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS
          - PATCH
        accessControlAllowHeaders:
          - "*"
        accessControlAllowOriginList:
          - "*"  # Will be overridden by env
        accessControlExposeHeaders:
          - "*"
        accessControlMaxAge: 86400
        accessControlAllowCredentials: true
        addVaryHeader: true

    # === Security Headers ===
    security-headers:
      headers:
        frameDeny: false  # IoT Box може да се embedва
        contentTypeNosniff: true
        browserXssFilter: true
        referrerPolicy: "strict-origin-when-cross-origin"
        customFrameOptionsValue: "SAMEORIGIN"
        customResponseHeaders:
          X-Powered-By: "Odoo-IoT-Box"
          Server: ""  # Hide server info

    # === Rate Limiting ===
    rate-limit:
      rateLimit:
        average: 100
        period: 1m
        burst: 50

    # === Compression ===
    compression:
      compress: true

    # === Redirect HTTPS ===
    https-redirect:
      redirectScheme:
        scheme: https
        permanent: true

    # === IP Whitelist (за dashboard/admin) ===
    # admin-whitelist:
    #   ipWhiteList:
    #     sourceRange:
    #       - "127.0.0.1/32"
    #       - "192.168.0.0/16"

    # === Chain: Real IP + CORS + Security ===
    iot-chain:
      chain:
        middlewares:
          - real-ip
          - cors-headers
          - security-headers
          - compression
