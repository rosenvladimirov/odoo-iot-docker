---
# ============================================
# ODOO IOT BOX WITH STEP-CA & TRAEFIK
# ============================================

services:
  # ===========================================
  # STEP-CA - Certificate Authority
  # ===========================================
  step-ca:
    image: smallstep/step-ca:latest
    container_name: step-ca
    hostname: step-ca
    restart: unless-stopped

    ports:
      - "${STEP_CA_PORT:-9000}:9000"

    environment:
      - TZ=${TIMEZONE:-UTC}
      - IOT_DOMAIN=${IOT_DOMAIN:-iot-box.local}
      - DOCKER_STEPCA_INIT_NAME=IoT Box CA
      - DOCKER_STEPCA_INIT_DNS_NAMES=step-ca,localhost,iot-box.local
      - DOCKER_STEPCA_INIT_PROVISIONER_NAME=admin
      - DOCKER_STEPCA_INIT_PASSWORD=${STEP_CA_PASSWORD:-changeme-secure-password-here}

    volumes:
      - step-ca-data:/home/step

    networks:
      - iot-network

    healthcheck:
      test: ["CMD", "curl", "-kf", "https://localhost:9000/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 20s

    deploy:
      resources:
        limits:
          memory: ${STEP_CA_MEMORY_LIMIT:-256M}

  # ===========================================
  # POSTGRES - Database for Odoo IoT
  # ===========================================
  db:
    image: postgres:17
    container_name: iot-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_DB=odoo
      - POSTGRES_USER=odoo
      - POSTGRES_PASSWORD=odoo
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - iot-network

  # ===========================================
  # CUPS - Print Server
  # ===========================================
  cups:
    image: infra7/cups:latest
    container_name: iot-cups
    restart: unless-stopped
    ports:
      - "631:631"
    environment:
      - TZ=${TIMEZONE:-UTC}
      - CUPSADMIN=${CUPS_ADMIN:-admin}
      - CUPSPASSWORD=${CUPS_PASSWORD:-changeme}
    volumes:
      - cups-config:/etc/cups
      - cups-spool:/var/spool/cups
      - cups-logs:/var/log/cups
      - cups-run:/var/run/cups
    networks:
      - iot-network

  # ===========================================
  # TRAEFIK - Reverse Proxy
  # ===========================================
  traefik:
    image: traefik:latest
    container_name: iot-traefik
    restart: unless-stopped

    security_opt:
      - no-new-privileges:true

    ports:
      - "${HTTP_PORT:-80}:80"
      - "${HTTPS_PORT:-443}:443"
      - "${TRAEFIK_DASHBOARD_PORT:-8080}:8080"

    environment:
      - TZ=${TIMEZONE:-UTC}
      - IOT_DOMAIN=${IOT_DOMAIN:-iot-box.local}

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./docker/traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./docker/traefik/dynamic:/etc/traefik/dynamic:ro
      - step-ca-data:/step-ca:ro
      - traefik-logs:/var/log/traefik

    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=iot-network"
      - "traefik.http.routers.traefik-dashboard.rule=Host(`traefik.${IOT_DOMAIN:-iot-box.local}`)"
      - "traefik.http.routers.traefik-dashboard.entrypoints=websecure"
      - "traefik.http.routers.traefik-dashboard.tls=true"
      - "traefik.http.routers.traefik-dashboard.service=api@internal"
      - "traefik.http.routers.traefik-dashboard.middlewares=traefik-auth"
      - "traefik.http.middlewares.traefik-auth.basicauth.users=${TRAEFIK_DASHBOARD_USER:-admin}:${TRAEFIK_DASHBOARD_PASSWORD:-$$apr1$$xyz}"

    networks:
      - iot-network

    depends_on:
      step-ca:
        condition: service_healthy

    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 30s
      timeout: 10s
      retries: 3

    deploy:
      resources:
        limits:
          memory: ${TRAEFIK_MEMORY_LIMIT:-128M}


  # ===========================================
  # IOT BOX - Main Application
  # ===========================================
  iot-box:
    image: odoo-iot-box:1.0.0
    container_name: odoo-iot-box
    hostname: ${IOT_IDENTIFIER:-iot-box}
    restart: unless-stopped

    networks:
      - iot-network

    cap_add:
      - NET_ADMIN
      - NET_RAW

    privileged: true

    devices:
      - /dev/bus/usb:/dev/bus/usb
      - /dev:/dev
      - /dev/rfkill:/dev/rfkill

    volumes:
      - ./docker/config:/app/config:ro
      - iot-logs:/app/logs
      - step-ca-data:/app/step-ca:ro
      - iot-data:/app/data
      - /var/run/dbus:/var/run/dbus:ro
      - cups-run:/var/run/cups:ro
      - /etc/NetworkManager/system-connections:/etc/NetworkManager/system-connections

    environment:
      - IOT_IN_DOCKER=true
      - IOT_IDENTIFIER=${IOT_IDENTIFIER:-}
      - TZ=${TIMEZONE:-UTC}
      - ODOO_RC=/app/config/odoo.conf
      - LOG_FILE=/app/logs/odoo.log
      - LOG_LEVEL=${ODOO_LOG_LEVEL:-info}
      - IOT_DOMAIN=${IOT_DOMAIN:-iot-box.local}
      - DEV_MODE=${DEV_MODE:-false}
      - STEP_CA_URL=https://step-ca:9000
      - PKCS11_LIB_PATH=/usr/lib/x86_64-linux-gnu/opensc-pkcs11.so

    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=iot-network"

      # HTTP -> HTTPS redirect
      - "traefik.http.routers.iot-http.rule=Host(`${IOT_DOMAIN:-iot-box.local}`)"
      - "traefik.http.routers.iot-http.entrypoints=web"
      - "traefik.http.routers.iot-http.middlewares=https-redirect@file"

      # HTTPS router
      - "traefik.http.routers.iot-https.rule=Host(`${IOT_DOMAIN:-iot-box.local}`)"
      - "traefik.http.routers.iot-https.entrypoints=websecure"
      - "traefik.http.routers.iot-https.tls=true"
      - "traefik.http.routers.iot-https.middlewares=iot-chain@file"

      # Service configuration
      - "traefik.http.services.iot-service.loadbalancer.server.port=8069"
      - "traefik.http.services.iot-service.loadbalancer.server.scheme=http"
      - "traefik.http.services.iot-service.loadbalancer.passhostheader=true"

      # Health check
      - "traefik.http.services.iot-service.loadbalancer.healthcheck.path=/hw_proxy/hello"
      - "traefik.http.services.iot-service.loadbalancer.healthcheck.interval=30s"
      - "traefik.http.services.iot-service.loadbalancer.healthcheck.timeout=10s"

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8069/hw_proxy/hello"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    deploy:
      resources:
        limits:
          memory: ${IOT_BOX_MEMORY_LIMIT:-512M}

    depends_on:
      traefik:
        condition: service_healthy
      db:
        condition: service_started
      cups:
        condition: service_started

# ===========================================
# NETWORKS
# ===========================================
networks:
  iot-network:
    external: true

# ===========================================
# VOLUMES
# ===========================================
volumes:
  step-ca-data:
    external: true

  postgres-data:
    external: true

  cups-config:
    external: true
  cups-spool:
    external: true
  cups-logs:
    external: true
  cups-run:
    external: true

  traefik-logs:
    external: true

  iot-logs:
    external: true
  iot-data:
    external: true