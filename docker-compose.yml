---
# ============================================
# ODOO IOT BOX WITH STEP-CA & TRAEFIK
# ============================================

services:
  # ===========================================
  # STEP-CA INIT - еднократна инициализация на PKI
  # ===========================================
  step-ca-init:
    image: smallstep/step-cli:latest
    container_name: step-ca-init
    user: "0:0"
    restart: "no"
    environment:
      - STEP_CA_PASSWORD=${STEP_CA_PASSWORD:-changeme}
      - STEP_CA_NAME=${STEP_CA_NAME:-IoT Box CA}
      - IOT_DOMAIN=${IOT_DOMAIN:-iot-box.local}
      - STEP_CA_PROVISIONER=${STEP_CA_PROVISIONER:-admin}
    volumes:
      - ./docker/step-ca/local-pki:/home/step
    command: >
      sh -c "
        mkdir -p /home/step/secrets &&
        if [ ! -f /home/step/secrets/password ]; then
          echo \"$STEP_CA_PASSWORD\" > /home/step/secrets/password &&
          chmod 600 /home/step/secrets/password;
        fi &&
        if [ -f /home/step/config/ca.json ]; then
          echo 'CA already initialized, skipping step ca init';
          exit 0;
        fi &&
        mkdir -p /home/step/config /home/step/certs /home/step/db &&
        step ca init
          --name \"$STEP_CA_NAME\"
          --dns \"$IOT_DOMAIN\"
          --address \":9000\"
          --provisioner \"$STEP_CA_PROVISIONER\"
          --password-file /home/step/secrets/password &&
        chown -R 1000:1000 /home/step
      "

  # ===========================================
  # STEP-CA - Certificate Authority
  # ===========================================
  step-ca:
    image: smallstep/step-ca:latest
    container_name: step-ca
    hostname: step-ca
    restart: unless-stopped

    ports:
      - "${STEP_CA_PORT:-9000}:9000"

    environment:
      - TZ=${TIMEZONE:-UTC}
      - IOT_DOMAIN=${IOT_DOMAIN:-iot-box.local}

    volumes:
      - ./docker/step-ca/local-pki:/home/step

    networks:
      - iot-network

    healthcheck:
      test: ["CMD", "curl", "-k", "-f", "https://localhost:9000/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s

    deploy:
      resources:
        limits:
          memory: ${STEP_CA_MEMORY_LIMIT:-256M}

  # ===========================================
  # POSTGRES - Database for Odoo IoT
  # ===========================================
  db:
    image: postgres:17
    container_name: iot-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_DB=odoo
      - POSTGRES_USER=odoo
      - POSTGRES_PASSWORD=odoo
    volumes:
      - pgdata:/var/lib/postgresql/data
    networks:
      - iot-network

  # ===========================================
  # CUPS - Print Server
  # ===========================================
  cups:
    image: infra7/cups:latest
    container_name: iot-cups
    restart: unless-stopped
    ports:
      - "631:631"  # по избор, ако искаш да достъпваш CUPS UI отвън
    environment:
      - TZ=${TIMEZONE:-UTC}
      # админ потребител/парола за CUPS, идват от .env
      - CUPSADMIN=${CUPS_ADMIN:-admin}
      - CUPSPASSWORD=${CUPS_PASSWORD:-changeme}
    volumes:
      # взимаме конфига от локална папка в проекта
      - ./docker/cups/config:/etc/cups
      - cups-spool:/var/spool/cups
      - cups-log:/var/log/cups
      - cups-run:/var/run/cups
    networks:
      - iot-network

  # ===========================================
  # TRAEFIK - Reverse Proxy
  # ===========================================
  traefik:
    image: traefik:latest
    container_name: iot-traefik
    restart: unless-stopped

    security_opt:
      - no-new-privileges:true

    ports:
      - "${HTTP_PORT:-80}:80"
      - "${HTTPS_PORT:-443}:443"
      - "${TRAEFIK_DASHBOARD_PORT:-8080}:8080"

    environment:
      - TZ=${TIMEZONE:-UTC}
      - IOT_DOMAIN=${IOT_DOMAIN:-iot-box.local}

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./docker/traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./docker/traefik/dynamic:/etc/traefik/dynamic:ro
      - ./docker/step-ca/local-pki/certs:/certs:ro
      - ./logs/traefik:/var/log/traefik

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik-dashboard.rule=Host(`traefik.${IOT_DOMAIN:-iot-box.local}`)"
      - "traefik.http.routers.traefik-dashboard.entrypoints=websecure"
      - "traefik.http.routers.traefik-dashboard.tls=true"
      - "traefik.http.routers.traefik-dashboard.service=api@internal"
      - "traefik.http.routers.traefik-dashboard.middlewares=traefik-auth"
      - "traefik.http.middlewares.traefik-auth.basicauth.users=${TRAEFIK_DASHBOARD_USER:-admin}:${TRAEFIK_DASHBOARD_PASSWORD:-$$apr1$$xyz}"

    networks:
      - iot-network

    depends_on:
      step-ca:
        condition: service_healthy

    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 30s
      timeout: 10s
      retries: 3

    deploy:
      resources:
        limits:
          memory: ${TRAEFIK_MEMORY_LIMIT:-128M}

  # ===========================================
  # IOT BOX - Main Application
  # ===========================================
  iot-box:
    image: odoo-iot-box:1.0.0
    container_name: odoo-iot-box
    hostname: ${IOT_IDENTIFIER:-iot-box}
    restart: unless-stopped

    networks:
      - iot-network

    cap_add:
      - NET_ADMIN
      - NET_RAW

    privileged: true

    devices:
      - /dev/bus/usb:/dev/bus/usb
      - /dev:/dev
      - /dev/rfkill:/dev/rfkill

    volumes:
      - ${CONFIG_PATH:-./config}:/app/config
      - ${LOGS_PATH:-./logs}/iot:/app/logs
      - ./docker/step-ca/local-pki/certs:/app/certs:ro
      - iot-data:/app/data
      - /var/run/dbus:/var/run/dbus:ro
      # вместо хостския /var/run/cups, ползваме този от cups контейнера
      - cups-run:/var/run/cups:ro
      - /etc/NetworkManager/system-connections:/etc/NetworkManager/system-connections

    environment:
      - IOT_IN_DOCKER=true
      - IOT_IDENTIFIER=${IOT_IDENTIFIER:-}
      - TZ=${TIMEZONE:-UTC}
      - ODOO_RC=/app/config/odoo.conf
      - LOG_FILE=/app/logs/odoo.log
      - LOG_LEVEL=${ODOO_LOG_LEVEL:-info}
      - IOT_DOMAIN=${IOT_DOMAIN:-iot-box.local}
      - DEV_MODE=${DEV_MODE:-false}
      - STEP_CA_URL=https://step-ca:9000
      - PKCS11_LIB_PATH=/usr/lib/x86_64-linux-gnu/opensc-pkcs11.so

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.iot-http.rule=Host(`${IOT_DOMAIN:-iot-box.local}`)"
      - "traefik.http.routers.iot-http.entrypoints=web"
      - "traefik.http.routers.iot-http.middlewares=https-redirect@file"
      - "traefik.http.routers.iot-https.rule=Host(`${IOT_DOMAIN:-iot-box.local}`)"
      - "traefik.http.routers.iot-https.entrypoints=websecure"
      - "traefik.http.routers.iot-https.tls=true"
      - "traefik.http.routers.iot-https.middlewares=iot-chain@file"
      - "traефик.http.services.iot-service.loadbalancer.server.port=8069"
      - "traефик.http.services.iot-service.loadbalancer.healthcheck.path=/hw_proxy/hello"
      - "traефик.http.services.iot-service.loadbalancer.healthcheck.interval=30s"

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8069/hw_proxy/hello"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    deploy:
      resources:
        limits:
          memory: ${IOT_BOX_MEMORY_LIMIT:-512M}

    depends_on:
      traefik:
        condition: service_healthy
      db:
        condition: service_started
      cups:
        condition: service_started

# ===========================================
# NETWORKS
# ===========================================
networks:
  iot-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# ===========================================
# VOLUMES
# ===========================================
volumes:
  iot-data:
    driver: local

  pgdata:
    driver: local

  cups-config:
    driver: local
  cups-spool:
    driver: local
  cups-log:
    driver: local
  cups-run:
    driver: local