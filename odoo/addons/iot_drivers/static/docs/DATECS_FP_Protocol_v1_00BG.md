# ОПИСАНИЕ НА ПРОГРАМНИЯ ИНТЕРФЕЙС КЪМ ФИСКАЛЕН ПРИНТЕР

**DATECS FP-800 / FP-2000 / FP-650 / SK1-21F / SK1-31F / FMP-10 / FP-550**

**Версия 1.00BG**

---

## ВЪВЕДЕНИЕ

Фискалното устройство работи под управлението на приложна програма, комуникирайки с нея чрез асинхронен сериен канал за връзка RS232 или по друг интерфейс. То е предназначено да изпълнява предварително определен набор от команди, логически подредени в зависимост от вида на операциите, които трябва да се изпълнят. Приложната програма няма директен достъп до ресурсите на фискалното устройство, но може да извлича данни, свързани със състоянието на фискалното устройство и фискалната памет.

### Видове операции

Фискалното устройство изпълнява следните видове операции:

- Запомняне на индивидуалния номер на фискалното устройство и номера на фискалната памет.
- Запомняне на фискалните параметри, като ЕИК, номер по ЗДДС на данъчно задълженото лице, дата на въвеждане в експлоатация и др.
- Запомняне на информация за собственика, като адрес, име и др.
- Запомняне на стойностите на продажбите и генериране на клиентски бон.
- Запомняне на дневния оборот във фискалната памет и генериране на дневен финансов отчет.
- Запомняне на текста от фискалните бонове и дневните отчети в КЛЕН и справки от КЛЕН при заявка.
- Генериране на отчети за реализираните продажби и съдържанието на фискалната памет.
- Отпечатване на отчети, генерирани от приложението.
- Извеждане на данни към приложната програма.
- Изпращане на данни до НАП по GPRS модем.

---

## ДАНЪЧНИ ГРУПИ И ИЗЧИСЛЯВАНЕ НА ДДС

Всяка продажба е причислена към определена данъчна група (ДДС), която определя данъчната ставка, приложена към базовата цена за формиране цената на продажбата. Фискалният принтер може да работи с най-много 8 данъчни групи, обозначени обикновено с първите букви от азбуката на езика за съответната страна, за която е настроен фискалния принтер (ФП), за България – **'А', 'Б', 'В', 'Г', 'Д', 'Е', 'Ж' и 'З'**.

### Данъчни ставки

За всяка от данъчните групи се задава данъчна ставка (в проценти), която трябва да бъде число не по-голямо от 99.00, с не повече от два десетични знака. Част от осемте стандартни данъчни групи могат да се забраняват, чрез установяване на `Enabled_taxes` в команда 83 (53H).

Командите за продажба приемат като параметър главните букви **'А', 'Б', 'В', 'Г', 'Д', 'Е', 'Ж' и 'З'** (в DOS-овска или 1251 кодова таблица) или съответно началните букви от латинската азбука **'A', 'B', 'C', 'D', 'E', 'F', 'G' и 'H'**. Същото се отнася и за всички команди, очакващи данъчна група като входен параметър (например програмиране на артикул в команда 107). 

> **ВАЖНО:** ЛАТИНИЦАТА Е ДОПУСТИМА САМО КАТО ВХОДЕН ПАРАМЕТЪР! Навсякъде при печат данъчните групи са на кирилица!

### Формули за изчисление

**Нетната стойност** на продажбата се изчислява по формулата:

```
Сума_нето = ROUND(Оборот/(1 + Ставка))
```

Функцията `ROUND` извършва стандартно закръгляне до най-малката използвана единица валута (стотинки или левове при работа с цели числа).

**Стойността на платимият данък** се изчислява по формулата:

```
Данък = Оборот – Сума_нето
```

---

## РЕЖИМИ НА РАБОТА НА ФИСКАЛНОТО УСТРОЙСТВО

Фискалното устройство може да работи в два режима.

### 1. Учебен режим

Устройството не е фискализирано. Всички данни, необходими за нормалната му работа са въведени и записани във фискалната памет с изключение на ЕИК на собственика и данъчните ставки. 

**Особености:**
- Могат да се отварят и издават клиентски бонове, но винаги върху тях се изписва **„нефискален бон"**.
- Могат да се извършват дневни финансови отчети с нулиране, но те **не се записват във фискалната памет**.
- Отпечатаната информация **не се записва в КЛЕН**.

### 2. Нормален режим

Устройството е фискализирано. ЕИК на собственика е въведен и записан във фискалната памет. 

**Особености:**
- Прилагат се всички фискални правила.
- Направена е регистрация в НАП по модема.
- Получени са и са записани съответните номера.

---

## СЪСТОЯНИЯ НА ФИСКАЛНОТО УСТРОЙСТВО

Фискалният принтер може да се намира в няколко състояния. Преминаването му от едно състояние в друго не винаги е възможно. Управлението на принтера, както и преходите между състоянията, когато това е възможно, се осъществяват от приложната програма в Host (PC), която трябва да бъде строго съобразена с използвания протокол. 

> **ВНИМАНИЕ:** При неправилно прилагане на протокола е възможно принтера да попадне в нежелано състояние или да бъде пропуснато преминаването му през дадено състояние, което съответно води до попадане на принтера в състоянието **ГРЕШКА**.

### А) НАЧАЛНО СЪСТОЯНИЕ

В това състояние трябва да се установят датата и часът, да се програмира номера на фискалната памет, индивидуалният номер на устройството и кодът на държавата. 

> **ВАЖНО:** ТЕЗИ ОПЕРАЦИИ СЕ ИЗВЪРШВАТ ПРЕДИ ПРЕДАВАНЕ НА КЛИЕНТА САМО ОТ ПРОИЗВОДИТЕЛЯ!

**Команди:** 61 (3DH) и 91 (5BH)

### Б) СЪСТОЯНИЕ СЛЕД ЗАДАВАНЕ НА СЕРИЕН НОМЕР И НОМЕР НА ФИСКАЛНАТА ПАМЕТ

В това състояние трябва:

- Да се форматира КЛЕН с команда **134 (86H)**.
- Да се зададат името на валутата, броя десетични знаци и броя и размера на данъчните ставки с команда **83 (53H)**.

След като се извършат тези операции фискалният принтер е готов да се предаде на клиента, който ще го ползва, т.е. в това състояние устройствата се държат в склада на производителя.

### В) СЪСТОЯНИЕ ПРИ ПРЕДОСТАВЯНЕ НА КЛИЕНТ

В това състояние трябва да се зададат **"header"** и **"footer"**, които всъщност са началото и края на всеки бон. 

- В "header"-а обикновено се записва информация за собственика (име на фирмата, адрес и др.)
- Във "footer"-a някакъв рекламен текст

Трябва да се изпълни командата **43 (2BH)** толкова пъти колкото редове се установяват.

Може да се направят допълнителни настройки като програмиране на графично лого, плътност на печат, настройки на серийния порт и други.

### Г) УЧЕБЕН РЕЖИМ

В това състояние ФП се намира докато не се фискализира. 

**Възможности:**
- Издаването на бонове (дори и клиентските бонове се маркират като нефискални)
- Извършването на дневен финансов отчет с нулиране (Z-отчет), но без запис във фискалната памет
- Зададен е ЕИК, но той не е записан във фискалната памет и може да се променя
- Часовникът може да се сверява произволно

> **ВАЖНО:** В учебен режим фискалният принтер **НЕ МОЖЕ ДА БЪДЕ ИЗПОЛЗУВАН в търговски обекти** – предназначението му е само за обучение.

### Д) ФИСКАЛИЗИРАН И РЕГИСТРИРАН ФИСКАЛЕН ПРИНТЕР

В това състояние:
- Могат да се издават клиентски финансови бонове, маркирани като фискални
- При извършване на дневен финансов отчет с нулиране (Z-отчет) се прави запис във фискалната памет
- Сверяването на датата е допустимо само напред спрямо последния запис във фискалната памет
- ЕИК се записва във ФП и повече не може да се променя
- **НЕ Е ВЪЗМОЖНО** излизането на принтера от фискален режим без смяна на фискалната памет

**Процес на фискализация:**
1. Установяване на ЕИК с команда **98 (62H)** (ако вече не е зададен)
2. Изпълнение на командата **72 (48H)**
3. Регистрация в НАП с предвидената програма

### Е) НЕОБРАТИМА ГРЕШКА ВЪВ ФИСКАЛНИЯ ПРИНТЕР

В това състояние фискалният принтер попада в случай, че е установена сериозна техническа или логическа грешка при работа на устройството, както и в случай на неизправност на модула фискална памет, КЛЕН или данъчния терминал.

**Симптоми:**
- След включване се печата с удебелен шрифт **"ФАТАЛНА ГРЕШКА: 4"** при грешка във фискалната памет
- Описателно съобщение за проблема с някое от другите периферни устройства
- Принтерът отказва да изпълнява команди за отваряне на фискални бонове
- Могат да се изпълняват само диагностични команди и периодични отчети

**Решение:** Необходимо е зануляване на RAM и поставянето на нов модул фискална памет, КЛЕН или данъчен терминал в зависимост от повредата.

> **ВАЖНО:** ТЕЗИ ОПЕРАЦИИ Е ЗАДЪЛЖИТЕЛНО ДА БЪДАТ ИЗВЪРШВАНИ ОТ УПЪЛНОМОЩЕН ОТ БЪЛГАРСКИ ИНСТИТУТ ПО МЕТРОЛОГИЯ СЕРВИЗ, ПРИТЕЖАВАЩ УДОСТОВЕРЕНИЕ ЗА СЕРВИЗИРАНЕ НА СЪОТВЕТНИЯ МОДЕЛ ФИСКАЛНО УСТРОЙСТВО, С КОЙТО ЗАДЪЛЖЕНОТО ЛИЦЕ ИМА СКЛЮЧЕН ДОГОВОР ЗА СЕРВИЗНО ОБСЛУЖВАНЕ.

#### Събития довеждащи до това състояние:

- Невъзможно извършване на верен запис във фискалната памет
- Невалидна контролна сума на ЕИК, индивидуален номер на фискалното устройство, номер на фискалната памет или някой от записите с данъчни ставки
- Неразпознаване формата на модула фискална памет
- При проверката на фискалната памет след включване се намерят повече от три невалидни контролни суми на фискален запис от дневен финансов отчет
- Липсваща комуникация с данъчния терминал или „чужд" данъчен терминал
- Липсваща комуникация с КЛЕН или КЛЕН от друг принтер
- Запълнен КЛЕН (малко вероятно, предвид размера на КЛЕН)

---

## ИНДИКАЦИЯ НА СЪСТОЯНИЕТО НА ПРИНТЕРА НА ЛИЦЕВИЯ ПАНЕЛ

Състоянието на принтера се показва от светодиода на лицевия панел.

### Зелена индикация

| Сигнал | Значение |
|--------|----------|
| Свети постоянно | Принтерът е в готовност за изпълнение на команди |
| Мига равномерно около 2 пъти в секунда | Принтерът изпълнява продължителна команда. Трябва да се изчака |

### Червена индикация

| Сигнал | Значение |
|--------|----------|
| Мига равномерно около 2 пъти в секунда веднага след включване | Принтерът се инициализира и проверява работоспособността си |
| Не свети | Периферията е в нормално работно състояние |
| Свети постоянно | Няма хартия или е отворен капак |
| Мига равномерно около 2 пъти в секунда | Печатащата глава е прегряла. След изстиването печатът ще продължи автоматично |
| Мига неравномерно - 2 пъти и след това пауза | Няма комуникация с КЛЕН. Може да се направи ресет. Ако това не помогне, необходима е сервизна намеса |

---

## КОНФИГУРАЦИОННИ КЛЮЧЕТА НА ФИСКАЛНИЯ ПРИНТЕР

Принтерът използува 16 бита от флаш-паметта като конфигурационни ключета, които задават режима на устройството. Промяната на стойността им става с команда **41 (29H)**.

### Таблица на конфигурационните ключета

| Ключ | Изключено | Включено |
|------|-----------|----------|
| 1 | Нормален режим на дисплея | Режим „Прозрачен дисплей" |
| 2 | Работа със стандартен дисплей на ДАТЕКС | Работа с дисплей с кодова таблица 1251 |
| 3* | Печат на 3-инчова хартиена лента | Печат на тясна хартия |
| 4 | Няма автоматично отрязване | Автоматично отрязване на хартията след бон |
| 5 | Кирилицата е по кодова таблица 1251 | Кирилицата е по DOS-овска таблица (856) |
| 6-8 | Задава скоростта на предаване на серийния порт | |
| 9** | Не се използва | Разрешава полурязане |
| 10*** | Не се използва | Разрешава работата на презентер |
| 11 | Не се използва | |
| 12 | 115200 bps комуникация с модема | 230400 bps комуникация с модема |
| 13-16 | Не се използва | |

### Избор на скорост на предаване на серийния порт

| Ключе 6 | Ключе 7 | Ключе 8 | Скорост (bps) |
|---------|---------|---------|---------------|
| ИЗКЛ | ИЗКЛ | ИЗКЛ | 1200 |
| ВКЛ | ИЗКЛ | ИЗКЛ | 2400 |
| ИЗКЛ | ВКЛ | ИЗКЛ | 4800 |
| ВКЛ | ВКЛ | ИЗКЛ | 9600 |
| ИЗКЛ | ИЗКЛ | ВКЛ | 19200 |
| ВКЛ | ИЗКЛ | ВКЛ | 38400 |
| ИЗКЛ | ВКЛ | ВКЛ | 57600 |
| ВКЛ | ВКЛ | ВКЛ | 115200 |

**Забележки:**
- \* По подразбиране принтерите не поддържащи работа с 3 инчова хартия не приемат ключе 3. При FP-550 състояние 1 позволява да не се ползва втория печатащ механизъм.
- \*\* Разрешава полурязане и автоматично спира работата на презентера дори да е разрешен.
- \*\*\* Разрешава работата на презентер при принтери SK1-21F и SK1-31F

---

## СТАТУС БИТОВЕ НА ФИСКАЛНИЯ ПРИНТЕР

Текущото състояние на устройството е кодирано в поле с дължина 6 байта, което се предава в рамката на всяко съобщение от фискалния принтер.

### Байт 0: Общо предназначение

| Бит | Описание |
|-----|----------|
| 0.7 | Резервиран – винаги е 1 |
| 0.6 | Отворен е капакът на принтера |
| 0.5 | Обща грешка - това е OR на всички грешки, маркирани с '#' |
| 0.4 # | Механизмът на печатащото устройство има неизправност |
| 0.3 | Не е свързан клиентски дисплей |
| 0.2 | Часовникът не е установен |
| 0.1 # | Кодът на получената команда е невалиден |
| 0.0 # | Получените данни имат синтактична грешка |

### Байт 1: Общо предназначение

| Бит | Описание |
|-----|----------|
| 1.7 | Резервиран – винаги е 1 |
| 1.6 | Вграденият данъчен терминал не отговаря |
| 1.5 | Отворен е служебен бон за печат на завъртян на 90 градуса текст |
| 1.4 | Отворен сторно бон |
| 1.3 # | Слаба батерия (Часовникът за реално време е в състояние RESET) |
| 1.2 # | Извършено е зануляване на оперативната памет |
| 1.1 # | Изпълнението на командата не е позволено в текущия фискален режим |
| 1.0 | При изпълнение на командата се е получило препълване на някои полета от сумите |

### Байт 2: Общо предназначение

| Бит | Описание |
|-----|----------|
| 2.7 | Резервиран – винаги е 1 |
| 2.6 | Много близък край на КЛЕН (допускат се само определени бонове) |
| 2.5 | Отворен е служебен бон |
| 2.4 | Близък край на КЛЕН (по-малко от 10 MB от КЛЕН свободни) |
| 2.3 | Отворен е фискален бон |
| 2.2 | Край на КЛЕН (по-малко от 1 MB от КЛЕН свободни) |
| 2.1 | Останала е малко хартия |
| 2.0 # | Свършила е хартията |

### Байт 3: За състояние на конфигурационните ключета

| Бит | Описание |
|-----|----------|
| 3.7 | Резервиран – винаги е 1 |
| 3.6 | Състояние на Sw7 |
| 3.5 | Състояние на Sw6 |
| 3.4 | Състояние на Sw5 |
| 3.3 | Състояние на Sw4 |
| 3.2 | Състояние на Sw3 |
| 3.1 | Състояние на Sw2 |
| 3.0 | Състояние на Sw1 |

### Байт 4: За фискалната памет

| Бит | Описание |
|-----|----------|
| 4.7 | Резервиран – винаги е 1 |
| 4.6 | Печатащата глава е прегряла |
| 4.5 | OR на всички грешки, маркирани с '\*' от байтове 4 и 5 |
| 4.4 * | Фискалната памет е пълна |
| 4.3 | Има място за по-малко от 50 записа във ФП |
| 4.2 | Зададени са индивидуален номер на принтера и номер на фискалната памет |
| 4.1 | Зададен е ЕИК по БУЛСТАТ |
| 4.0 * | Има грешка при запис във фискалната памет |

### Байт 5: За фискалната памет

| Бит | Описание |
|-----|----------|
| 5.7 | Резервиран – винаги е 1 |
| 5.6 | Не се използува |
| 5.5 | Грешка при четене от фискалната памет |
| 5.4 | Зададени са поне веднъж данъчните ставки |
| 5.3 | Принтерът е във фискален режим |
| 5.2 * | Последният запис във фискалната памет не е успешен |
| 5.1 | Фискалната памет е форматирана |
| 5.0 * | Фискалната памет е установена в режим READONLY (заключена) |

> **Забележка:** Грешките маркирани с '#' и '\*' са критични грешки

---

## ПРЕКЪСВАНЕ НА ЗАХРАНВАНЕТО

Във всеки момент състоянието на принтера е отразено в неговите байтове на състоянието. Когато принтера се включи след като е спирало захранването, приложната програма, чрез командите **76 (4AH)** и **103 (67H)** трябва да се осведоми за състоянието на принтера.

### Поведение след прекъсване

Приложната програма трябва да вземе решение за по нататъшното поведение в зависимост от състоянието на принтера. 

**Гаранции:**
- Фискалната памет няма да се повреди от спиране на захранването
- Натрупаните суми в оперативната памет ще бъдат валидни

Ако е отпаднало захранването по време на печат, то след включването на принтера той ще отпечата един ред **"\*СПАД НАПРЕЖЕНИЕ\*"** с широки букви и ще довърши печата.

---

## ИЗДАВАНЕ НА ФИСКАЛНИ И СЛУЖЕБНИ БОНОВЕ

### А) СЛУЖЕБНИ БОНОВЕ

**Процес:**
1. Отваряне на бона
2. Отпечатване на текст
3. Затваряне на бона

**Команди:**
- **38 (26H)** - Отваряне на служебен бон
- **42 (2АH)** - Свободен текст (може да се повтаря неограничен брой пъти)
- **39 (27H)** - Затваряне на служебен бон
- **84 (54H)** - Печат на баркод (опционално)

**Специални възможности:**
- Печат на служебни бонове със завъртян на 90 градуса текст и таблици
- Команди: **122 (7AH)**, **123 (7BH)**, **124 (7CH)** и евентуално **84 (54H)** за баркодове

### Б) ФИСКАЛНИ БОНОВЕ

**Процес:**
1. Отваряне на фискален бон
2. Регистриране на продажби
3. Извършване на плащане
4. Приключване на бона

**Команди:**
- **48 (30H)** - Отваряне на фискален бон
- **49 (31H)** - Регистриране на продажба
- **51 (33H)** - Регистриране и показване на дисплея
- **52 (34H)** - Регистриране и показване на дисплея
- **53 (35H)** - Плащане
- **54 (36H)** - Печат на фискален текст
- **58 (3AH)** - Продажба на артикул
- **56 (38H)** - Приключване на бон
- **84 (54H)** - Печат на баркод (опционално)

**Дневен отчет:**

Накрая на деня се извършва дневен финансов отчет с нулиране (Z-отчет), за да се запише информацията във фискалната памет. Това става с командата **69 (45H)**.

---

## КЛЕН (КОНТРОЛНА ЛЕНТА НА ЕЛЕКТРОНЕН НОСИТЕЛ)

Принтерът запомня всеки ред от фискалните бонове, служебните бонове, документите със сервизна информация при инициализация, X- и Z-отчетите в контролната лента на електронен носител (КЛЕН).

### Характеристики

- **Обем:** минимум 2 GB
- При нормална работа би трябвало да поеме всички данни от работата на принтера до запълване на фискалната памет
- При повреда или запълване, КЛЕН може да се смени с празна
- Старата се съхранява по определения в Наредба Н-18 ред и срокове

### Възможни справки от КЛЕН

1. **Печат на копие от документ** по номер, дата и час или пореден номер за даден Z-отчет
2. **Изтегляне на документ/документи** по серийния порт в текстов вид и максимално близко до оригиналното форматиране
3. **Информация за размера** на КЛЕН и на запълнената част в байтове, номерата на първия и последния документ
4. **Проверка на валидността** на SHA-1 контролната сума за документите от цял Z-отчет
5. **Сравняване на SHA-1 контролните суми** за един или повече Z-отчети с тези, записани във фискалната памет

### Предупреждения

Два флага от статус-байтовете предупреждават за:
- **Близък край на КЛЕН** (10 MB свободни)
- **Край на КЛЕН** (1 MB свободни)

Ако е вдигнат флагът "Край на КЛЕН", следните команди са забранени:
- 38 (Отваряне на служебен бон)
- 42 (Свободен текст в служебен бон)
- 48 (Отваряне на фискален бон)
- 49 (Регистриране на продажба)
- 52 (Регистриране и показване на дисплея)
- 54 (Печат на фискален текст)
- 58 (Продажба на артикул)
- 84 (Печат на баркод)

---

## ГЕНЕРИРАНЕ НА ОТЧЕТИ

Отчетите се генерират изцяло от фискалния принтер при получаване на съответната команда от PC. При тези отчети не е възможно потребителската програма да прави каквито и да е промени във вида на отчетите.

### Налични отчети

| Команда | Описание |
|---------|----------|
| **50 (32H)** | Отчет промени на данъчните ставки и десетичните знаци |
| **69 (45H)** | Дневен финансов отчет с или без нулиране |
| **108 (6CH)** | Дневен финансов отчет с или без нулиране и с разпечатка на сумите по артикули |
| **117 (75H)** | Дневен финансов отчет с или без нулиране и с разпечатка на сумите по департаменти |
| **118 (76H)** | Дневен финансов отчет с или без нулиране и с разпечатка на артикули и департаменти |
| **79 (4FH) / 95 (5FH)** | Съкратен отчет на фискалната памет от дата до дата / от номер до номер на фискален блок |

---

## ПРОТОКОЛ НА НИСКО НИВО

### А) ТИП НА ПРОТОКОЛА - Master (Host) / Slave

Фискалният принтер изпълнява командите изпратени му от Host и връща съобщение, зависещо от резултата.

**Основни характеристики:**
- Фискалният принтер **не може да инициира** комуникация
- Само съобщения, които са резултати от изпълнението на получени команди се изпращат до Host
- Съобщенията в протокола са или пакетирани съобщения или единични байтове

**Комуникация:**
- RS232 при скорости: 1200, 2400, 4800, 9600, 19200, 38400, 57600 и 115200 b/s, 8N1
- Скоростта се задава от конфигурационни битове 5, 6 и 7
- Поддържа се и LAN връзка (параметри се задават с команда 36/24H)

### Б) ПОСЛЕДОВАТЕЛНОСТ НА СЪОБЩЕНИЯТА

1. Host изпраща пакетирано съобщение, съдържащо командата към принтера
2. ФП извършва исканата операция и отговаря с пакетирано съобщение отговор
3. Host трябва да чака отговора от принтера преди да изпрати друго съобщение

Протоколът използва непакетирани кодове с дължина един байт, за обработката на необходими паузи и грешни състояния.

### В) НЕПАКЕТИРАНИ СЪОБЩЕНИЯ, TIME-OUT

При нормална работа на всички съобщения от Host, Slave отговаря не по-късно от **60 ms** или с пакетирано съобщение или с еднобайтов код. Host трябва да има **500 ms time-out** за получаване на отговор от Slave.

Ако за това време не се получи никакъв отговор, той трябва да предаде съобщението отново със същия пореден номер и същата команда. При няколко неуспешни опита, Host трябва да индицира, че няма връзка с фискалния принтер или има хардуерна грешка.

#### Непакетирани съобщения:

**а) NAK 15H**
- Изпраща се от Slave когато открие грешка в контролната сума или формата на полученото съобщение
- Когато Host получи NAK, той трябва да предаде отново съобщение със същия пореден номер

**б) SYN 16H**
- Изпраща се от Slave, когато получи команда, за която е необходимо по-дълго време за изпълнение
- SYN се изпраща на всеки 60 ms, докато не е готово пакетираното съобщение за отговор

### Г) ПАКЕТИРАНИ СЪОБЩЕНИЯ

#### а) Host към принтер (Send):
```
<01><LEN><SEQ><CMD><DATA><05><BCC><03>
```

#### б) Принтер към Host (Receive):
```
<01><LEN><SEQ><CMD><DATA><04><STATUS><05><BCC><03>
```

#### Структура на полетата:

| Поле | Описание | Дължина | Стойност |
|------|----------|---------|----------|
| **&lt;01&gt;** | Preamble | 1 байт | 01H |
| **&lt;LEN&gt;** | Брой байтове от &lt;01&gt; (без него) до &lt;05&gt; (вкл.) плюс фиксирано отместване от 20H | 1 байт | 20H - FFH |
| **&lt;SEQ&gt;** | Пореден номер на рамката | 1 байт | 20H - 7FH |
| **&lt;CMD&gt;** | Код на командата | 1 байт | 20H - FFH |
| **&lt;DATA&gt;** | Данни | 0-213 байта (Host→принтер)<br>0-218 байта (принтер→Host) | 20H-FFH и допълнително 09H и 0AH |
| **&lt;04&gt;** | Разделител (само за принтер към Host) | 1 байт | 04H |
| **&lt;STATUS&gt;** | Текущо състояние на фискалното устройство | 6 байта | 80H - FFH |
| **&lt;05&gt;** | Postamble | 1 байт | 05H |
| **&lt;BCC&gt;** | Контролна сума | 4 байта | 30H - 3FH |
| **&lt;03&gt;** | Terminator | 1 байт | 03H |

**Забележки за полетата:**

- **&lt;SEQ&gt;**: Фискалният принтер записва същия &lt;SEQ&gt; в съобщението отговор. Ако ФП получи съобщение със същото &lt;SEQ&gt;, като последното получено от него съобщение, то той не извършва действие, а повтаря последното изпратено от него съобщение.

- **&lt;CMD&gt;**: ФП записва същия &lt;CMD&gt; в съобщението отговор. Ако принтерът получи несъществуващ код, той отговаря с пакетирано съобщение с нулева дължина на полето за данни и установява съответния статус бит.

- **&lt;DATA&gt;**: Форматът и дължината на областта за данни зависи от командата. Ако командата няма данни то дължината на това поле е нула. Ако има синтактична грешка в данните се установява съответния статус бит и се връща пакетирано съобщение с нулева дължина на полето за данни.

- **&lt;BCC&gt;**: Сумата включва от &lt;01&gt; без него до &lt;05&gt; вкл. Всяка цифра от двата байта се предава като и се прибави 30H. Например сумата 1AE3H се представя като 31H, 3AH, 3EH, 33H.

---

## КОМПОЗИРАНЕ НА СЪОБЩЕНИЯ, СИНТАКСИС И ИЗПОЛЗВАНИ ОЗНАЧЕНИЯ

### Основни правила:

а) Областта за данни е зависима от командата.

б) Параметрите изпратени до принтера могат да бъдат разделени със запетая и/или да бъдат с фиксирана дължина.

в) Наличието на запетая между параметрите показва, че тя е задължителна.

г) Синтаксисът на командата трябва да се спазва **БУКВАЛНО** – дори добавянето на интервал или табулация между данните или в края им се счита за грешка!

### Нотация:

- **&lt; &gt;** - Задължителни параметри (скобите не се съдържат в съобщението)
- **[ ]** - Незадължителни параметри (скобите също не се предават)

### Специални символи:

Символите с ASCII кодове под 32 (20H) имат специално значение и употребата им е явно посочена в описанието там, където е необходимо. Ако по някакви причини трябва да изпратим такъв символ (например в ESCAPE-команда към дисплея), то той трябва да се предшества от 16 (10H) и да му се добави отместване 40H.

**Пример:** 
Когато за областта за данни пишем `2500,100,Text`, то в областта за данни има:
```
2D 32 35 30 30 2C 31 30 30 2C 54 65 78 74
```
където всяко шестнайсетично число представлява ASCII стойност.

---

## СПИСЪК НА КОМАНДИТЕ - ПО ПРЕДНАЗНАЧЕНИЕ

### ИНИЦИАЛИЗАЦИЯ

| Код | Dec | Команда |
|-----|-----|---------|
| 29H | (41) | Запомняне на настройките и графичното лого и ключетата в енергонезависимата памет |
| 2BH | (43) | Установяване на HEADER и FOOTER и опции на печат |
| 3DH | (61) | Установяване на дата и час |
| 42H | (66) | Задаване на допустим интервал на номерата на фактурите |
| 48H | (72) | Фискализация |
| 53H | (83) | Установяване на множител, десетични знаци, име на валута и данъчни ставки |
| 55H | (85) | Програмиране на допълнителните типове плащане |
| 57H | (87) | Задаване име на департамент |
| 5BH | (91) | Програмиране на индивидуален номер на принтера, номера на ФП и номера на страната |
| 62H | (98) | Установяване на ЕИК |
| 65H | (101) | Задаване на парола на оператор |
| 66H | (102) | Задаване на име на оператор |
| 6BH | (107) | Дефиниране и отчитане на артикули |
| 73H | (115) | Зареждане на графично лого |

### ПРОДАЖБИ

| Код | Dec | Команда |
|-----|-----|---------|
| 28H | (46) | Печат на сторно бон |
| 30H | (48) | Отваряне на фискален бон |
| 31H | (49) | Регистриране на продажба |
| 33H | (51) | Междинна сума |
| 34H | (52) | Регистриране на продажба и показване на дисплея |
| 35H | (53) | Изчисляване на сбор (Плащане) |
| 36H | (54) | Печатане на свободен текст във фискален бон |
| 38H | (56) | Затваряне на фискален бон |
| 39H | (57) | Печат на информация за клиента |
| 3AH | (58) | Регистриране продажба на програмиран артикул |
| 3CH | (60) | Прекратяване (анулиране) на фискален бон |
| 54H | (84) | Печат на баркод |
| 6DH | (109) | Печат на дублиращ бон |

### ПРИКЛЮЧВАНЕ НА ДЕНЯ

| Код | Dec | Команда |
|-----|-----|---------|
| 45H | (69) | Дневен финансов отчет (с или без нулиране) |
| 6CH | (108) | Разширен дневен финансов отчет (с разпечатка на артикулите) |
| 75H | (117) | Разширен дневен финансов отчет (с разпечатка на департаментите) |
| 76H | (118) | Разширен дневен финансов отчет (с разпечатка на департаментите и артикулите) |

### ОТЧЕТИ

| Код | Dec | Команда |
|-----|-----|---------|
| 22H | (34) | Отчет на регистрираните сервизни договори |
| 32H | (50) | Отчет на промените в данъчни ставки и десетичните знаци през съответния период |
| 49H | (73) | Детайлен отчет на фискалната памет (от номер до номер) |
| 4FH | (79) | Съкратен отчет на фискалната памет (от дата до дата) |
| 5EH | (94) | Детайлен отчет на фискалната памет (от дата до дата) |
| 5FH | (95) | Съкратен отчет на фискалната памет (от номер до номер) |
| 69H | (105) | Отчет оператори |
| 6FH | (111) | Отчет по артикули |

### ИНФОРМАЦИЯ КЪМ HOST

| Код | Dec | Команда |
|-----|-----|---------|
| 22H | (34) | Информация за последния сервизен договор |
| 25H | (37) | Четене на данните за НАП |
| 3EH | (62) | Прочита датата и часа |
| 40H | (64) | Информация за последния фискален запис |
| 41H | (65) | Информация за сумите за деня |
| 44H | (68) | Брой на свободните записи във фискалната памет |
| 4AH | (74) | Получаване на статус-байтовете |
| 4CH | (76) | Статус на фискалната транзакция |
| 56H | (86) | Дата на последен запис във фискалната памет |
| 58H | (88) | Информация за натрупаните суми в департамент |
| 5AH | (90) | Получаване на диагностична информация |
| 61H | (97) | Получаване на данъчните ставки |
| 63H | (99) | Получаване на ЕИК |
| 67H | (103) | Информация за текущия бон |
| 6EH | (110) | Получаване на информация за суми по типове плащане |
| 70H | (112) | Получаване на информация за оператор |
| 71H | (113) | Получаване номера на последния отпечатан документ |
| 72H | (114) | Получаване информация за фискален запис или зададен период |
| 74H | (116) | Четене на блок фискална памет |

### ПРИНТЕРСКИ КОМАНДИ

| Код | Dec | Команда |
|-----|-----|---------|
| 2CH | (44) | Придвижване на хартията |
| 2DH | (45) | Отрязване на хартията |

### ДИСПЛЕЙ

| Код | Dec | Команда |
|-----|-----|---------|
| 21H | (33) | Изчистване на дисплея |
| 23H | (35) | Показване на текст (долен ред) |
| 2FH | (47) | Показване на текст (горен ред) |
| 3FH | (63) | Показване на датата и часа |
| 64H | (100) | Дисплей - пълен контрол |

### ДРУГИ

| Код | Dec | Команда |
|-----|-----|---------|
| 20H | (32) | Разширена информация за последната грешка |
| 26H | (38) | Отваряне на служебен бон |
| 27H | (39) | Затваряне на служебен бон |
| 2AH | (42) | Печатане на свободен текст в служебен бон |
| 46H | (70) | Служебно въвеждане и извеждане на пари |
| 47H | (71) | Печат на диагностична информация |
| 50H | (80) | Издаване на звуков сигнал |
| 59H | (89) | Програмиране на производствената тестова област |
| 5AH | (92) | Печат на разделителна линия |
| 6AH | (106) | Отваряне на чекмедже |
| 67H | (119) | Поддръжка на КЛЕН – четене, печат и информация |
| 7AH | (122) | Отваряне на завъртян служебен бон |
| 7BH | (123) | Печат на информация в завъртян служебен бон |
| 7CH | (124) | Затваряне на завъртян служебен бон |

### СЕРВИЗНИ КОМАНДИ

| Код | Dec | Команда |
|-----|-----|---------|
| 79H | (121) | Четене на блок от кодовата памет (фирмуера) |
| 80H | (128) | Сервизен софтуерен RAM ресет |
| 85H | (133) | Временна забрана на печата за тестови цели |
| 86H | (134) | Сервизна поддръжка на КЛЕН |
| 87H | (135) | Тест на GPRS модема |
| 90H | (144) | Инициализация и четене на данни от данъчния терминал |

---

## ПОДРОБНО ОПИСАНИЕ НА КОМАНДИТЕ

> **Забележка:** Всички примери предполагат работа с фискален принтер, конфигуриран за България. Там, където има особености в зависимост от държавата, е направено уточнение.

### 20h (32) - РАЗШИРЕНА ИНФОРМАЦИЯ ЗА ПОСЛЕДНАТА ГРЕШКА

**Област за данни:** `[<Clear>]`  
**Отговор:** `<Command>,<ErrCode>,<DateTime>`

Командата дава възможност да се получи информация за последната команда, завършила със грешка. Тази информация се запазва при успешно изпълнени команди, както и при изключване на принтера. Изчиства се само при RAM ресет и при изпълнение на командата с входни данни – текст „CLEAR". Списък с кодовете на грешките е приложен в края на документацията. Командата връща резултат при произволни входни данни.

| Параметър | Описание |
|-----------|----------|
| **Clear** | Фиксиран текст със съдържание „CLEAR" |
| **ErrCode** | Число – код на грешка |
| **DateTime** | Дата и час на грешката във формат DD-MM-YY hh:mm:ss |

### 21h (33) - ИЗЧИСТВАНЕ НА ДИСПЛЕЯ

**Област за данни:** Няма данни  
**Отговор:** Няма данни

Изпраща се команда за изчистване на дисплея. Ако е отворен фискален бон и Sw4 e OFF, изчиства се само долния ред.

### 22h (34) - ИНФОРМАЦИЯ И ОТЧЕТ НА СЕРВИЗНИТЕ ДОГОВОРИ

**Област за данни:** `[<"P">]`  
**Отговор:** `<Left>,<RegDtTm>,<EIK>,<EndDate>` или `„F"`

| Параметър | Описание |
|-----------|----------|
| **Date** | Дата на изтичане на новия сервизен договор във формат „DD-MM-YY" |
| **Left** | Цяло число – брой оставащи полета за регистрация на сервизен договор |
| **RegDtTm** | Дата и час на регистрация на сервизен договор: „DD-MM-YYYY hh:mm:ss" |
| **EndDate** | Дата на изтичане на последния сервизен договор във формат "DD-MM-YYYY" |
| **ЕИК** | 9 или 13 цифри – ЕИК на сервизната фирма |

Командата връща или разпечатва информация за сервизните договори. Срокът на изтичане на текущия сервизен договор се печати в края на всеки дневен отчет с нулиране. Връщат се данни за срока на последния регистриран договор (или „F" ако няма регистриран договор). При входни данни „P" се печата отчет на всички регистрирани договори по данни от фискалната памет.

### 23h (35) - ПОКАЗВАНЕ НА ТЕКСТ НА ДОЛНИЯ РЕД НА ДИСПЛЕЯ

**Област за данни:** `<Text>`  
**Отговор:** Няма данни

| Параметър | Описание |
|-----------|----------|
| **Text** | Текст до 20 символа, който се изпраща директно към дисплея. Преди него се изпраща команда за позициониране и изчистване на долния ред |

### 24H (36) - ЗАДАВАНЕ НАСТРОЙКИ НА LAN

**Област за данни:** `[<IPAddr>,<SubnetMask>,<TCPPort>,<DefGateway>[,<MACAddr>]]`  
**Отговор:** `[<IPAddr>,<SubnetMask>,<TCPPort>,<DefGateway>,<MACAddr>]`

| Параметър | Описание |
|-----------|----------|
| **IPAddr** | 4 числа от 0 до 255 разделени със точка, представляващи IP адреса на устройството |
| **SubnetMask** | 4 числа от 0 до 255 разделени със точка, представляващи Subnet маската на устройството |
| **TCPPort** | Число от 1 до 65535 представляващо IP порта на устройството |
| **DefGateway** | 4 числа от 0 до 255 разделени със точка, представляващи Default Gateway адреса на устройството |
| **MACAddr** | До 12 шестнайсетични символа представляващи MAC адреса на устройството. **Работи само при наличие на сервизен джъмпер!!!** |

Ако няма област за данни, командата връща текущите настройки.

### 25h (37) - ЧЕТЕНЕ НА ДАННИ ЗА НАП

**Област за данни:** `<Type>[,<Closure>]`  
**Отговор:** `P,<Data>` или `F`

#### Типове информация (Type):

| Type | Върнати данни |
|------|---------------|
| '1' | DT,Closure,FiscRec,LastFiscal,LastDoc,Journal |
| '2' | S1,S2,S3,S4,S5,S6,S7,S8,Total,GTotal |
| '3' | DiscountN,DiscountS,MarkUpN,MarkUpS,VoidN,VoidS,CancelN,CancelS |
| '4' | CashInN,CashInS,CashOutN,CashOutS,CashSum |
| '5' | CashPaid,CredPaid,CardPaid,CheckPaid,Payd1,Paid2,Paid3,Paid4 |
| '6' | DT |
| '7' | DT |
| '8' | P&lt;PLU&gt;,&lt;PluTotal&gt;,&lt;PluName&gt; |

#### Параметри:

| Параметър | Описание |
|-----------|----------|
| **DT** | Стринг. Дата и час във формат „DD-MM-YYYY hh:mm:ss" |
| **Closure** | Цяло число. Предстоящ номер на дневен отчет |
| **FiscRec** | Цяло число. Брой фискални бонове (клиенти) за деня |
| **LastFiscal** | Цяло число. Глобален номер на последния издаден фискален бон |
| **LastDoc** | Цяло число. Глобален номер на последния издаден документ |
| **Journal** | Цяло число. Текущ номер на контролна лента |
| **Sx** | Число с десетична точка. Оборот по някоя от данъчните групи за деня |
| **Total** | Число с десетична точка. Общ оборот за деня |
| **GTotal** | Число с десетична точка. Общ оборот за периода на експлоатация |
| **DiscountN** | Цяло число. Брой отстъпки за деня |
| **DiscountS** | Число с десетична точка. Обща сума от отстъпки за деня |
| **MarkUpN** | Цяло число. Брой надбавки за деня |
| **MarkUpS** | Число с десетична точка. Обща сума от надбавки за деня |
| **VoidN** | Цяло число. Брой корекции за деня |
| **VoidS** | Число с десетична точка. Обща сума от корекции за деня |
| **CancelN** | Цяло число. Брой отказани бонове за деня |
| **CancelS** | Число с десетична точка. Обща сума от отказани бонове за деня |
| **CashInN** | Цяло число. Брой операции служебен внос за деня |
| **CashInS** | Число с десетична точка. Обща сума от служебен внос за деня |
| **CashOutN** | Цяло число. Брой операции служебен износ за деня |
| **CashOutS** | Число с десетична точка. Обща сума от служебен износ за деня |
| **CashSum** | Число с десетична точка. Касова наличност |
| **CashPaid** | Число с десетична точка. Платени в брой |
| **CredPaid** | Число с десетична точка. Платени с кредитна карта |
| **CardPaid** | Число с десетична точка. Платени с дебитна карта |
| **CheckPaid** | Число с десетична точка. Платени с чек |
| **Paid1** | Число с десетична точка. Платени с програмируем тип плащане 1 |
| **Paid2** | Число с десетична точка. Платени с програмируем тип плащане 2 |
| **Paid3** | Число с десетична точка. Платени с програмируем тип плащане 3 |
| **Paid4** | Число с десетична точка. Платени с програмируем тип плащане 4 |
| **PLU** | Логически номер на артикул. 9 цифри |
| **PluTotal** | Натрупана сума от продажби за артикула. Число с десетична точка |
| **PluName** | Име на артикула. До 36 символа |

**Специални подкоманди:**

- **Подкоманда '6'**: Очаква номер на дневен отчет и връща датата и часа на дневния отчет. Ако записът е с невалидна контролна сума, връща се 'F'. Ако няма такъв запис, връща се 'E'.

- **Подкоманда '7'**: Връща дата на фискализация, или 'F', ако принтерът не е въведен в експлоатация.

- **Подкоманда '8'**: Връща данни за продажбите по артикули по нарастващ PLU. Командата се изпраща отначало еднократно с команден стринг „8,F", а след това необходимия брой пъти с команден стринг „8,N" докато принтерът не върне отговор 'F' (няма данни) или сме прочели необходимия брой артикули. Името на артикула се връща винаги в кодова таблица 1251.

> **Забележка:** Командата е само за съвместимост с фискалните принтери с външен терминал, при които има възможност за четене на тези данни. Реално тя не е необходима, защото информацията може да се получи и по друг начин. Данни, идентични на получените от тази команда се, изпращат вътрешно и автоматично на данъчния терминал за предаване в НАП при необходимост.

### 26h (38) - ОТВАРЯНЕ НА СЛУЖЕБЕН БОН

**Област за данни:** Няма данни  
**Отговор:** `Allreceipt`

| Параметър | Описание |
|-----------|----------|
| **Allreceipt** | Броят на всички издадени бонове (фискални и служебни) от последното приключване на деня до момента /4 байта/ |

**ФП извършва следните действия:**
- Отпечатва се HEADER
- Отпечатва се ЕИК на продавача
- Връща се отговор, съдържащ Allreceipt

**Командата не може да се изпълни, ако:**
- Фискалната памет не е форматирана
- Има отворен фискален бон
- Вече е отворен служебен бон
- Часовникът не е сверен

### 27h (39) - ЗАТВАРЯНЕ НА СЛУЖЕБЕН БОН

**Област за данни:** Няма данни  
**Отговор:** `Allreceipt`

| Параметър | Описание |
|-----------|----------|
| **Allreceipt** | Броят на всички издадени бонове (фискални и служебни) от последното приключване на деня до момента /4 байта/ |

**ФП извършва следните действия:**
- Отпечатва се FOOTER
- Отпечатва се поредния номер, датата и часа на документа
- Отпечатва се с широк печат **"СЛУЖЕБЕН БОН"**
- Връща се отговор, съдържащ Allreceipt

> Ако е вдигнат S1.1 командата не е изпълнена защото в момента не е отворен служебен бон.

### 29H (41) - ЗАПОМНЯНЕ НА НАСТРОЙКИТЕ И КЛЮЧЕТАТА ВЪВ FLASH-ПАМЕТТА

**Data field:** `[<Switches>]`  
**Response:** Няма данни

| Параметър | Описание |
|-----------|----------|
| **Switches** | 8 или 16 байта със стойност '0' или '1' – конфигурационните "ключета" |

Принтерът няма хардуерни ключета и използува за целта област във флаш-паметта. Установяването им става с тази команда. Освен това командата записва във флаш-паметта и графичното лого, височината на баркода, плътността на печат и дължината на импулса за отваряне на чекмедже. След RAM ресет стойностите им се възстановяват от тези във флаша. Ако са подадени само 8 байта, старшите 8 остават без промяна.

Ако командата няма данни, то се запазват старите стойности на "ключетата" и се записват останалите данни.

**Командата запомня следните данни в енергонезависимата (flash) памет:**
- Header и footer (от команда 43)
- Текстът на допълнителните типове плащане (от команда 85)
- Графичното лого (от команда 115)
- Опциите за печат (от команда 43)
- Конфигурационните ключета

След RAM ресет стойностите им се възстановяват от тези във флаша.

### 2Ah (42) - ПЕЧАТАНЕ НА СВОБОДЕН ТЕКСТ В СЛУЖЕБЕН БОН

**Област за данни:** `[<Tab><Font>[<Flags>],]<Text>`  
**Отговор:** Няма данни

| Параметър | Описание |
|-----------|----------|
| **Text** | Свободен текст за печат. В началото и края на реда се отпечатва символът '#'. Текстът може да бъде с произволна дължина, но се оставят само толкова символа, колкото се побират на реда (без вдигане на грешка при изрязването) |

**Командата допуска опционално посочване на шрифт и атрибути за печат на реда:**

| Font | Описание |
|------|----------|
| 0 | 32 точки (4 mm) височина, по-високи букви |
| 1 | 32 точки (4 mm) височина, нормални букви |
| 2 | 24 точки (3 mm) височина |
| 3 | 16 точки (2 mm) височина |

| Flags | Описание |
|-------|----------|
| **B** | Bold (Удебелено) |
| **H** | High (Двойна височина) |
| **I** | Italic (Наклонено) |

От една до 3 букви: 'B', 'H' или 'I'. Всяка може да се появи най-много веднъж.

### 2Bh (43) - УСТАНОВЯВАНЕ НА HEADER И FOOTER И ОПЦИИ ЗА ПЕЧАТ

**Област за данни:** `<Item><Text>`  
**Отговор:** Зависи от областта за данни

**HEADER** се състои от 6 реда текст, които се отпечатват в началото на всеки фискален или служебен бон. За нормална работа на принтера е необходимо да се зададат поне 2 реда Header. ЕИК (зададен от команда 98) се печати винаги на трети ред, така че редовете от HEADER-а след втория автоматично се преместват с една позиция надолу.

**FOOTER** се състои от 2 линии текст, които се отпечатват в края на всеки бон.

HEADER и FOOTER се центрират автоматично.

Тази команда трябва да се изпълни до 8 пъти, за да се зададат всичките линии на HEADER и FOOTER.

#### Item параметър:

| Item | Описание |
|------|----------|
| **'0'-'7'** | Номера на линията, която се задава. Линиите на HEADER са с номера от 0 до 5, а тези на FOOTER – 6 и 7 |
| **'A'** | Автоматично форматиране на продажбите като за фактура (4 отделни реда) |
| **'B'** | Задава височината на баркода в пиксели (0.125 mm). Възможни стойности от 24 (3 mm) до 240 (30 mm). Баркодът се печати с команда 84 (54H) |
| **'C'** | Разрешаване / забраняване на автоматичното отрязване на хартията след всеки документ. След включване на принтера поведението се определя от ключе Sw8 |
| **'D'** | Задава плътност на печат. Възможни стойности: '1': Много блед, '2': Блед, '3': Нормален, '4': Плътен, '5': Много плътен |
| **'E'** | Разрешаване / забраняване на печата на общата сума в EUR при първата команда за плащане (53). Синтаксис: `<Enable>[,Rate]` |
| **'F'** | Задаване на шрифта за печат на принтера (0, 1 или 2) |
| **'L'** | Разрешаване / забраняване печата на графичното лого непосредствено преди HEADER-а. Формат: `<Enable>,<H>` |
| **'N'** | Разрешаване / забраняване на отпечатването на името на департамента в началото на всеки фискален бон |
| **'Q'** | Разрешаване / забраняване на подтискането на печата във фискален или служебен бон. Формат: `Q0` или `Q1,<Lines>,<Seconds>` |
| **'R'** | Задава допълнителното разстояние в пиксели (0.125 mm) между буквите в завъртян на 90 градуса служебен бон. Възможни стойности от 0 до 4 |
| **'SIM'** | Избира коя от SIM-картите да използва GPRS модемът. Допустима стойност 0 или 1 |
| **'T'** | Разрешаване / забраняване на отпечатването на натрупания ДДС за бона в нормален (не разширен) фискален бон |
| **'X'** | Разрешаване / забраняване на автоматичното генерирането на импулс за отваряне на чекмедже при команди 53 (35H) и 70 (46H) |
| **'W'** | Задава времето на което да сработи предупреждението за не предадени данни за платежни документи |
| **'c'** | Забраняване / разрешаване на функциите на бутона FEED ('1'- забранява, '0' – разрешава) |
| **'d'** | Забраняване / разрешаване връщането на опционален текст в отговора на командата при настъпила грешка |
| **'I'** | Дава възможност да прочетем стойностите, зададени по-рано с команда 43. След буквата 'I' следва точно още един символ, съвпадащ с някой от по-горните |

### 2Ch (44) - ПРИДВИЖВАНЕ НА ХАРТИЯТА

**Област за данни:** `Lines`  
**Отговор:** Няма данни

| Параметър | Описание |
|-----------|----------|
| **Lines** | Броят на редовете, с които да бъде придвижена хартията. Трябва да бъде положително число не по-голямо от 99 /1 или 2 байта/. Ако параметър липсва, подразбира се 1 ред |

### 2Dh (45) - ОТРЯЗВАНЕ НА ХАРТИЯТА

**Област за данни:** Няма данни  
**Отговор:** Няма данни

Предизвиква отрязването на хартията. Трябва да се има предвид, че програмата трябва да се погрижи за придвижването на хартията поне с два реда, иначе е възможно отрязване на края на бона. Ако принтерът е в режим "автоматично рязане", той сам позиционира коректно хартията преди рязането, а командата е излишна.

При блокиране на режещия механизъм трябва да се извади хартията (ако има такава) от резачката, и да се изключи и включи принтера – резачката ще се позиционира в изходно положение.

### 2E (46) - ИЗДАВАНЕ НА СТОРНО БОН

**Област за данни:** `<OpNum>,<Password>,<TillNum>[,<Invoice><InvNum>][,<UNP>],<StType><DocNo>[,<StUNP>,<StDT>,<StFMIN>][#<StornoReason>]`  
**Отговор:** `Allreceipt, StornoReceipt`

| Параметър | Описание |
|-----------|----------|
| **OpCode** | Номер на оператор /1 до 16/ |
| **OpPwd** | Операторска парола /4 до 8 цифри/ |
| **TillNmb** | Номер на касово място /цяло число от 1 до 99999/ |
| **UNP** | Уникален номер на продажбата (формат: сериен номер на ФУ"-"четири цифри или латински букви"-"пореден номер на продажбата) |
| **InvNum** | Номер на фактурата която се сторнира |
| **Invoice** | Един символ със стойност "I". Наличието му предизвиква отпечатването на сторно разширена клиентска бележка (кредитно известие) |
| **StType** | Причина за сторниране: **E** – операторска грешка, **R** – връщане/рекламация, **T** – намаление на данъчната основа |
| **DocNo** | Номер на документа (глобален), който се сторнира |
| **StUNP** | УНП на документа, който се сторнира. Задава се цялото УНП задължително |
| **StDT** | Дата и час на сторнирания документ. Формат „DDMMYYhhmmss" |
| **StFMIN** | Номер на фискалната памет на ФУ от което е издаден бона, който се сторнира |
| **StornoReason** | Причина за сторниране (до 30 символа) |
| **Allreceipt** | Броят на всички издадени бонове (фискални и служебни) от последното приключване на деня до момента /4 байта/ |
| **StornoReceipt** | Броят на всички издадени фискални СТОРНО бонове от последното приключване на деня до момента /4 байта/ |

> Ако последния аргумент е StornoReceipt и няма следващи аргументи, ФУ търси издадения бон в контролната си лента. Ако не го намери, командата приключва неуспешно. Ако го намери, данните се попълват автоматично и се издава сторно бон с всички присъстващи в оригиналния фискален бон данни.

> Ако се подадат StUNP, StDT, StFMIN командата ще бъде приета само като отваряне на сторно бон в който трябва да се направят продажби, плащания и затваряне (по аналогия с команда 48).

### 2F (47) - ПОКАЗВАНЕ НА ТЕКСТ НА ГОРНИЯ РЕД НА ДИСПЛЕЯ

**Област за данни:** `Text`  
**Отговор:** Няма данни

| Параметър | Описание |
|-----------|----------|
| **Text** | Текст до 20 символа, който се изпраща директно към дисплея. Преди него се изпраща команда за позициониране и изчистване на горния ред. Командата се отхвърля, ако е отворен фискален бон и Sw1 е OFF |

### 30h (48) - ОТВАРЯНЕ НА ФИСКАЛЕН (КЛИЕНТСКИ) БОН

**Област за данни:** Няма или `<OpNum>,<Password>,<TillNum>[,<Invoice>][,<UNP>]`  
**Отговор:** `Allreceipt, FiscReceipt`

| Параметър | Описание |
|-----------|----------|
| **OpCode** | Номер на оператор /1 до 16/ |
| **OpPwd** | Операторска парола /4 до 8 цифри/ |
| **TillNmb** | Номер на касово място /цяло число от 1 до 99999/ |
| **UNP** | Уникален номер на продажбата (формат: сериен номер на ФУ"-"четири цифри или латински букви"-"пореден номер на продажбата). При първо отваряне УНП трябва да бъде зададен поне веднъж, ако след това се пропуска, ФУ ще инкрементва с единица номера на продажбата автоматично |
| **Invoice** | Един символ със стойност "I". Наличието му предизвиква отпечатването на разширена клиентска бележка (фактура) |
| **Allreceipt** | Броят на всички издадени бонове (фискални и служебни) от последното приключване на деня до момента /4 байта/ |
| **FiscReceipt** | Броят на всички издадени фискални бонове от последното приключване на деня до момента /4 байта/ |

Ако командата е подадена без аргументи, се връща пореден номер на продажбата от УНП на последния издаден фискален/сторно бон.

**ФП извършва следните действия:**
- Отпечатва се HEADER
- Отпечатва се ЕИК
- Отпечатва се номер и име на оператор и номер на касово място
- Връщат се AllReceipt и FiscReceipt

**Командата няма да бъде изпълнена успешно, ако:**
- Има отворен фискален или служебен бон
- Фискалната памет е пълна или повредена
- Липсва код или парола на оператор, или номер на касово място
- HEADER съдържа по-малко от 2 реда
- Не е зададен ЕИК
- Не е вярна операторската парола
- Часовникът не е сверен
- КЛЕН е пълна или не функционира
- Данъчният терминал не функционира

При три грешни операторски пароли принтерът блокира и трябва да се изключи и включи за продължаване на работата.

### 31h (49) - РЕГИСТРИРАНЕ (ПРОДАЖБА) НА СТОКА

**Област за данни:**  
`[<L1>][<Lf><L2>]<Tab><TaxCd><[Sign]Price>[*<Qwan>[#UN]][,Perc|;Abs]`  
или  
`[<L1>][<Lf><L2>]<Tab><Dept><Tab><[Sign]Price>[*<Qwan>[#UN]][,Perc|;Abs]`

**Отговор:** Няма данни

| Параметър | Описание |
|-----------|----------|
| **L1** | Текст до 42 байта съдържащ ред, описващ продажбата |
| **Lf** | Един байт със съдържание 0Ah |
| **L2** | Текст до 42 байта съдържащ втори ред, описващ продажбата |
| **Tab** | Един байт със съдържание 09h |
| **TaxCd** | Един байт съдържащ буквата показваща видът на данъка ('А', 'Б', 'В', ...). Има ограничение зависещо от параметъра Enabled_Taxes |
| **Dept** | Номер на департамент. Цяло число от 1 до 60 включително |
| **Sign** | Един байт със стойност '-' |
| **Price** | Единичната цена - до 8 значещи цифри |
| **Qwan** | Незадължителен параметър, задаващ количеството на стоката. По подразбиране е 1.000. Дължина до 8 значещи цифри (не повече от 3 след десетичната точка) |
| **UN** | Име на мерна единица. Опционален текст за мерна единица на количеството до 8 символа, например "kg" |
| **Perc** | Незадължителен параметър, показващ стойността на надбавката или отстъпката (в зависимост от знака) в проценти върху текущата продажба. Допустими стойности от -99.00 % до 99.00 % |
| **Abs** | Незадължителен параметър, показващ стойността на надбавката или отстъпката (в зависимост от знака) като сума. Не е допустима отстъпка със стойност по-голяма от стойността на продажбата |

Допустим е само един от аргументите Perc или Abs.

**ФП извършва следните действия:**
- Ако продажбата е по департамент и е разрешено с команда 43, подкоманда 'N', отпечатва се името на департамента
- Текстът описващ продажбата се отпечатва заедно с цената и кода на данъчната група
- Цената на стоката се прибавя към натрупаните суми в регистрите в оперативната памет
- Ако има отстъпка или надбавка, тя се отпечатва на отделен ред
- Ако е указан департамент, натрупаната стойност се прибавя към него

**Командата няма да бъде изпълнена успешно, ако:**
- Не е отворен фискален бон
- Вече са направени максималния брой продажби за един бон (512)
- Командата (35h) е изпълнена успешно
- Сумата по някоя от данъчните групи става отрицателна
- КЛЕН е пълна
- Принтерът е установил различна от регистрираната SIM карта в модема

### 32h (50) - ДАНЪЧНИ СТАВКИ ЗАДАВАНИ ПРЕЗ СЪОТВЕТНИЯ ПЕРИОД

**Област за данни:** `[<Start>,<End>]`  
**Отговор:** `F` – ако не са намерени данъчни ставки за периода или `P,AA,BB,CC,DD,EE,FF,GG,HH,DDMMYY`

| Параметър | Описание |
|-----------|----------|
| **Start** | Дата за начало на периода – DDMMYY /6 bytes/ |
| **End** | Дата за край на периода – DDMMYY /6 bytes/ |

Ако има групи, които не се използват (забранени с Enabled_rates), то за тях вместо ставка в проценти се връща 'DT' (Disabled Tax).

Командата разпечатва отчет на промените на десетичните знаци и данъчните ставки за посочения период. Ако не са посочени начална и крайна дата, използва се периодът от фискализацията до текущия момент.

### 33h (51) - МЕЖДИННА СУМА

**Област за данни:** `<Print><Display>[,Perc|;Abs]`  
**Отговор:** `SubTotal,TaxA,TaxB,TaxC,TaxD,TaxE,TaxF,TaxG,TaxH`

| Параметър | Описание |
|-----------|----------|
| **Print** | Един байт, който ако е '1' стойността на под сумата ще се отпечата |
| **Display** | Един байт, който ако е '1' стойността на под сумата ще се покаже на дисплея |
| **Perc** | Незадължителен параметър, който показва стойността в проценти на отстъпката или надбавката върху натрупаната до момента сума |
| **Abs** | Незадължителен параметър, показващ стойността на надбавката или отстъпката (в зависимост от знака) като сума (до 8 значещи цифри) |
| **SubTotal** | Сумата до момента за текущия фискален бон /до 10 байта/ |
| **TaxA-TaxH** | Сумата по данъчна група А-З /до 10 байта/ |

### 34h (52) - РЕГИСТРИРАНЕ И ПОКАЗВАНЕ НА ДИСПЛЕЯ

**Област за данни:**  
`[Line]]<Tab><TaxCd><[Sign]Price>[*Qwan[#UN]][,Perc|;Abs]`  
или  
`[Line]]<Tab><Dept><Tab><[Sign]Price>[*Qwan[#UN]][,Perc\;Abs]`

**Отговор:** Няма данни

| Параметър | Описание |
|-----------|----------|
| **Line** | Стринг до 20 байта съдържащ ред с текст описващ продажбата |
| **Tab** | Един байт със съдържание 09h |
| **TaxCd** | Един байт, съдържащ буквата, показваща вида на данъка ('А', 'Б', 'В', ...). Има ограничение, зависещо от параметъра Enabled_taxes |
| **Dept** | Номер на департамент. Цяло число от 1 до 60 включително |
| **Sign** | Един байт със стойност '-' |
| **Price** | Цената - до 8 значещи цифри |
| **Qwan** | Незадължителен параметър, задаващ количеството на стоката. По подразбиране е 1.000. Дължина до 8 значещи цифри |
| **UN** | Име на мерна единица. Опционален текст за мерна единица на количеството до 8 символа |
| **Perc** | Незадължителен параметър, показващ стойността на надбавката или отстъпката в проценти. Допустими стойности от -99.00 % до 99.00 % |
| **Abs** | Незадължителен параметър, показващ стойността на надбавката или отстъпката като сума |

**ФП ще извърши следните действия:**
- Ако продажбата е по департамент и е разрешено с команда 43, подкоманда 'N', отпечатва се името на департамента
- Текстът, описващ продажбата, се отпечатва заедно с цената и кода на данъчната група
- Цената на стоката се прибавя към натрупаните суми в регистрите
- Ако има отстъпка или надбавка, тя се отпечатва на отделен ред
- Цената на стоката са показва на горния, а описанието и на долния ред на дисплея
- Ако е указан департамент, натрупаната стойност се прибавя към него

**Командата няма да бъде изпълнена успешно, ако:**
- Не е отворен фискален бон
- Вече са направени максималния брой продажби за един бон
- Командата "Total" е изпълнена успешно
- Сумата по някоя от данъчните групи става отрицателна
- КЛЕН е пълна

### 35h (53) - ИЗЧИСЛЯВАНЕ НА СБОР (ТОТАЛ)

**Област за данни:** `[<Line1>][<Lf><Line2>]<Tab>[[<PaidMode>]<[Sign]Amount>]`  
**Отговор:** `<PaidCode><Amount>`

| Параметър | Описание |
|-----------|----------|
| **Line1** | Текст до 36 байта съдържащ първия ред |
| **Lf** | Един байт със съдържание 0Ah |
| **Line2** | Текст до 36 байта съдържащ втория ред |
| **Tab** | Един байт със съдържание 09h |
| **PaidMode** | Незадължителен код, указващ начина на плащане |
| **Sign** | Един байт със стойност '+', указващ знака на Amount |
| **Amount** | Сумата, която се плаща /до 10 значещи цифри/ |

#### Видове плащания (PaidMode):

| Код | Описание |
|-----|----------|
| 'P' | Плащане в брой (по подразбиране) |
| 'N' | Плащане с кредит |
| 'C' | Плащане с чек |
| 'D' | Плащане с дебитна карта |
| 'I', 'i' | Програмируем тип плащане 1 |
| 'J', 'j' | Програмируем тип плащане 2 |
| 'K', 'k' | Програмируем тип плащане 3 |
| 'L', 'l' | Програмируем тип плащане 4 |
| 'm' | Талони |
| 'n' | Външни талони |
| 'o' | Амбалаж |
| 'p' | Вътрешно обслужване |
| 'q' | Повреди |
| 'r' | Банкови трансфери |
| 's' | С чек |

#### PaidCode - резултат от изпълнението:

| Код | Описание |
|-----|----------|
| 'F' | Грешка |
| 'E' | Изчислената под сума е отрицателна. Плащане не се извършва |
| 'D' | Платената сума е по-малка от сумата на бона. Остатъкът за доплащане се връща в Amount |
| 'R' | Платената сума е по-голяма от сбора на бележката. Ще се отпечата "РЕСТО" и рестото се връща в Amount |
| 'I' | Сумата по някоя данъчна група е бил отрицателен |

Тази команда предизвиква изчисляването на сумите от фискалния бон, отпечатването на сумата със специален шрифт и показването й на дисплей. При успешно изпълнение на командата се генерира импулс за отваряне на чекмедже, ако това е разрешено с подкоманда 'X' на команда 43.

**Командата няма да бъде изпълнена успешно, ако:**
- Не е отворен фискален бон
- Натрупаната сума е отрицателна
- Някоя от натрупаните суми по данъчни групи е отрицателна

> **Забележка:** Кодове на грешка 'E' и 'I' никога няма да се получат в българската версия на принтера, защото команди 49 и 52 няма да допуснат отрицателни суми.

### 36h (54) - ПЕЧАТАНЕ НА ФИСКАЛЕН СВОБОДЕН ТЕКСТ

**Област за данни:** `[<Tab><Font>[<Flags>],]<Text>`  
**Отговор:** Няма данни

| Параметър | Описание |
|-----------|----------|
| **Text** | Свободен текст за печат. В началото и края на реда се отпечатва символът '#' |
| **Font** | Цяло число от 0 до 3 |
| **Flags** | От една до 3 букви: 'B', 'H' или 'I' |

Необходимо е да е отворен фискален бон. В противен случай не се отпечатва текста и се вдига S1.1.

### 38h (56) - ЗАТВАРЯНЕ (ПРИКЛЮЧВАНЕ) НА ФИСКАЛЕН БОН

**Област за данни:** Няма данни  
**Отговор:** `Allreceipt, FiscReceipt`

| Параметър | Описание |
|-----------|----------|
| **Allreceipt** | Всички издадени бележки от последното приключване на деня до момента |
| **FiscReceipt** | Всички издадени фискални бележки от последното приключване на деня до момента |

Натрупаните суми от фискалния бон се прибавят към дневните суми в регистрите на оперативната памет.

**Командата няма да бъде изпълнена успешно, ако:**
- Не е отворен фискален бон
- Команда 53 (35h) не е изпълнена успешно
- Платената сума по команда 53 е по-малка от общата сума на фискалния бон

### 39h (57) - ПЕЧАТ НА ИНФОРМАЦИЯ ЗА КЛИЕНТА

**Област за данни:** `[# | * | ^]<Bulstat>[<Tab><Seller>[<Tab><Receiver>[<Tab><Client>[<Tab><TaxNo>[<Tab><Address>]]]]]`  
**Отговор:** Няма данни

| Параметър | Описание |
|-----------|----------|
| **Bulstat** | ЕИК номер на купувача. Между 9 и 14 символа. Ако преди него стои '#' - ЕГН, '\*' - личен номер, '^' - служебен номер |
| **Tab** | Табулация (09H). Разделител между параметрите |
| **Seller** | Име на продавача. До 26 символа |
| **Receiver** | Име на получателя. До 26 символа |
| **Client** | Име на купувача. До 26 символа |
| **TaxNo** | ЗДДС номер на купувача. Между 10 и 14 символа |
| **Address** | Адрес на купувача. До два реда текст, разделени с LF (0AH) |

С изключение на първия всички останали параметри не са задължителни. Ако трябва да се зададе някой параметър, всички преди него трябва да са зададени.

Командата е допустима само във разширен фискален бон (фактура) за унифицирано оформяне на боновете. Трябва да се изпълни непосредствено след цялостно плащане на натрупаната за бона сума.

### 3Ah (58) - РЕГИСТРИРАНЕ (ПРОДАЖБА) НА АРТИКУЛ ИЛИ ГОРИВО

**Област за данни:**  
`[D]<[Sign]PLU>[<Tab><Dept><Tab>][*<Qwan>[#UN]][,Perc|;Abs]`  
или  
`[D]@<FTT>[*<Quantity>][,|;<Discount_MarkUp>]`

**Отговор:** Няма данни

| Параметър | Описание |
|-----------|----------|
| **D** | Един байт със стойност 'D'. Ако го има, продажбата става с показване на клиентския дисплей |
| **Sign** | Един байт със стойност '-' |
| **PLU** | Номер на артикула. Цяло число от 1 до 999999999 (до 9 цифри) |
| **FTT** | Номер на FTT |
| **Tab** | Един байт – табулация (ASCII код 9) |
| **Dept** | Номер на департамент. Цяло число от 1 до 60 включително |
| **Qwan** | Незадължителен параметър, задаващ количеството на стоката. По подразбиране е 1.000 |
| **UN** | Име на мерна единица (до 8 символа) |
| **Perc** | Незадължителен параметър за надбавка/отстъпка в проценти |
| **Abs** | Незадължителен параметър за надбавка/отстъпка като сума |

**ФП извършва следните действия:**
- Прочита се от таблицата с артикулите името, цената и данъчната група на стоката
- Ако продажбата е по департамент и е разрешено, отпечатва се името на департамента
- Отпечатва името на артикула, посоченото количество и единичната цена
- Цената на стоката се прибавя към натрупаните суми
- Ако има отстъпка или надбавка, тя се отпечатва на отделен ред

**Командата няма да бъде изпълнена успешно, ако:**
- Не е програмиран артикул с посочения номер
- Не е отворен фискален бон
- Вече са направени максималния брой продажби за един бон (512)
- Командата (35h) е изпълнена успешно
- КЛЕН е пълна

### 3Ch (60) - ОТКАЗВАНЕ (ПРЕКРАТЯВАНЕ) НА ФИСКАЛЕН БОН

**Област за данни:** Няма данни  
**Отговор:** Няма данни

Командата е допустима само в отворен фисакален бон, и то преди изпълнението на команда 53 (Total). Предизвиква отказването на всички натрупани в бона суми. Отпечатва се с двойна ширина **"=АНУЛИРАНО="** и бонът завършва с надпис **"ФИСКАЛЕН БОН"**.

### 3Dh (61) - УСТАНОВЯВАНЕ НА ДАТАТА И ЧАСА

**Област за данни:** `<DD-MM-YY><space><HH:MM[:SS]>`  
**Отговор:** Няма данни

Не може да се установява дата, по-ранна от датата на последния запис във фискалната памет. Предвидено е да се работи до 2099 година включително. След RESET на паметта командата трябва задължително да се изпълни, за да се продължи нормалната работа.

Не е възможно задаване на дата и час по-ранна от последния отпечатан документ, записан в КЛЕН.

### 3Eh (62) - ПРОЧИТАНЕ НА ДАТАТА И ЧАСА

**Област за данни:** Няма данни  
**Отговор:** `<DD-MM-YY><Space><HH:MM:SS>`

### 3Fh (63) - ПОКАЗВАНЕ НА ДАТАТА И ЧАСА

**Област за данни:** Няма данни  
**Отговор:** Няма данни

На долния ред на дисплея се показват текущите дата и час на принтера във формат DD-MM-YY HH:MM:SS.

### 40h (64) - ИНФОРМАЦИЯ ЗА ПОСЛЕДНИЯ ФИСКАЛЕН ЗАПИС

**Област за данни:** `[[<LongDT>]<Option>]`  
**Отговор:** `ErrCode[,N,TaxA,TaxB,TaxC,TaxD,TaxE,TaxF,TaxG,TaxH,Date]`

| Параметър | Описание |
|-----------|----------|
| **LongDT** | Един опционален байт със стойност '\*'. При наличието му се връща и часът на дневния отчет |
| **Option** | Един опционален байт със стойност '0' или '1'. При '0' се връща оборотът по данъчни групи, при '1' – натрупаните данъци |
| **ErrCode** | 'P' - Командата е успешна, 'F' - Командата е неуспешна |
| **N** | Номера на последния фискален запис - 4 байта |
| **TaxX** | Сумите по всяка данъчна група - 12 байта със знак |
| **Date** | Датата на фискалния запис - 6 байта /DDMMYY/ |

Командата води до предаване на информацията от последния запис във фискалната памет към компютъра.

### 41h (65) - ИНФОРМАЦИЯ ЗА СУМИТЕ ПО ДАНЪЧНИ ГРУПИ ЗА ДЕНЯ

**Област за данни:** `[Option]`  
**Отговор:** `TaxA,TaxB,TaxC,TaxD,TaxE,TaxF,TaxG,TaxH`

| Параметър | Описание |
|-----------|----------|
| **Option** | '0' - Общ оборот (по подразбиране), '1' – Натрупан ДДС |
| **TaxX** | Сумите по всяка данъчна група - 12 байта със знак |

Връщат се сумите по данъчни групи от последното приключване на деня до момента на получаване на командата.

### 42h (66) - ЗАДАВАНЕ НА ИНТЕРВАЛ ДОПУСТИМИ НОМЕРА НА ФАКТУРА

**Област за данни:** `[Start,End]`  
**Отговор:** `[Start,End,Current]`

| Параметър | Описание |
|-----------|----------|
| **Start** | Начална стойност на интервала. Цяло число до 10 цифри |
| **End** | Крайна стойност на интервала. Цяло число до 10 цифри |
| **Current** | Текущата стойност на брояча на фактурите. Цяло число с 10 цифри |

Start трябва да е по-малко или равно на End. При успешно изпълнена команда текущият номер на фактура става Start.

Ако областта за данни е празна, принтерът връща текущия интервал и брояч.

### 44h (68) - БРОЙ СВОБОДНИ ПОЛЕТА ВЪВ ФИСКАЛНАТА ПАМЕТ

**Област за данни:** Няма данни  
**Отговор:** `Free,Total`

| Параметър | Описание |
|-----------|----------|
| **Free** | Броят на свободните места за фискални записи /4 байта/ |
| **Total** | Общият брой фискални записи в принтера /4 байта/ |

### 45h (69) - ДНЕВЕН ФИНАНСОВ ОТЧЕТ

**Област за данни:** `[<Option>[N]`  
**Отговор:** `Closure,FM_Total,TotA,TotB,TotC,TotD,TotE,TotF,TotG,TotH`

| Параметър | Описание |
|-----------|----------|
| **Option** | '0' - Z-отчет (завършва с надпис "ФИСКАЛЕН БОН"), '2' - Дневен отчет без нулиране (завършва с "СЛУЖЕБЕН БОН") |
| **N** | Наличието на този символ в края на данните забранява изчистването на натрупаните данни по оператори при отчет с нулиране |
| **Closure** | Номер на фискалния запис - 4 байта |
| **FM_Total** | Сумата от всички продажби без ДДС - 12 байта със знак |
| **TotX** | Сумите по всяка от данъчните групи - 12 байта със знак |

Дневен отчет без нулиране може да се предизвика и чрез задържането на бутон <FEED> при включване на принтера до втория звуков сигнал.

### 46h (70) - СЛУЖЕБЕН ВНОС И ИЗНОС НА ПАРИ

**Област за данни:** `[<Amount>]`  
**Отговор:** `ExitCode,CashSum,ServIn,ServOut`

| Параметър | Описание |
|-----------|----------|
| **Amount** | Сумата за регистриране (до 10 значещи цифри). В зависимост от знака тя се интерпретира като внос или износ |
| **ExitCode** | 'P' - Заявката е изпълнена, 'F' - Заявката е отказана |
| **CashSum** | Касова наличност |
| **ServIn** | Сумата от всички команди "Служебен внос" |
| **ServOut** | Сумата от всички команди "Служебен износ" |

Променя съдържанието на регистъра за касова наличност. При успешно изпълнение на командата с параметър се генерира импулс за отваряне на чекмедже, ако това е разрешено с подкоманда 'X' на команда 43.

### 47h (71) - ПЕЧАТ НА ДИАГНОСТИЧНА ИНФОРМАЦИЯ

**Област за данни:** Няма данни  
**Отговор:** Няма данни

Тази команда отпечатва служебен бон с диагностична информация.

**Бонът съдържа:**
- Датата и версията на програмното осигуряване
- Контролната сума на фирмуера
- Скоростта на предаване на серийния порт
- Положението на конфигурационните ключета и името на страната
- Аварийното време при отпадане на захранването
- Номера, датата и часа на последното нулиране на RAM
- Текущата температура на печатащата глава
- Общия брой полета във фискалната памет и броя на свободните
- Текущата дата и час

Може да се предизвика и чрез задържането на бутон <FEED> при включване на принтера до първия звуков сигнал.

### 48h (72) - ФИСКАЛИЗАЦИЯ

**Област за данни:** `<Serial>`  
**Отговор:** `ErrCode`

| Параметър | Описание |
|-----------|----------|
| **Serial** | Индивидуалният номер на устройството. Трябва да е такъв, какъвто е зададен от команда 91 (5Bh) |
### 49h (73) - ПЪЛЕН ОТЧЕТ НА ФИСКАЛНАТА ПАМЕТ ПО НОМЕР НА БЛОК

**Област за данни:** `[[<SHA1>][<SkipZ>]<Start>,<End>]`  
**Отговор:** Няма данни

| Параметър | Описание |
|-----------|----------|
| **SHA1** | Опционален аргумент – един байт със стойност '#'. Ако присъства, за всеки Z-отчет се отпечатва и контролната сума по алгоритъм SHA-1 |
| **SkipZ** | Опционален аргумент – един байт със стойност '\*'. Ако присъства, за всеки Z-отчет се отпечатват само данъчните ставки, за които натрупаните суми за деня са ненулеви. Такъв отчет е нестандартен! |
| **Start** | Номер на началния фискален блок. 4 байта |
| **End** | Номер на крайния фискален блок. 4 байта |

Тази команда води до отпечатване на пълен отчет на фискалната памет от даден номер до друг. Ако няма начален и краен номер, отпечатва се отчет за целия период на експлоатация.

### 4Ah (74) - ПОЛУЧАВАНЕ НА СТАТУСА НА ПРИНТЕРА

**Област за данни:** `[Option]`  
**Отговор:** `<S0><S1><S2><S3><S4><S5>|<NLines>|HdwInfo|InfoReciepts`

| Параметър | Описание |
|-----------|----------|
| **Option** | Един байт със следните значения: |
| **W** | Първо чака да се отпечата всичко от буфера за печат |
| **X** | Не изчаква принтера, а отговаря веднага |
| **L** | Връща брой оставащи редове за печат |
| **P** | Връща хардуерна информация за принтера |
| **R** | Връща данни за изпратените към сървъра на НАП клиентски документи |
| **Sn** | Статус байт N |
| **Nlines** | Брой неотпечатани редове в буфера за печат. Стойност 0 означава, че няма чакащи за печат данни |

#### HdwInfo формат: `P<Len>,<Docs>,<Cuts>,<PwOns>,<MdRst>`

| Параметър | Описание |
|-----------|----------|
| **Len** | Дължина на отпечатаната хартия в милиметри |
| **Docs** | Брой отпечатани документи |
| **Cuts** | Брой отрязвания на хартията |
| **PwOns** | Брой включвания на принтера |
| **MdRst** | Брой рестартирания на модема |

#### InfoReciepts данни:

| Параметър | Описание |
|-----------|----------|
| **Lastprintdoc** | Номер на последния изпечатан документ |
| **Nlastsentdoc** | Номер на последния успешно изпратен документ |
| **Dtlastsentdoc** | Дата и час на последния успешно изпратен документ |
| **Minfromlastsuccesssent** | Минути от последния успешно изпратен документ |
| **Nfirstnotsentdoc** | Номер на първия не изпратен документ |
| **Dtfirstnotsentdoc** | Дата и час на първия не изпратен документ |
| **Minfromfirstnotsuccesssent** | Минути от първия не изпратен документ |

При липса на данни датите са 01-01-2000 00:00:00, а минутите са 0.  
⚠️ **Ако минутите на Minfromfirstnotsuccesssent са повече от 1440 принтера се блокира.**

### 4Bh (75) - ФОРСИРАНЕ НА ПОДТИСНАТ ПЕЧАТ

**Област за данни:** `[<Restore>]`  
**Отговор:** Няма данни

Възобновява подтиснатия печат в бон в следствие на команда 43, подкоманда 'Q'.

| Параметър | Описание |
|-----------|----------|
| **Restore** | 0 - След края на печата той е разрешен, 1 - След изчистването на буфера той остава подтиснат до края на бона |

### 4Ch (76) - СТАТУС НА ФИСКАЛНАТА ТРАНЗАКЦИЯ

**Област за данни:** `[Option]`  
**Отговор:** `Open,Items,Amount[,Tender]`

| Параметър | Описание |
|-----------|----------|
| **Option** | = 'T'. Ако е указан, командата ще върне информацията относно текущото състояние на дължимата сметка |
| **Open** | '1' ако е отворен фискален или служебен бон, '0' ако няма отворен бон |
| **Items** | Броят на продажбите регистрирани на текущия или последния фискален бон. 4 байта |
| **Amount** | Сумата от последния фискален бон – 9 байта със знак |
| **Tender** | Сумата платена на поредния или последен бон. 9 байта със знак |

Тази команда дава възможност на приложението в PC да установи статуса и да възстанови и завърши фискална операция, прекъсната аварийно (например при изключване на ел. захранване).

### 4Fh (79) - СЪКРАТЕН ОТЧЕТ НА ФИСКАЛНАТА ПАМЕТ ОТ ДАТА ДО ДАТА

**Област за данни:** `<Start>[,<End>]`  
**Отговор:** Няма данни

| Параметър | Описание |
|-----------|----------|
| **Start** | Начална дата - 6 байта (DDMMYY) |
| **End** | Крайна дата - 6 байта (DDMMYY) |

Командата води до изчисляване и отпечатване на съкратен отчет на фискалната памет.

Ако вторият параметър липсва, командата генерира месечен или годишен отчет:
- **Месечен отчет:** Start = MMYY (4 байта)
- **Годишен отчет:** Start = YY (2 байта)

### 50H (80) - ЗВУКОВ СИГНАЛ (МЕЛОДИЯ)

**Област за данни:** `[<SoundData>]`  
**Отговор:** Няма данни

Командата служи за издаване на поредица от тонове със зададена честота и продължителност.

**Ако няма входни данни:** издава се звуков сигнал с честота 2 kHz и продължителност 300 ms.

**Ако входните данни са:** `<Hz>,<mSec>` - издава се звуков сигнал с честота Hz херца (между 100 и 5000) и продължителност mSec милисекунди (между 50 и 2000).

#### Формат за ноти:

| Нота | Звук |
|------|------|
| 'C' | до |
| 'D' | ре |
| 'E' | ми |
| 'F' | фа |
| 'G' | сол |
| 'A' | ла |
| 'B' | си |

- Ако след нотата следва **'#'** - тя се повишава с един полутон (диез)
- Ако след нотата следва **'&'** - тя се понижава с един полутон (бемол)
- **Пауза:** символът интервал (ASCII 20h)

#### Продължителност:

| Код | Продължителност |
|-----|-----------------|
| '0' | Базова продължителност |
| '1' | Базова × 2 |
| '2' | Базова × 4 |
| '3' | Базова × 8 |
| '4' | Базова × 16 |
| '5' | Базова × 32 |

#### Специални команди:

- **'+'** - Преминаване към по-висока гама
- **'-'** - Преминаване към по-ниска гама
- **'^'** - Задаване на темпо (следван от цифра '1'-'9')
- **'@'** - Връщане към гама 1

Изсвирването на последователността е фоново - принтерът може да изпълнява команди по време на звуковия сигнал.

### 51H (81) - ПОЛУЧАВАНЕ НА ЗАХРАНВАЩОТО НАПРЕЖЕНИЕ И ТЕМПЕРАТУРАТА

**Област за данни:** Няма данни  
**Отговор:** `<Vh>,<Temp>`

| Параметър | Описание |
|-----------|----------|
| **Vh** | Захранващото напрежение във волтове |
| **Temp** | Температурата на печатащата глава в градуси |

### 53h (83) - УСТАНОВЯВАНЕ НА ДЕСЕТИЧНИ ЗНАЦИ, ВАЛУТА И ДАНЪЧНИТЕ СТАВКИ

**Област за данни:** `[Multiplier,Decimals,Currency,EnabledT,TaxA,...]`  
**Отговор:** `Multiplier,Decimals,Currency_name,EnabledT,TaxA,TaxB,TaxC,TaxD,…`

| Параметър | Описание |
|-----------|----------|
| **Multiplier** | Множител - между 0 и 3. В момента е деактивиран и не се използува |
| **Decimals** | Един байт със стойност между 0 и 2 - показва мястото на десетичната запетая |
| **Currency** | Името на валутата. До 6 байта |
| **EnabledT** | 8 байта със стойност '0' или '1', определящи дали съответната данъчна група е забранена ('0') или разрешена ('1') |
| **TaxX** | Стойността на данъчните ставки |

Ако не се зададе нищо в областта за данни, ФП връща валидните за момента стойности.

**Установяването на нови данъчни ставки е разрешено само преди издаването на първия клиентски фискален бон за деня.**

### 54H (84) - ПЕЧАТ НА БАРКОД

**Област за данни:** `<Type>[<Align>][<AllowN>],<Data>` или `<Type>[<Align>];<Data>`  
**Отговор:** Няма данни

| Параметър | Описание |
|-----------|----------|
| **Type** | Тип на баркода |
| **Align** | Един байт - 'L', 'R', или 'C' - ляво, дясно или центриран. Допустим само при двумерните баркодове |
| **AllowN** | Незадължителен параметър - '\*'. Ако го има, Code 128 и ITF при необходимост ще се отпечатат с размер на тънката линия само една точка |

#### Типове баркодове:

| Тип | Описание |
|-----|----------|
| '1' | **EAN8** - 7 байта само цифри. Контролната сума се изчислява от принтера |
| '2' | **EAN13** - 12 байта само цифри. Контролната сума се изчислява от принтера |
| '3' | **Code 128** - ASCII кодове между 32 и 127. Дължина 22-42 символа |
| '4' | **ITF (Interleaved 2 of 5)** - само цифри |
| '5' | **ITF с контролна сума** - само цифри. Принтерът генерира контролна сума |
| 'D' | **Data Matrix** - произволни печатаеми символи (до 140) |
| 'Q' | **QR Code** - произволни печатаеми символи (до 140) |
| 'P' | **PDF417** - произволни печатаеми символи (до 140) |

Командата отпечатва баркод. Допустима е само в отворен фискален или служебен бон. Ако разделителят е запетая, под баркода се печати информацията и в текстов вид.

### 55H (85) - УСТАНОВЯВАНЕ ИМЕНА НА ДОПЪЛНИТЕЛНИТЕ ПЛАЩАНИЯ

**Област за данни:** `Option[,Name]`  
**Отговор:** `Result|Name`

| Option | Описание |
|--------|----------|
| 'I', 'i' | Допълнително плащане 1 |
| 'J', 'j' | Допълнително плащане 2 |
| 'K', 'k' | Допълнително плащане 3 |
| 'L', 'l' | Допълнително плащане 4 |
| 'm' | Допълнително плащане 5 |
| 'n' | Допълнително плащане 6 |
| 'o' | Допълнително плащане 7 |
| 'p' | Допълнително плащане 8 |
| 'q' | Допълнително плащане 9 |
| 'r' | Допълнително плащане 10 |
| 's' | Допълнително плащане 11 |

| Параметър | Описание |
|-----------|----------|
| **Name** | Име на съответния тип плащане (до 24 символа). Ако не е зададено, връща текущото име |
| **Result** | 'P' - Няма грешка, 'F' - Името е повече от 24 байта |

Командата задава коментарен текст, който се печати пред данните от допълнителните типове плащания (команда 53). Разрешена е само преди издаването на първия клиентски фискален бон за деня.

### 56H (86) - ПРОЧИТАНЕ НА ДАТАТА НА НАЙ-КЪСНИЯ ЗАПИС ВЪВ ФИСК. ПАМЕТ

**Област за данни:** `[<WithTime>]`  
**Отговор:** `DT`

| Параметър | Описание |
|-----------|----------|
| **WithTime** | Опционален параметър – символът 'T'. Ако присъствува, връща се и часа на последния запис |
| **DT** | Датата (или датата и часа) във формат DD-MM-YYYY или DD-MM-YYYY hh:mm:ss |

### 57H (87) - ПРОГРАМИРАНЕ НА ИМЕ НА ДЕПАРТАМЕНТ

**Област за данни:** `<Dept>,<TaxGr>,<Line1>[<LF><Line2>]`  
**Отговор:** Няма данни

| Параметър | Описание |
|-----------|----------|
| **Dept** | Номер на департамент. Цяло число от 1 до 1200 |
| **TaxGr** | Данъчна група, асоциирана с департамента |
| **Line1** | Име или поясняващ текст за департамента. До 28 символа |
| **LF** | Разделител. Един символ – ASCII код 10 |
| **Line2** | Име или поясняващ текст за департамента – втори ред. До 34 символа |

Командата може да се изпълни само ако за департамента не са издавани фискални бонове след последния Z-отчет.

### 58H (88) - ПОЛУЧАВАНЕ ДАННИ ЗА НАТРУПАНИТЕ СУМИ ЗА ДЕПАРТАМЕНТ

**Област за данни:** `<Dept>`  
**Отговор:** `ExitCode[TaxGr,RecSales,RecSum,TotSales,TotSum,Line1<LF>Line2]`

| Параметър | Описание |
|-----------|----------|
| **Dept** | Номер на департамент (1-1200). При стойност 0 се връщат данните за продажбите без посочване на департамент |
| **ExitCode** | 'P' - Департаментът е програмиран, 'F' - Департаментът не е програмиран |
| **TaxGr** | Данъчна група на департамента |
| **RecSales** | Брой продажби за департамента в бона |
| **RecSum** | Натрупана сума за текущия или последния фискален бон |
| **TotSales** | Брой продажби за департамента за деня |
| **TotSum** | Натрупана сума за деня за съответния департамент |
| **Line1, Line2** | Име или поясняващ текст за департамента |

### 59h (89) - ПРОГРАМИРАНЕ НА ПРОИЗВОДСТВЕНАТА ТЕСТОВА ОБЛАСТ

**Област за данни:** `<Test>`  
**Отговор:** `Result,Free`

| Параметър | Описание |
|-----------|----------|
| **Test** | Един байт. Ако е 'Т' се извършва запис във фискалната памет |
| **Result** | P (50h) - Няма грешка, F (46h) - Има грешка |
| **Free** | Броя на останалите свободни блокове. 4 байта |

Тази команда се изпълнява за тестване на фискалната памет.  
Тестови блок: `55h,AAh,33h,CCh,5Ah,A5h,3Ch,C3h`

### 5Ah (90) - ЧЕТЕНЕ НА ДИАГНОСТИЧНА ИНФОРМАЦИЯ

**Област за данни:** `[*]<Calc>`  
**Отговор:** `<Name>,<FwRev><Country><Sp><FwDate><Sp><FwTime>,<Chk>,<Sw>,<Ser>,<FM>`

| Параметър | Описание |
|-----------|----------|
| **\*** | Незадължителен параметър, позволяващ да се прочетат всичките 16 конфигурационни ключета |
| **Calc** | Ако е '1' се изчислява контролна сума на фирмуера |
| **Name** | Име на фискалното устройство |
| **FwRev** | Версията на програмното осигуряване. 4 байта |
| **Country** | Дву-буквено означение на държавата (в случая "BG") |
| **FwDate** | Датата на програмното осигуряване DDMmmYY. 7 байта |
| **FwTime** | Час на програмното осигуряване HHMM. 4 байта |
| **Chk** | Контролна сума на EPROM. 4 байта в шестнайсетичен вид |
| **Sw** | Ключетата от Sw1 до Sw8. 8 байта с '0' или '1' |
| **Ser** | Индивидуален номер на устройството - 8 байта |
| **FM** | Номер на фискалния модул – 8 байта |

### 5Bh (91) - ПРОГРАМИРАНЕ НА ИНДИВИДУАЛНИЯ НОМЕР И НОМЕРА НА ФИСКАЛНАТА ПАМЕТ

**Област за данни:** `Serial,FMnumber`  
**Отговор:** `Result,CountryStr`

| Параметър | Описание |
|-----------|----------|
| **Serial** | 8 байта – индивидуален номер на принтера (2 латински букви и най-малко 6 цифри) |
| **FMnumber** | 8 байта – номер на модула фискална памет (само цифри) |
| **Result** | 'P' - няма грешки, 'F' - има грешки |
| **CountryStr** | Стринг, съдържащ името на страната (например "BULGARIA") |

⚠️ **Командата може да се изпълни само в сервизен режим във фирмата-производител.**

### 5Ch (92) - ПЕЧАТ НА РАЗДЕЛИТЕЛНА ЛИНИЯ

**Област за данни:** `Type`  
**Отговор:** Няма данни

| Type | Описание |
|------|----------|
| '1' | Запълване със символа '-' |
| '2' | Запълване последователно със символите '-' и ' ' |
| '3' | Запълване със символа '=' |
| '4' | Запълване със символа '\*' с двойна ширина |
| 'W<bm>' | където bm е число от 0 до 3 (битова маска). Поддържа се само в служебни бонове |

Принтерът печати разделителна линия от посочения тип по цялата ширина на хартията.  
Трябва да е отворен фискален или служебен бон.

### 5Dh (93) - ПОЛУЧАВАНЕ НА ИНФОРМАЦИЯ ЗА ОТСТЪПКИТЕ И НАДБАВКИТЕ ЗА ДЕНЯ

**Област за данни:** Няма данни  
**Отговор:** `<CntD>,<SumD>,<CntM>,<SumM>`

| Параметър | Описание |
|-----------|----------|
| **CntD** | Брой отстъпки след последния Z-отчет |
| **SumD** | Сума от отстъпки след последния Z-отчет |
| **CntM** | Брой надбавки след последния Z-отчет |
| **SumM** | Сума от надбавки след последния Z-отчет |

| Параметър | Описание |
|-----------|----------|
| **SHA1** | Опционален аргумент – един байт със стойност '#'. Ако присъства, за всеки Z-отчет се отпечатва и контролната сума по алгоритъм SHA-1 |
| **SkipZ** | Опционален аргумент – един байт със стойност '\*'. Ако присъства, за всеки Z-отчет се отпечатват само данъчните ставки с ненулеви суми |
| **Start** | Началната дата на фискален запис. 6 байта (DDMMYY) |
| **End** | Крайна дата на фискален запис. 6 байта (DDMMYY) |

Тази команда отпечатва пълен отчет на фискалната памет за периода между две дати.

Ако вторият параметър липсва, командата генерира месечен или годишен отчет:
- **Месечен отчет:** Start = MMYY (4 байта)
- **Годишен отчет:** Start = YY (2 байта)

### 5Fh (95) - СЪКРАТЕН ОТЧЕТ НА ФИСКАЛНАТА ПАМЕТ ЗА ДАДЕН ПЕРИОД

**Област за данни:** `[<Start>,<End>]`  
**Отговор:** Няма данни

| Параметър | Описание |
|-----------|----------|
| **Start** | Начален номер на фискален запис |
| **End** | Краен номер на фискален запис |

Командата води до изчисляване и отпечатване на съкратен отчет на фискалната памет. Този отчет за целия период може да се предизвика и чрез задържането на бутон <FEED> при включване на принтера до четвъртия звуков сигнал.

При липса на входни данни се отпечатва отчет за целия период на експлоатация.

### 61h (97) - ПРОЧИТАНЕ НА УСТАНОВЕНИТЕ ДАНЪЧНИ СТАВКИ

**Област за данни:** Няма данни  
**Отговор:** `TaxA,TaxB,TaxC,TaxD,TaxE,TaxF,TaxG,TaxH`

| Параметър | Описание |
|-----------|----------|
| **TaxA-TaxH** | Данъчна ставка А-З |

### 62h (98) - УСТАНОВЯВАНЕ НА ЕИК

**Област за данни:** `<Text>[,<Name>]`  
**Отговор:** `Result`

| Параметър | Описание |
|-----------|----------|
| **Text** | До 14 байта съдържащи ЕИК като текст |
| **Name** | Коментарният текст пред ЕИК. По подразбиране е "ЕИК" |
| **Result** | 'P' - Няма грешка, 'F' - Грешка |

### 63h (99) - ПРОЧИТАНЕ НА ЕИК

**Област за данни:** Няма данни  
**Отговор:** `<Text>,<Name>`

| Параметър | Описание |
|-----------|----------|
| **Text** | ЕИК като текст |
| **Name** | Коментарният текст преди ЕИК |

### 64h (100) - ПОКАЗВАНЕ НА ТЕКСТ НА ДИСПЛЕЯ

**Област за данни:** `Text`  
**Отговор:** Няма данни

| Параметър | Описание |
|-----------|----------|
| **Text** | Текст до 40 символа, който се изпраща към дисплея. Ако е необходимо да се предадат ASCII символи по-малки от 20h, те се увеличават с 40h и се предхождат от 10h (DLE) |

**Пример:** За да се предаде 1Bh,4Bh,00h в полето за данни се записва 10h,5Bh,4Bh,10h,40h.

### 65h (101) - ЗАДАВАНЕ НА ОПЕРАТОРСКА ПАРОЛА

**Област за данни:** `<OpCode>,<OldPwd>,<NewPwd>`  
**Отговор:** Няма данни

| Параметър | Описание |
|-----------|----------|
| **OpCode** | Код на оператор. От 1 до 16 |
| **OldPwd** | Стара парола (4 до 8 цифри) |
| **NewPwd** | Нова парола (4 до 8 цифри) |

Задава една от шестнайсетте операторски пароли. При три грешни опита принтерът блокира и трябва да се изключи и включи за продължаване на работата.

След инициализация или нулиране на оперативната памет всички пароли са **"0000"**.

### 66h (102) - ЗАДАВАНЕ НА ИМЕ НА ОПЕРАТОР

**Област за данни:** `<OpCode>,<Pwd>,<OpName>`  
**Отговор:** Няма данни

| Параметър | Описание |
|-----------|----------|
| **OpCode** | Код на оператор. От 1 до 16 |
| **Pwd** | Парола (4 до 8 цифри) |
| **OpName** | Име на оператор (до 24 символа) |

Задава едно от шестнайсетте имена на оператори. Номерът и името на оператора се отпечатва в началото на всеки фискален бон.

### 67h (103) - ИНФОРМАЦИЯ ЗА ТЕКУЩИЯ БОН

**Област за данни:** Няма данни  
**Отговор:** `CanVd,TaxA,TaxB,TaxC,TaxD,TaxE,TaxF,TaxG,TaxH,Inv,InvNum`

| Параметър | Описание |
|-----------|----------|
| **CanVd** | Възможно ли е връщане (продажба с отрицателен знак) [0/1] |
| **TaxA-TaxH** | Натрупана сума по данъчна група А-З |
| **Inv** | Отворена ли е разширена клиентска бележка |
| **InvNmb** | Номер на следващата фактура /10 цифри/ |

### 68h (105) - ОТЧЕТ ОПЕРАТОРИ

**Област за данни:** Няма данни  
**Отговор:** Няма данни

Разпечатва се информация за продажбите по оператори. За всеки оператор се отпечатва името, номера, броя фискални бонове, отстъпки, надбавки и натрупаните суми.

### 6Ah (106) - ОТВАРЯНЕ НА ЧЕКМЕДЖЕ

**Област за данни:** `[<mSec>]`  
**Отговор:** Няма данни

| Параметър | Описание |
|-----------|----------|
| **mSec** | Дължина на импулса в милисекунди (5-100) |

Изпраща импулс за отваряне на чекмедже. Параметърът задава нова стойност на дължината на импулса. След RESET на паметта се установява стойност 15 ms.

### 6Bh (107) - ДЕФИНИРАНЕ И ЧЕТЕНЕ НА АРТИКУЛИ ИЛИ ГОРИВО

**Област за данни:** `<Option>[Parameters]`  
**Отговор:** `ErrorCode[Data]`

| Параметър | Описание |
|-----------|----------|
| **Option** | Един байт, определящ вида на исканата операция: 'I', 'P', 'D', 'A', 'C', 'R', 'F', 'L', 'N', 'X', 'f', 'l', 'n', 'x' |
| **ErrorCode** | 'P' - Командата е успешна, 'F' - Командата е неуспешна |

#### Подкоманди:

| Команда | Описание |
|---------|----------|
| **'I'** | Article information - Информация за артикули |
| **'P'** | Програмиране на артикул |
| **'A'** | Промяна на наличното количество за артикул |
| **'C'** | Задаване цена на артикул или гориво |
| **'D'** | Изтриване на артикул |
| **'R'** | Прочитане данните за артикул |
| **'F'** | Връщане на първия намерен програмиран артикул или FTT |
| **'L'** | Връщане на последния намерен програмиран артикул |
| **'N'** | Връщане на следващия намерен програмиран артикул или FTT |
| **'f'** | Връщане на първия намерен артикул с продажби |
| **'l'** | Връщане на последния намерен артикул с продажби |
| **'n'** | Връщане на следващия намерен артикул с продажби |
| **'X'** | Намиране на първия свободен артикул |
| **'x'** | Намиране на последния свободен артикул |

**Формат 'I':** `<I>[@]`  
**Отговор:** `Total,Prog,Len` или `<9>,<ProgrFTT>,<NameMaxLength>`

**Формат 'P':** `<P><TaxGr><PLU>,<Group>,<SPrice>,[<Replace>]<Quantity>,<Name>`

**Формат 'R':** `<R><PLU>` або `R@<FTT>`  
**Отговор:** `<'P'><PLU>,<TaxGr>,<Grp>,<SPrice>,<Total>,<Sold>,<Avail>,<Name>`

Могат да се програмират до **3000 артикула**.

### 6Ch (108) - РАЗШИРЕН ДНЕВЕН ФИНАНСОВ ОТЧЕТ

**Област за данни:** `[<Option>[N]`  
**Отговор:** `Closure,FM_Total,TotA,TotB,TotC,TotD,TotE,TotF,TotG,TotH`

Командата има същия синтаксис както команда 69 (45H), но в началото на дневния отчет се отпечатва и списъка на артикулите с PLU по-малко или равно на 10, по които има продажби за деня (горива).

### 6Dh (109) - ПЕЧАТ НА ДУБЛИРАЩ БОН

**Област за данни:** `<Count>`  
**Отговор:** Няма данни

| Параметър | Описание |
|-----------|----------|
| **Count** | Брой дублиращи бонове (приема се само стойност 1!) |

Предизвиква отпечатването на копие на последния затворен фискален бон с продажби. Копието се маркира като **СЛУЖЕБЕН БОН** и след HEADER-а се отпечатва ред с удебелен шрифт **"ДУБЛИКАТ"**.

⚠️ **При повторен опит командата ще откаже да печати. Отпечатването е невъзможно ако броят редове в бона е по-голям от 1000.**

### 6Еh (110) - ИНФОРМАЦИЯ ЗА ПЛАЩАНИЯТА ПО ТИП ЗА ДЕНЯ

**Област за данни:** `[<Extended>]`  
**Отговор:** `Cash,Credit,Debit,Cheque,Pay1,Pay2,Pay3,Pay4,Closure,Receipt[,Pay5,...]`

| Параметър | Описание |
|-----------|----------|
| **Extended** | Опционален параметър – '\*'. Ако го има, връщат се всички 11 допълнителни типа плащане |
| **Cash** | Платено в брой |
| **Credit** | На кредит |
| **Debit** | С дебитна карта |
| **Cheque** | Платено с чек |
| **PayX** | Платено по допълнителните типове плащане |
| **Closure** | Текущ (последен) фискален запис |
| **Receipt** | Номер на следващия фискален бон |

### 6Fh (111) - ОТЧЕТ ПО АРТИКУЛИ ИЛИ ГОРИВО

**Област за данни:** `<Option>[<Start>,<End>[,<Group>]]`  
**Отговор:** `ErrorCode`

| Option | Описание |
|--------|----------|
| **'S'** | Отпечатват се само артикулите с продажби за деня |
| **'P'** | Отпечатват се всички програмирани артикули |
| **'@S'** | Отпечатват се само FTT с продажби за деня |
| **'@P'** | Отпечатват се всички програмирани FTT |

| Параметър | Описание |
|-----------|----------|
| **Start** | Начален номер на артикул. По подразбиране е 1 |
| **End** | Последен номер на артикул. По подразбиране е 999999999 |
| **Group** | Число от 1 до 99. Ако е зададен, само артикулите от тази група се включват в отчета |

### 70h (112) - ПОЛУЧАВАНЕ НА ИНФОРМАЦИЯ ЗА ОПЕРАТОР

**Област за данни:** `Operator`  
**Отговор:** `Receipts,Total,Discount,Surcharge,Void,Name[,Password]`

| Параметър | Описание |
|-----------|----------|
| **Operator** | Номер на оператор (1 до 16) |
| **Receipts** | Брой фискални бонове, издадени от оператора |
| **Total** | Брой продажби и обща натрупана сума, разделени с ';' |
| **Discount** | Брой отстъпки и обща сума на отстъпките |
| **Surcharge** | Брой надбавки и обща сума на надбавките |
| **Void** | Брой корекции и обща сума на корекциите |
| **Name** | Име на оператора |
| **Password** | Операторска парола (връща се само със сервизен джъмпер) |

### 71h (113) - ПОЛУЧАВАНЕ НОМЕРА НА ПОСЛЕДНИЯ ОТПЕЧАТАН ДОКУМЕНТ

**Област за данни:** Няма данни  
**Отговор:** `DocNum`

| Параметър | Описание |
|-----------|----------|
| **DocNum** | Номер на последния издаден документ (7 цифри) |

### 72h (114) - ИНФОРМАЦИЯ ЗА ФИСКАЛЕН ЗАПИС ИЛИ ФИСКАЛЕН ПЕРИОД

**Област за данни:** `<Rec1>,<Type>[,Rec2]`  
**Отговор:** Зависи от стойността на Type

| Параметър | Описание |
|-----------|----------|
| **Rec1** | Номер на запис от фискалната памет |
| **Rec2** | Номер на фискален запис за справки 1, 2 и 3 |

#### Type - Вид на исканата информация:

| Type | Описание |
|------|----------|
| **0** | Информация за активните данъчни ставки за въпросния Z-отчет |
| **1** | Информация за оборота за посочения запис или период |
| **2** | Информация за нет-сумите за посочения запис или период |
| **3** | Информация за начисления ДДС за посочения запис или период |
| **4** | Допълнителна информация за посочения запис |
| **5** | Информация за посочения запис от ФП за задаване на данъчни ставки |
| **6** | Информация за посочения запис от ФП с нулиране на RAM |
| **7** | Информация за сумите по тип плащане за посочения запис или период |
| **8** | Информация за отстъпките и надбавките |
| **9** | Информация за служебен внос и износ |
| **10** | Информация за общия оборот и ДДС до посочения Z-отчет |
| **11** | Информация за FTT и имената на програмираните горива (принтери тип 3 и 31) |
| **12** | Информация за продадените количества и оборот за горивата (принтери тип 3 и 31) |
| **13** | Информация за програмираните колонки (принтери тип 31) |
| **14** | Информация за термометрите и течни нива (принтери тип 31) |
| **15** | Информация за дюзите (принтери тип 31) |

**ErrorCode:** 'P' - Данните са валидни

---

### Кодове за грешки в записи от фискалната памет

| Код | Значение |
|-----|----------|
| **'F'** | Невалидна контролна сума на записа. Няма данни |
| **'E'** | Няма такъв запис. Няма данни |

**Възвръщани параметри:**

| Параметър | Описание |
|-----------|----------|
| **Closure** | Номер на фискален запис |
| **DecRec** | Последен (активен) запис с данъчни ставки |
| **Dec** | Брой десетични знаци за посочения Z-отчет запис |
| **Enabled** | Разрешени данъчни ставки – 8 байта със стойности '0' или '1', където '1' означава "разрешено" |
| **Receipts** | Брой фискални бонове |
| **PerX** | Данъчна ставка за съответната данъчна група в проценти |
| **TotX** | Оборот за съответната данъчна група |
| **NetX** | Нето сума за съответната данъчна група |
| **TaxX** | Начислен ДДС за съответната данъчна група |
| **ResetRec** | Последно нулиране на RAM до този фискален блок |
| **KLEN** | Номер на КЛЕН за този фискален блок |
| **DT** | Дата и час на данните във формат: DD-MM-YY hh:mm:ss |
| **CashP** | Платено в брой |
| **CardP** | Платено с дебитна карта |
| **CredP** | Платено с кредитна карта |
| **CheqP** | Платено с чек |
| **APaydx** | Допълнителни типове плащане |
| **DiscC, DiscS** | Брой отстъпки и натрупана сума от отстъпки |
| **MkUpC, MkUpS** | Брой надбавки и натрупана сума от надбавки |
| **VoidC, VoidS** | Брой корекции и обща сума от корекции |
| **CanC, CanS** | Брой отказани бонове и обща сума от отказани бонове |
| **In, InS** | Брой служебни въвеждания и сума |
| **Out, OutS** | Брой служебни извеждания и сума |
| **GTotal** | Натрупан оборот до посочения дневен отчет включително |
| **GVAT** | Натрупан ДДС до посочения дневен отчет включително |
| **FTTi** | FTT на програмирано гориво |
| **Namei** | Име на програмирано гориво |
| **Voli** | Натрупан обем от продажби на програмирано гориво |
| **Si** | Натрупана сума от продажби на програмирано гориво |
| **Dispi** | Номер на програмирана колонка |
| **Termi** | Номер на програмиран резервоар |
| **VolActi** | Обем на резервоара при текуща температура |
| **Vol15Ci** | Обем на резервоара при 15 градуса |
| **FLi** | Ниво на горивото в резервоара |
| **Tmpri** | Температура на горивото в резервоара |
| **Nozzlei** | Номер на пистолет |
| **CVali** | Стойност на брояча на пистолет |

Командата връща информация по данъчни групи или друг критерий за отделен запис или за посочен период. Периодичната справка за по-дълъг период може да отнеме няколко секунди.

### 73h (115) - ПРОГРАМИРАНЕ НА ГРАФИЧНО ЛОГО

**Област за данни:** `<RowNum>,<Data>` или `R<RowNum>`  
**Отговор:** Няма данни или `Data`

| Параметър | Описание |
|-----------|----------|
| **R** | Ако символът 'R' присъства в началото на данните, командата връща съдържанието на съответния графичен ред в шестнайсетичен вид |
| **RowNum** | Показва реда, който програмираме. Число от 0 до 95 |
| **Data** | Графични данни. Задават се в шестнайсетичен вид, два символа за всеки байт информация. Дължината на данните е до 72 байта, ако са по-малко, се допълват автоматично с 00 |

Командата дава възможност за дефиниране на графично лого с размер до 72x12mm (576x96 точки) или 54х12mm (384х96 точки) в зависимост от широчината на използваната термо хартия по желание на потребителя. Печатът му се активизира с команда 43. Със същата команда се задава и вертикалния му размер. За дефиниране на цялото лого командата трябва да се изпълни до 96 пъти, веднъж за всеки ред.

При ресет на RAM логото се зарежда от флаш-паметта. Програмираното с команда 115 лого може да се прехвърли във флаш-паметта с команда 41.

### 74h (116) - ПРОЧИТАНЕ НА БЛОК ОТ ФИСКАЛНАТА ПАМЕТ

**Област за данни:** `<Address>,<Bytes>`  
**Отговор:** `Data`

| Параметър | Описание |
|-----------|----------|
| **Address** | Начален адрес (спрямо началото на фискалната памет) – шестнайсетично число от 000000h до 1FFFFFh (за 16 Mbit фискална памет) |
| **Bytes** | Брой байтове, които да се върнат в десетичен вид (от 1 до 64) |
| **Data** | Съдържанието на искания блок фискална памет в шестнайсетичен вид (по 2 символа за всеки байт данни) |

Командата връща съдържанието на част от фискалната памет. За прочитане на цялата фискална памет трябва да се изпълни многократно с различен начален адрес.

### 75h (117) - ДНЕВЕН ФИНАНСОВ ОТЧЕТ С ПЕЧАТ НА ДАННИ ПО ДЕПАРТАМЕНТИ

**Област за данни:** `[<Option>[N]]`  
**Отговор:** `Closure,FM_Total,TotA,TotB,TotC,TotD,TotE,TotF,TotG,TotH`

Командата е идентична с 69 (45h) от предишната версия с единствена разлика, че в началото на дневния отчет се отпечатват и департаментите, за които има продажби за деня. Команда 69 е оставена непроменена. Команди 69, 108, 117 и 118 с опция '0' (дневен финансов отчет с нулиране) нулират и натрупаните данни по департаменти.

### 76h (118) - ДНЕВЕН ФИНАНСОВ ОТЧЕТ С ПЕЧАТ НА ДЕПАРТАМЕНТИ И АРТИКУЛИ

**Област за данни:** `[<Option>[N]]`  
**Отговор:** `Closure,FM_Total,TotA,TotB,TotC,TotD,TotE,TotF,TotG,TotH`

Командата е идентична с 69 (45h) от предишната версия с единствена разлика, че в началото на дневния отчет се отпечатват и департаментите, за които има продажби за деня, както и артикулите с номера от 1 до 40, ако по тях има продажби. Команда 69 е оставена непроменена. Команди 69, 108, 117 и 118 с опция '0' (дневен финансов отчет с нулиране) нулират и натрупаните данни по департаменти.

### 77h (119) - РАБОТА С КЛЕН

**Област за данни:** `<Type>[,<InpData>]`  
**Отговор:** Зависи от входните данни

| Параметър | Описание |
|-----------|----------|
| **Type** | Клас на командата за работа с КЛЕН. Един байт с допустима стойност: |
| **'C'** | Проверка валидността на КЛЕН или част от нея |
| **'I'** | Информация за КЛЕН |
| **'N'** | Четене на следващ текстов ред от КЛЕН |
| **'R'** | Четене на данни от КЛЕН |
| **'P'** | Печат на данни от КЛЕН |

#### Клас команди 'C': Проверка на данни от КЛЕН

**P[#]** - Отпечатва отчет за валидността на всички SHA-1 контролни суми за Z-отчети, намерени в КЛЕН. Сравняват се SHA-1 от КЛЕН и от фискалната памет. При разлика се отпечатва един ред с номера на Z-отчета, дата и часа. Ако присъства опционалният символ '#', то се отпечатва информация за всички намерени SHA-1, независимо дали са валидни или не.

**R[<Num>]** - Връща информация от КЛЕН за Z-отчет с номер Num. Прочитат се данните от посочения Z-отчет като документ. Формат на отговора:

- `P,FDocs,DT,SK` - Информация за намерения Z-отчет:
  - **FDocs** - Номер на документ на Z-отчета
  - **DT** - Дата и час на з отчета във формат „DD-MM-YYYY hh:mm:ss"
  - **SK** - 40 символа – SHA-1 на Z-отчета в шестнайсетичен вид
- `F` - Не са намерени данни в КЛЕН за този Z-отчет

**Z[<Num>]** - Връща информация от КЛЕН за Z-отчет с номер Num. Прочита се реалния текст на документите, записани в КЛЕН, изчислява се SHA-1 и се сравнява със SHA-1 от Z-отчета. Командата може да трая дълго при много документи в дневния отчет. Възможни отговори:

- `P,Docs,Bytes,SK` - Контролната сума е валидна. Прочетени са Docs документа и Bytes байта данни. SK е 40 символа – контролната сума в шестнайсетичен вид
- `F,Docs,Bytes,SK,SZ` - Контролната сума е невалидна. Прочетени са Docs документа и Bytes байта данни. SK и SZ са по 40 символа – съответно запомнената в КЛЕН и изчислената контролни суми
- `F` - Не са намерени данни в КЛЕН за този Z-отчет

#### Клас команди 'I': Информация за КЛЕН

**[X]** - След символа 'I' може да няма нищо или да има буквата 'X'. Връща се следната информация:

`P,Tot,Used,C1,C2,D1,D2`

| Параметър | Описание |
|-----------|----------|
| **Tot** | Общ размер на контролната лента в байтове |
| **Used** | Използуван размер на контролната лента в байтове |
| **C1** | Първи номер на Z-отчет в КЛЕН |
| **C2** | Последен номер на Z-отчет в КЛЕН |
| **D1** | Първи номер на документ в КЛЕН |
| **D2** | Последен номер на документ в КЛЕН |

#### Клас команди 'R': Четене на данни от КЛЕН

**[#<Flg>,]<D1>[,<D2>]** - Връща първия ред от документ номер D1 и задава край на търсенето при документ D2 (включително). Следващите редове се теглят с изпращане на команда клас 'N'. Ако е пропуснат втория аргумент, избран е само един документ - D1.

**[#<Flg>,]*<Cl>[,<D1>[,<D2>]]** - Връща първия ред от документ номер D1 за Z-отчет Cl и задава край на търсенето при документ D2 (включително) за същия Z-отчет. Следващите редове се теглят с изпращане на команда клас 'N'. Броячът на документи е за Z-отчета, т.е. Командата „*5,1,3" ще избере първите три документа от Z-отчет номер 5. Ако е пропуснат D2, то е избран само един документ – D1. Ако са пропуснати D1 и D2, избрани са всички документи за Z-отчета.

**<Flg>,<DT1>,<DT2>** - Връща първия ред от документ с дата и час DT1 и задава край на търсенето при документ с дата и час DT2 (включително). Има филтриране на документите, които са избрани, в зависимост от аргумента Flg. Следващите редове се теглят с изпращане на команда клас 'N'.

**Flg** - Символ, задаващ тип на документ, който да се избере за четене:

| Символ | Описание |
|--------|----------|
| **'A'** | Всички видове документи |
| **'F'** | Фискални (клиентски) бонове |
| **'V'** | Сторно (клиентски) бонове |
| **'C'** | Анулирани (клиентски) бонове |
| **'N'** | Служебни бонове |
| **'I'** | Бонове от служебно въвеждане |
| **'О'** | Бонове от служебно извеждане |
| **'R'** | Служебни бонове със завъртян на 90 градуса печат |
| **'S'** | Бонове от сервизни операции |
| **'P'** | Отчети (само информация за дата/час и номер на бона) |
| **'X'** | X-отчети |
| **'Z'** | Z-отчети |

**DT1** - Начални дата и час на справката във формат DDMMYY[hhmmss]. Ако се изпусне часа, то се подразбира „000000", т.е 00:00:00.

**DT2** - Крайни дата и час на справката във формат DDMMYY[hhmmss]. Ако се изпусне часа, то се подразбира „235959", т.е 23:59:59.

**Възвръщани отговори:**

- `P,Text` - Има пореден текстов ред в КЛЕН, съдържанието му е в Text. Прочетеният текст е винаги в кодова таблица 1251, независимо дали от ключетата е избран режим DOS-овска кодова таблица
- `*,` - Има пореден текстов ред в КЛЕН и това е празен ред – разделител на документи. Може да се използува за броене на намерените документи или прекратяване на четенето точно в края на документ
- `F` - Няма повече данни в КЛЕН

**Q<Addr>,<Bytes>** - Директно четене на данни от КЛЕН в „суров" вид. Командата връща 2*Bytes символа, представящи Bytes байта от КЛЕН, започвайки от адрес Addr. Addr се задава шестнайсетично, а Bytes – десетично. Данните се връщат в шестнайсетичен вид.

**q<Addr>,<Bytes>** - Директно четене на данни от КЛЕН в „суров" вид. Разликата от предходната команда е в това, че символите се връщат в текстов вид ако са печатаеми (над 1Fh) или във вида „<XX>" (шестнайсетично), ако са контролни (под 20h).

#### Клас команди 'N'

Няма допълнителни данни след този символ. Използува се в комбинация с някои от командите от клас 'R'. Служи за прочитане на следващ текстови ред от КЛЕН. Възможните отговори са същите както при началната команда клас 'R' и са описани по-горе.

⚠️ **ВНИМАНИЕ!** Изпращането на тази команда без предхождаща от клас 'R', задаваща обхвата на справката, може да доведе до четенето на безсмислени данни!

#### Клас команди 'P': Печат на данни от КЛЕН

**[<Fnt>][#<Flg>,]<D1>[,<D2>]** - Отпечатват се документите от номер D1 до номер D2 включително. Ако е пропуснат втория аргумент, избран е само един документ - D1.

**[<Fnt>][#<Flg>,]*<Cl>[,<D1>[,<D2>]]** - Отпечатват се документите от номер D1 за Z-отчет Cl до номер D2 включително за същия Z-отчет. Броячът на документи е за Z-отчета, т. е. Командата „*5,1,3" ще отпечати първите три документа от Z-отчет номер 5. Ако е пропуснат D2, то е избран само един документ – D1. Ако са пропуснати D1 и D2, избрани са всички документи за Z-отчета.

**[<Fnt>]<Flg>,<DT1>,<DT2>** - Печатат се документите с дата и час от DT1 до DT2 включително. Има филтриране на документите, които са избрани, в зависимост от аргумента Flg.

**Fnt** - Незадължителен параметър, с който можем да предизвикаме печата на документите от КЛЕН с шрифт с определена височина, ако принтерът го допуска:

| Символ | Описание |
|--------|----------|
| **'>'** | Печат с нормален размер на шрифта |
| **'<'** | Печат с ½ височина на шрифта |

Трите предходни подкоманди (по документ, Z-отчет и дата), връщат в резултат броя отпечатани документи като цяло число.

**Информация за копията на документи от КЛЕН:**

Копието на документите от КЛЕН е почти идентично с оригиналните документи. Разликите са следните:

- Копията никога нямат графично лого преди header-а
- В копията никъде не присъства графичното фискално лого
- Надписът „ФИСКАЛЕН БОН" с фискалното лого се заменя с надпис „ФИСКАЛЕН БОН – КОПИЕ" с шрифт с двойна ширина

#### Информация за вида на върнатия текст при четене на КЛЕН

- Прочетените документи нямат графично лого
- Центрирането се имитира с добавяне на интервали в началото на реда
- Печатът с двойна ширина се имитира с добавяне на един интервал преди всяка буква
- Ако във фискалните или служебните бонове има баркод, той се заменя с текста „БАРКОД [XXXX]", където XXXX е текстовата информация от баркода
- Прочетеният ред съдържа само текст, без символите <CR> и <LF> в края на реда. При изтегляне на текстова информация от КЛЕН тези символи трябва да се добавят в края на всеки ред в тази последователност. Ако това се направи, външна програма може да изчисли SHA-1 сумата и да я свери със записаната в КЛЕН – би трябвало да съвпадат
- Върнатият ред със префикс '*' (край на документ) също трябва да се добави във файла (като празен ред – само символите <CR> и <LF>), защото участвува в SHA-1 за Z-отчета

#### Клас команди 'W': Връщане на структурирана информация

**W,<FirstDoc>[,<LastDoc>]** - Намиране на документ <FirstDoc> и връщане на първия текстов ред структурирана информация.

или

**W,D<StartDateTime>,<EndDateTime>** - Намиране на първия документ между StartDateTime и EndDateTime и връщане на първия текстов ред структурирана информация. Датата и часът са във формат DDMMYY[hhmmss]. При пропускане на часа началният час е 00:00:00, а крайният 23:59:59.

**w** - Връщане на следващ ред структурирана информация

| Параметър | Описание |
|-----------|----------|
| **FirstDoc** | Номер на първия документ за справката |
| **EndDoc** | Номер на последния документ за справката. Ако липсва, е равен на първия |

**Върната структурирана информация може да има следния вид:**

- `U,<UNP>,<OperNum>,<TillNum>,<RecType>,<DocNum>`
- `V,<DecRec>,<Decimals>,<TaxRate1>, ... ,<TaxRate8>`
- `R,<TaxGrPos>,<TaxRate>,<SinglePrice>,<Quantity>,<Discount_MarkUp>,<Price>,<ArticleName>`
- `M,<Discount_MarkUp>,[<Percent>],<Subtotal>`
- `T,<DiscCnt>,<DiscSum>,<MarkUpCnt>,<MarkUpSum>,<VoidCnt>,<VoidSum>,<SalesCnt>,<Total>,<TotGr1>, ... ,<TotGr8>`
- `P,<CashPayd>,<CheqPayd>,<CardPayd>,<CredPayd>,<MorePayd1>, ... ,<MorePayd11>`
- `S,<StornoType>,<StornedDocNo>,<StornedDT>,<StornedFMIN>,<StornedUNP>,<StrornedInvoice>`
- `I,<Invoice>,<PIN>,<PINtype>`
- `D,<StartDT>,<EndDT>`
- `Z,<ZNo>,<DocNum>,<FiscNum>,<DateTime>,<Total>,<StornoSum>,<CashSum>`
- `*,`
- `F`

**Справка "U": Структурирана информация за бона (еднократно в бона)**

| Параметър | Описание |
|-----------|----------|
| **UNP** | Уникален номер на продажба. 21 символа с формат XXXXXXXX-YYYY-NNNNNNN |
| **OperNum** | Номер на оператор. От 1 до 16 |
| **TillNum** | Номер на касово място. До 5 цифри |
| **RecType** | Вид на бона: 0 - фискален; 1 - фактура; 2 - сторно; 3 - кредитно известие; 4 - анулиран |
| **DocNum** | Глобален номер на документа |

**Справка "V": Структурирана информация за десетични знаци и данъчни ставки (еднократно в бона)**

| Параметър | Описание |
|-----------|----------|
| **DecRec** | Номер на записа с данъчни ставики във ФП. Брои се от 1 |
| **Decimals** | Десетични знаци. 0 или 2 |
| **TaxRateX** | Десетична ставка X в проценти |

**Справка "R": Структурирана информация за продажба или корекция (може да я има многократно в бона)**

| Параметър | Описание |
|-----------|----------|
| **TaxGrPos** | Данъчна група (от 1 до 8) |
| **TaxRate** | Данъчна ставка в проценти |
| **SinglePrice** | Единична цена. За корекция е отрицателна |
| **Quantity** | Количество. За корекция е отрицателно |
| **Discount_MarkUp** | Отстъпка/надбавка (в зависимост от знака). За корекция е с обърнат знак |
| **Price** | Цена |
| **ArticleName** | Име на продадената стока. Ако е от два реда, разделителят е <TAB> |

**Справка "M": Структурирана информация групова отстъпка/надбавка (може да я има многократно в бона)**

| Параметър | Описание |
|-----------|----------|
| **Discount_MarkUp** | Отстъпка/надбавка (в зависимост от знака) |
| **Percent** | Процент на отстъпката/надбавката. Полето може да е празно, ако е в сума |
| **Subtotal** | Междинна сума след операцията |

**Справка "T": Структурирана информация за натрупаните суми в бона (еднократно в бона)**

| Параметър | Описание |
|-----------|----------|
| **DiscCnt** | Брой отстъпки |
| **DiscSum** | Сума от отстъпки |
| **MarkUpCnt** | Брой надбавки |
| **MarkUpSum** | Сума от надбавки |
| **VoidCnt** | Брой от корекции |
| **VoidSum** | Сума от корекции |
| **SalesCnt** | Брой продажби |
| **Total** | Обща сума за бона |
| **TotGrX** | Сума по данъчна група |

**Справка "P": Структурирана информация за платените суми (еднократно в бона)**

| Параметър | Описание |
|-----------|----------|
| **CashPayd** | Платено в брой |
| **CheqPayd** | Платено с чек |
| **CardPayd** | Платено с карта |
| **CredPayd** | Платено с кредитна карта |
| **MorePaydX** | Допълнително плащане (по реда, зададен от принтера) |

**Справка "S": Структурирана информация за сторниран бон (липсва във фискалните бонове, еднократно в бона)**

| Параметър | Описание |
|-----------|----------|
| **StornoType** | Тип на сторното: 0 - операторска грешка; 1 - връщане/рекламация; 2 - намаление дан. основа |
| **StornedDocNo** | Номер на сторнирания документ |
| **StornedDT** | Дата и час на сторнирания документ във формат DD-MM-YYYY hh:mm:ss |
| **StornedFMIN** | Номер на фискалната памет за сторнирания документ |
| **StornedUNP** | Уникален номер на продажба на сторнирания документ |
| **StrornedInvoice** | Номер на фактура. Ако не е кредитно известие, съдържа 0 |

**Справка "I": Структурирана информация за фактура (еднократно в боновете тип фактура)**

| Параметър | Описание |
|-----------|----------|
| **Invoice** | Номер на фактура |
| **PIN** | ПИН |
| **PINtype** | Вид на ПИН: 0 - БУЛСТАТ; 1 - ЕГН; 2 - Личен номер; 3 - Служебен номер |

**Справка тип "D": Дата и час на започване и на завършване на бона**

| Параметър | Описание |
|-----------|----------|
| **StartDT** | Начална дата и час във формат DD-MM-YYYY hh:mm:ss |
| **EndDT** | Крайна дата и час във формат DD-MM-YYYY hh:mm:ss |

**Справка тип "Z": Дневен отчет**

| Параметър | Описание |
|-----------|----------|
| **ZNo** | Номер на дневния отчет |
| **DocNum** | Номер на документ |
| **FiscNum** | Номер на последен фискален документ. Може да е 0, ако няма издавани |
| **DateTime** | Дата и час във формат DD-MM-YYYY hh:mm:ss |
| **Total** | Обща сума от продажби за деня |
| **StornoSum** | Обща сума от сторно бонове |
| **CashSum** | Касова наличност |

**Маркери:**

- `*,` - Край на бон
- `F` - Няма повече данни

#### Клас команди 'Y': Връщане на структурирана информация (опростен формат)

**Y,<FirstDoc>[,<LastDoc>]** - Намиране на документ <FirstDoc> и връщане на първия текстов ред структурирана информация.

**y** - Връщане на следващ ред структурирана информация

**Върната структурирана информация може да има следния вид:**

- `u,<SerialNum>,<RecType>,<DocNum>,<UNP>`
- `r,<TaxGrPos>,<TaxRate>,<SinglePrice>,<Quantity>,<Discount_MarkUp>,<Price>,<ArticleName>`
- `t,<Total>,<TotGr1>, ... ,<TotGr8>`
- `s,<StornoType>,<StornedDT>,<StornedFMIN>,<StornedUNP>,<StrornedInvoice>`
- `i,<Invoice>,<PIN>,<PINtype>`
- `*,`
- `F`

**Справка "u": Структурирана информация за бона (еднократно в бона)**

| Параметър | Описание |
|-----------|----------|
| **SerialNum** | Сериен номер на принтера |
| **RecType** | Вид на бона: 0 - фискален; 1 - фактура; 2 - сторно; 3 - кредитно известие; 4 - анулиран |
| **DocNum** | Глобален номер на документа |
| **UNP** | Уникален номер на продажба. 21 символа с формат XXXXXXXX-YYYY-NNNNNNN |

Останалите справки са идентични с тези от клас 'W'.

### 79H (121) - ПРОЧИТАНЕ НА БЛОК ОТ КОДОВАТА ПАМЕТ (ФИРМУЕРА)

**Област за данни:** `<Address>,<Bytes>`  
**Отговор:** `Data`

| Параметър | Описание |
|-----------|----------|
| **Address** | Начален адрес (спрямо началото на кодовата памет) – шестнайсетично число от 00000h до 6FFFFh |
| **Bytes** | Брой байтове, които да се върнат в десетичен вид (от 1 до 64) |
| **Data** | Съдържанието на искания блок фискална памет в шестнайсетичен вид (по 2 символа за всеки байт данни) |

Командата връща съдържанието на част от кодовата памет (фирмуера). За прочитане на цялата кодова памет трябва да се изпълни многократно. Командата е достъпна само в сервизен режим!

### 7АH (122) - ОТВАРЯНЕ НА СЛУЖЕБЕН БОН ЗА ЗАВЪРТЯН НА 90 ГРАДУСА ТЕКСТ

**Област за данни:** Няма данни  
**Отговор:** `RotRec`

| Параметър | Описание |
|-----------|----------|
| **RotRec** | Поредният номер на отворения завъртян на 90 градуса бон за деня. 4 байта без знак |

Командата отваря служебен бон, в който може да се печати завъртян на 90 градуса текст.

**Командата няма да се изпълни, ако:**
- Има отворен някакъв бон (служебен или фискален)
- Няма хартия
- Не е сверен часовникът

### 7BH (123) - ПЕЧАТ НА ЗАВЪРТЯН НА 90 ГРАДУСА ТЕКСТ

**Област за данни:** `<Text>`  
**Отговор:** Няма данни

| Параметър | Описание |
|-----------|----------|
| **Text** | Съдържанието на поредния ред от текст, който искаме да отпечатаме. Дължината му е до 100 символа |

**Възможни атрибути на текста:**

| Атрибут | Описание |
|---------|----------|
| **<Tab>B** | Стартира удебелен печат |
| **<Tab>b** | Прекратява удебеления печат |
| **<Tab>U** | Стартира подчертан печат. Може да се използува като разделителна хоризонтална линия на таблица |
| **<Tab>u** | Прекратява подчертания печат |
| **<Tab>O** | Стартира печат с черта най-отгоре. Може да се използува като разделителна горна хоризонтална линия на таблица |
| **<Tab>o** | Прекратява печата с черта най-отгоре |
| **<Tab>A** | Вмъква начална вертикална линия за таблици |
| **<Tab>Z** | Вмъква крайна вертикална линия за таблици |
| **<Tab>T** | Добавя нулев (непечатащ се) ред. Използува се за печат на хоризонтална линия в началото на таблицата (преди първия завъртян ред). Следващите символи не се печатат, но ако има включен атрибут "подчертаване", той предизвиква печат на линия с дебелина 2 точки |

Командата служи за печат на завъртян на 90 градуса текст. Хартиената лента побира до 18 реда текст (12 при тясна хартиена лента). Изпратените редове текст се натрупват в паметта на принтера по реда на изпращането им. Ако командата се изпълни повече от тринадесет пъти след отварянето на бона, то натрупаната информация се отпечатва и принтерът очаква нови текстови редове или команда 124 (затваряне на бона). При отпечатването на информацията принтерът определя най-дългия от пратените редове и допълва останалите до същата дължина.

Ако се пратят повече от 18 (12) реда, то се отпечатва повече от една колона текст. Между двете колони няма никаква междина, така че с подходящо подбрани данни могат да се получат редове с неограничена дължина.

Командата няма да се изпълни, ако не е отворен бон за печат на завъртян служебен текст.

### 7EH (124) - ЗАТВАРЯНЕ НА СЛУЖЕБЕН БОН ЗА ЗАВЪРТЯН НА 90 ГРАДУСА ТЕКСТ

**Област за данни:** Няма данни  
**Отговор:** `<RotRec>`

| Параметър | Описание |
|-----------|----------|
| **RotRec** | Поредният номер на затваряния завъртян на 90 градуса бон за деня. 4 байта без знак |

Командата затваря бона. Ако има не отпечатани редове, те се отпечатват автоматично преди затварянето му.

Командата няма да се изпълни, ако не е отворен бон за печат на завъртян служебен текст.

### 80H (128) - СЕРВИЗЕН РЕСЕТ НА RAM

**Област за данни:** Няма данни  
**Отговор:** Няма данни

Командата нулира оперативната памет на принтера, след което автоматично рестартира принтера. След изпълнението и е необходимо сверяване на часовника с команда 61, при което се прави RAM ресет запис във фискалната памет със зададените дата и час.

Командата е разрешена само при поставен сервизен джъмпер.

Във фискалната памет има място за 100 RAM ресет записа.

### 85H (133) - СЕРВИЗНА ЗАБРАНА НА ПЕЧАТА

**Област за данни:** `<Disable>`  
**Отговор:** Няма данни

| Параметър | Описание |
|-----------|----------|
| **Disable** | Един байт с допустима стойност: '0' - Печатът е разрешен; '1' - Печатът е забранен |

Командата е разрешена само при поставен сервизен джъмпер. При забранен печат принтерът извършва всички действия, включително запис в КЛЕН, но не отпечатва нищо на хартията. В регистрите на принтера се натрупват правилно данни в зависимост от пратените данни, когато е необходимо, се извършва запис във фискалната памет и пращане на данни до НАП.

Идеята е при деактивиран печат да се пращат команди с голяма скорост за тестване на принтера и КЛЕН, което би се забавило десетки пъти от печата.

При включване на принтера печатът винаги е разрешен.

### 86H (134) - СЕРВИЗНА ПОДДРЪЖКА НА КЛЕН

**Област за данни:** `<Format>`  
**Отговор:** `<Result>`

| Параметър | Описание |
|-----------|----------|
| **Format** | Един байт със стойност 'F' |
| **Result** | Един байт със стойност 'P' (успешно) или 'F' (грешка) |

Командата е разрешена само при поставен сервизен джъмпер. Служи за начално форматиране на КЛЕН. Допустима е само при нефискализиран принтер или при все още неформатирана КЛЕН.

Командата няма да се изпълни при вече форматирана КЛЕН дори и в сервизен режим (което би разрушило натрупаните там данни). При нова празна КЛЕН тя ще и зададе пореден номер и ще разреши работата с нея, но след това старата КЛЕН става забранена за запис и може да служи само за печат и четене на справки.

### 87H (135) - ТЕСТ НА GPRS МОДЕМА

**Област за данни:** `<Cmd[,<PIN>]>`  
**Отговор:** `<Result>,<Data>`

| Параметър | Описание |
|-----------|----------|
| **Cmd** | Един байт със стойност 'M' |
| **PIN** | Ако картата на мобилния оператор изисква PIN, той се задава тук |
| **Result** | Един байт със стойност 'P' (успешно) или 'F' (грешка) |
| **Data** | При успех връща данни за модема, картата и установената връзка. При грешка връща код на грешка и кратко описание |

Ако при подаване на командата модемът е зает (изпраща данни), тя може да продължи по-дълго от нормалното – ще се изчака завършването на задачата.

### 90H (144) - СЕРВИЗНА ИНИЦИАЛИЗАЦИЯ НА ДАНЪЧНИЯ ТЕРМИНАЛ

**Област за данни:** `<Text>`  
**Отговор:** `<Resp>`

Данните от тази команда са предназначени за данъчния терминал – за конфигурирането му и за четене на данни от него. С помощта на командата се зареждат всички необходими за работата на вградения терминал данни. Принтерът извършва допълнителни действия само в следните случаи:

- Успешна регистрация и дерегистрация на принтера в НАП
- Успешна промяна на данни в НАП
- Успешна регистрация на сервизен договор

Командата е забранена преди фискализация на принтера.

Принтерът проверява състоянието на данъчния терминал и при фискализиран, но нерегистриран принтер не разрешава издаването на фискални бонове.

---

## ПРИЛОЖЕНИЕ 1 - НАБОР ОТ ЗНАЦИ НА ФИСКАЛНИЯ ПРИНТЕР

| | _0 | _1 | _2 | _3 | _4 | _5 | _6 | _7 | _8 | _9 | _A | _B | _C | _D | _E | _F |
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|
| **0_** | | | | 0 | @ | P | \` | p | А | Р | а | р | А | Р | а | р |
| **1_** | | ! | 1 | A | Q | a | q | Б | С | б | с | Б | С | б | с |
| **2_** | | " | 2 | B | R | b | r | В | Т | в | т | В | Т | в | т |
| **3_** | | # | 3 | C | S | c | s | Г | У | г | у | Г | У | г | у |
| **4_** | | $ | 4 | D | T | d | t | Д | Ф | д | ф | Д | Ф | д | ф |
| **5_** | | % | 5 | E | U | e | u | Е | Х | е | х | Е | Х | е | х |
| **6_** | | & | 6 | F | V | f | v | Ж | Ц | ж | ц | Ж | Ц | ж | ц |
| **7_** | | ' | 7 | G | W | g | w | З | Ч | з | ч | З | Ч | з | ч |
| **8_** | | ( | 8 | H | X | h | x | И | Ш | и | ш | И | Ш | и | ш |
| **9_** | | ) | 9 | I | Y | i | y | Й | Щ | й | щ | Й | Щ | й | щ |
| **A_** | | * | : | J | Z | j | z | К | Ъ | к | ъ | К | Ъ | к | ъ |
| **B_** | | + | ; | K | [ | k | { | Л | Ы | л | ы | Л | Ы | л | ы |
| **C_** | | , | < | L | \ | l | \| | М | Ь | м | ь | М | Ь | м | ь |
| **D_** | | - | = | M | ] | m | } | Н | Э | н | э | Н | Э | н | э |
| **E_** | | . | > | N | ^ | n | ~ | О | Ю | о | ю | О | Ю | о | ю |
| **F_** | | / | ? | O | _ | o | | П | Я | п | я | П | Я | п | я |

---

## ПРИЛОЖЕНИЕ 2 - СПИСЪК НА ФИСКАЛНИТЕ КОМАНДИ (ПО НАРАСТВАЩ НОМЕР)

| HEX | DEC | ФУНКЦИЯ |
|-----|-----|---------|
| 20h | (32) | Разширена информация за последната грешка |
| 21h | (33) | Изчистване на дисплея |
| 22h | (34) | Връщане или печат на информация за сервизен договор |
| 23h | (35) | Показване на текст на долния ред на дисплея |
| 24h | (36) | Настройка на LAN |
| 25h | (37) | Четене на данни за НАП |
| 26h | (38) | Отваряне на служебен бон |
| 27h | (39) | Затваряне на служебен бон |
| 29h | (41) | Запис на настройките и ключетата във flash-паметта |
| 2Ah | (42) | Печатане на свободен текст в служебен бон |
| 2Bh | (43) | Установяване на HEADER и FOOTER и опции на печат |
| 2Ch | (44) | Придвижване на хартията |
| 2Dh | (45) | Отрязване на хартията |
| 2Fh | (47) | Показване на текст на долния ред на дисплея |
| 30h | (48) | Отваряне на фискален (клиентски) бон |
| 31h | (49) | Регистриране на продажба |
| 32h | (50) | Данъчни ставки задавани през съответния период |
| 33h | (51) | Междинна сума |
| 34h | (52) | Регистриране на продажба и показване на дисплея |
| 35h | (53) | Изчисляване на сбор (Total) |
| 36h | (54) | Печатане на свободен текст във фискален бон |
| 38h | (56) | Затваряне на фискален бон |
| 39h | (57) | Информация за купувача в разширена касова бележка (фактура) |
| 3Ah | (58) | Продажба на програмиран артикул |
| 3Ch | (60) | Прекратяване (анулиране) на фискален бон |
| 3Dh | (61) | Установяване на дата и час |
| 3Еh | (62) | Прочитане на датата и часа |
| 3Fh | (63) | Показване на датата и часа на дисплея |
| 40h | (64) | Информация за последния фискален запис |
| 41h | (65) | Информация за сумите за деня |
| 42h | (66) | Задаване на допустим интервал номера на фактура |
| 44h | (68) | Брой свободни полета във фискалната памет |
| 45h | (69) | Дневен финансов отчет с или без нулиране |
| 46h | (70) | Служебно въвеждане или извеждане |
| 47h | (71) | Печат на диагностична информация |
| 48h | (72) | Фискализация |
| 49h | (73) | Детайлен отчет на фискалната памет по номер на запис |
| 4Ah | (74) | Получаване на статуса на принтера |
| 4Bh | (75) | Форсиране на подтиснат печат в бон |
| 4Ch | (76) | Статус на фискалната транзакция |
| 4Fh | (79) | Съкратен отчет на фискалната памет по дата на запис |
| 50h | (80) | Издаване на звуков сигнал |
| 51h | (81) | Получаване на напрежението и температурата на печатащата глава |
| 53h | (83) | Установяване на десетични знаци, валута и разрешени данъчни ставки |
| 54h | (84) | Печат на баркод |
| 55h | (85) | Задаване на име на допълнителните типове плащане |
| 56h | (86) | Прочитане на датата на последния фискален запис |
| 57h | (87) | Програмиране име на департамент |
| 58h | (88) | Получаване на натрупаните суми за департамент |
| 59h | (89) | Програмиране на производствената тестова област |
| 5Ah | (90) | Четене диагностична информация |
| 5Bh | (91) | Програмиране на индивидуален номер на принтера и номер на ФП |
| 5Ch | (92) | Печат на разделителна линия |
| 5Dh | (93) | Получаване на данни за отстъпките и надбавките за деня |
| 5Eh | (94) | Детайлен отчет на фискалната памет по дата на запис |
| 5Fh | (95) | Съкратен отчет на фискалната памет по номер на запис |
| 61h | (97) | Прочитане на данъчните ставки |
| 62h | (98) | Установяване на ЕИК |
| 63h | (99) | Прочитане на зададения ЕИК |
| 64h | (100) | Показване на свободен текст на дисплея |
| 65h | (101) | Задаване на операторска парола |
| 66h | (102) | Задаване на име на оператор |
| 67h | (103) | Информация за текущия бон |
| 69h | (105) | Отчет по оператори |
| 6Ah | (106) | Отваряне на чекмедже |
| 6Bh | (107) | Дефиниране и отчитане на артикули |
| 6Ch | (108) | Разширен дневен финансов отчет (с разпечатка на артикулите) |
| 6Dh | (109) | Печат на дублиращ бон |
| 6Еh | (110) | Допълнителна информация за деня |
| 6Fh | (111) | Отчет по артикули |
| 70h | (112) | Получаване на информация за оператор |
| 71h | (113) | Получаване номера на последния отпечатан документ |
| 72h | (114) | Получаване на информация за фискален запис или период |
| 73h | (115) | Програмиране на графично лого |
| 74h | (116) | Четене на блок от фискалната памет |
| 75h | (117) | Разширен дневен финансов отчет с печат на департаментите |
| 76h | (118) | Разширен дневен отчет с разпечатка на департаментите и артикулите |
| 77h | (119) | Поддръжка на КЛЕН – четене, печат и информация |
| 79h | (121) | Четене на блок от кодовата памет (фирмуера) |
| 7Ah | (122) | Отваряне на служебен бон със завъртян на 90 градуса текст |
| 7Bh | (123) | Печат на завъртян на 90 градуса текст |
| 7Ch | (124) | Затваряне на служебен бон със завъртян на 90 градуса текст |
| 80h | (128) | Сервизен ресет на оперативната памет |
| 85h | (133) | Временна сервизна забрана на печата |
| 86h | (134) | Сервизна поддръжка на КЛЕН |
| 87h | (135) | Тест на GPRS модема |
| 90h | (144) | Инициализация и четене на данни от данъчния терминал |

---

## Информация за документа

- **Производител:** DATECS
- **Модели:** FP-800, FP-2000, FP-650, SK1-21F, SK1-31F, FMP-10, FP-550
- **Версия на протокола:** 1.00BG
- **Автор:** Rossen Varbanov
- **Дата на създаване:** 9 януари 2019
- **Последна актуализация:** Добавено съдържание от допълнителни PDF страници
