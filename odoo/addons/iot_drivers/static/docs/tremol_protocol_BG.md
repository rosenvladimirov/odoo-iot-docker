# Комуникационен Протокол Tremol
**Версия: 1910211454**

---

## Съдържание

### История на промените (Change LOG)
- [version 1811201459](#version-1811201459)
- [version 1812051456](#version-1812051456)
- [version 1812171521](#version-1812171521)
- [version 1812201208](#version-1812201208)
- [version 1901101636](#version-1901101636)
- [version 1901311135](#version-1901311135)
- [version 1902191535](#version-1902191535)
- [version 1903211145](#version-1903211145)
- [version 1904091202](#version-1904091202)
- [version 1905071026](#version-1905071026)
- [version 1906120933](#version-1906120933)
- [version 1907251601](#version-1907251601)
- [version 1908131009](#version-1908131009)
- [version 1910211454](#version-1910211454)

### 1. КОМУНИКАЦИОНЕН ПРОТОКОЛ
- [1.1. Формат на съобщенията от софтуерното приложение към ФУ](#11-формат-на-съобщенията-от-софтуерното-приложение-към-фу)
- [1.2. Формат на съобщенията от ФУ към софтуерното приложение](#12-формат-на-съобщенията-от-фу-към-софтуерното-приложение)
- [1.3. Кратки съобщения за проверка на статуса на ФУ](#13-кратки-съобщения-за-проверка-на-статуса-на-фу)

### 2. ОПИСАНИЕ НА КОМАНДИТЕ
- [2.1. Формат и представяне на командите](#21-формат-и-представяне-на-командите)
- [2.2. Общи команди](#22-общи-команди)
- [2.3. Фискални команди](#23-фискални-команди)
- [2.4. Програмиращи команди](#24-програмиращи-команди)
- [2.5. Команди за четене на данни](#25-команди-за-четене-на-данни)
- [2.6. Команди за операции с касови бележки](#26-команди-за-операции-с-касови-бележки)
- [2.7. Команди за четене на данни в регистрите на ФУ](#27-команди-за-четене-на-данни-в-регистрите-на-фу)
- [2.8. Команди за печат на отчети](#28-команди-за-печат-на-отчети)
- [2.9. Команди за четене на отчети](#29-команди-за-четене-на-отчети)
- [2.10. Команди за мрежови настройки](#210-команди-за-мрежови-настройки)

### 3. ИЗИСКВАНИЯ КЪМ СОФТУЕРНОТО ПРИЛОЖЕНИЕ
- [3.1. Правила за използване на командите](#31-правила-за-използване-на-командите)
- [3.2. Примерна продажбена транзакция на ФУ](#32-примерна-продажбена-транзакция-на-фу)

### 4. СПОМАГАТЕЛЕН GS ПРОТОКОЛ (КОМАНДИ 1Dh)

---

## История на промените (Change LOG)

### version 1811201459
- Променено име на zfpdef от `OpenCreditNoteFromFDCustomerDB()` на `OpenCreditNoteWithFreeCustomerData()`
- Променено име на zfpdef от `OpenInvoiceFromFDCustomerDB()` на `OpenInvoiceWithFDCustomerDB()`

### version 1812051456
- Параметър OptionVATClass: добавена нова опция '*' – Забранено
- Команда със zfpdef `ReadCurrentReceiptInfo`: променени стойности на параметър VATinReceipt от – 0 – Да, 1 – Не на – 1 – Да, 0 - Не
- Команда със zfpdef `Payment`: променен разделител преди параметър OptionChangeType от '*' на ';'

### version 1812171521
Няма промени в протокола

### version 1812201208
Добавена команда със zfpdef: `ReadSentRcpInfoStatus` за четене на номера и дата/час на последната изпратена и първата неизпратена бележка.

### version 1901101636
- Премахнато URN входно поле от командите със zfpdefs: `OpenStornoReceipt`, `OpenCreditNoteWithFreeCustomerData`, `OpenCreditNoteWithFDCustomerDB`
- Добавена команда за четене на QR код данни в последната издадена бележка със zfpdef: `ReadLastReceiptQRcodeData`

### version 1901311135
Добавени команди за KL устройства V2 със zfpdefs:
- `ProgPayment_Old`
- `ReadPayments_Old`
- `ReadDailyAvailableAmounts_Old`
- `ReadDailyRA_Old`
- `ReadDailyPO_Old`
- `ReadDailyReceivedSalesAmounts_Old`
- `ReadDailyReturnedChangeAmounts_Old`
- `ReadDailyRAbyOperator_Old`
- `ReadDailyPObyOperator_Old`
- `ReadDailyReceivedSalesAmountsByOperator_Old`
- `ReadDailyReturnedChangeAmountsByOperator_Old`

Команда със zfpdef: `OpenStornoReceipt` от параметър StornoReason е премахната опция 2 – Данъчно облекчение

Команди със zfpdefs: `OpenCreditNoteWithFreeCustomerData` и `OpenCreditNoteWithFDCustomerDB`, параметър StornoReason е hardcoded със стойност '2' – данъчно облекчение

Команда със zfpdef: `ReceivedOnAccount_PaidOut` Дължина на параметър OperPass е променена от 4 символа на 6 символа.

Команда със zfpdef: `ReadCurrentReceiptInfo()` променени позиции на параметри SubtotalAmountVAT4, SubtotalAmountVAT5, SubtotalAmountVAT6, SubtotalAmountVAT7.

### version 1902191535
- Добавен допълнителен формат на отговор на съобщение в точка 1.3
- Добавен параметър за печат на наличност RA/PO в команда ReceivedOnAccount, име на параметър PrintAvailability.

### version 1903211145
Команди със zfpdefs: `SetDateTime(DateTime)`, `OpenStornoReceipt()`, `OpenCreditNoteWithFreeCustomerData()`, `OpenCreditNoteWithFDCustomerDB()` са с добавени секунди в свързаните параметри. Това няма да обърка работния процес с V2 устройства!

Команда със zfpdef: `OpenStornoReceipt` от параметър StornoReason е добавена опция 2 – Данъчно облекчение

Команди със zfpdefs: `OpenCreditNoteWithFreeCustomerData` и `OpenCreditNoteWithFDCustomerDB`, параметър StornoReason е с добавени стойности на опции:
- '0' – Грешка на оператора
- '1' – Рекламация или връщане на стока

### version 1904091202
Добавени нови команди със zfpdefs за отваряне на всички типове бележки в електронен формат:
- `OpenElectronicReceipt()`
- `OpenElectronicStornoReceipt()`
- `OpenElectronicInvoiceWithFreeCustomerData()`
- `OpenElectronicCreditNoteWithFreeCustomerData()`
- `OpenElectronicInvoiceWithFDCustomerDB()`
- `OpenElectronicCreditNoteWithFDCustomerDB()`

Добавена нова команда със zfpdef: `ReadReceiptNumQRcodeData()` за четене на QR код данни на определен номер бележка

### version 1905071026
Команди със zfpdefs: `ProgPayment()`, `ProgPayment_Old()`, `ReadPayments()`, `ReadPayments_Old()`, параметри ExchangeRate и Rate са с променена дължина от 10 на 1..10.

Добавена нова команда със zfpdef: `ReadElectronicReceiptNumDataFromEJ`

### version 1906120933
Команда със zfpdef: `ReadElectronicReceiptNumDataFromEJ()` е преименувана на `ReadElectronicReceiptDataFromEJ()`

### version 1907251601
Добавени нови команди със zfpdef за четене на електронни бележки с техния QR код в различни формати:
- `ReadElectronicReceipt_QR_Data()`
- `ReadElectronicReceipt_QR_ASCII()`
- `ReadElectronicReceipt_QR_BMP()`

### version 1908131009
- Редактирана команда `ReadLastDailyReportInfo()` параметър LastReceiptType
- Премахнати команди за отваряне на електронни сторно и кредитни бележки.

### version 1910211454
Няма промени в протокола.

---

## 1. КОМУНИКАЦИОНЕН ПРОТОКОЛ

Типът на протокола е **Master / Slave**. Комуникационната сесия винаги се инициира от Приложния софтуер. ФУ изпълнява командите, изпратени от софтуерното приложение и предоставя обратна връзка в зависимост от резултата. ФУ връща "Потвърдителен отговор" или "съобщение отговор". Всички съобщения на протокола са или пакетирани, или еднобайтови. ФУ поддържа комуникационен стандарт RS232, USB, BT, TCP (WiFi, LAN).

### Параметри за настройка на сериен порт:
- **Скорост**: 115200 bit/s (или 19200, 38400, 57600 и 9600 ако такава е зададена за ФУ)
- **8 бита дума**
- **Без паритет**
- **1 стоп бит**

### Параметри за настройка на TCP:
- **Порт**: Винаги 8000
- **Парола**: Изпраща се директно към отворен socket с 0Ah(LF) за край.
  - Пример: ако паролата е 1234, когато се отвори TCP socket изпраща `0x31 0x32 0x33 0x34 0x0A`

### 1.1. ФОРМАТ НА СЪОБЩЕНИЯТА ОТ СОФТУЕРНОТО ПРИЛОЖЕНИЕ КЪМ ФУ

Всички съобщения освен описаните в раздел 4, изпратени до ФУ от PC имат следната структура:

```
<STX><LEN><NBL><CMD><DATA…DATA><CS><CS><ETX>
```

| Поле | Брой байтове | Стойност |
|------|--------------|----------|
| STX | 1 | Начало на съобщение – винаги 02h |
| LEN | 1 | Дължина на съобщението (брой байтове включващи LEN, NBL, CMD, DATA) увеличена с 20h т.е. число в диапазона 20h - 9Fh |
| NBL | 1 | Номер на съобщението увеличен с 20h т.е. число в диапазона 20h - 9Fh |
| CMD | 1 | Команда - число в диапазона 20h - 7Fh (виж описание на командите) |
| DATA..DATA | 0 - 3902 | Допълнителни данни – група от полета с данни разделени със символите ';', даващи допълнителна информация необходима за изпълнение на командата (виж описание на командите) |
| CS CS | 2 | Контролна сума, изчислена по следния начин:<br>1) Операция XOR на всички байтове от LEN до DATA включително = 0 .. FFh<br>2) Конвертиране в 2 байта чрез добавяне на 30h, например: B5h -> 3Bh 35h |
| ETX | 1 | Край на съобщение – винаги 0Ah (LF) |

Текстовите данни на съобщението се изпращат като ASCII текст с кодова таблица **cp1251 (Windows 1251)**.

### 1.2. ФОРМАТ НА СЪОБЩЕНИЯТА ОТ ФУ КЪМ СОФТУЕРНОТО ПРИЛОЖЕНИЕ

Има няколко типа отговори в зависимост от получените съобщения.

#### 1.2.1. Потвърдителен отговор

**Положителен потвърдителен отговор** – когато форматът на пакета е правилен. Изпраща се когато командата е разпозната, както и когато е отхвърлена (грешки в изпратените данни (поле `<DATA…DATA>`) или командата не може да бъде изпълнена или командата е неразрешена в зависимост от текущото състояние на ФУ, посочено от двата байта за състояние). Това е пакетно съобщение със следния формат:

```
<ACK><NBL><STE><STE><CS><CS><ETX>
```

| Поле | Брой байтове | Стойност |
|------|--------------|----------|
| ACK | 1 | 06h |
| NBL | 1 | № на съобщение = NBL на съобщението свързано с получаването |
| STE STE | 2 | 2 байта за състояние на грешка. Двуцифрено ASCII число. (виж Таблица Грешки) |
| CS CS | 2 | Контролна сума, изчислена по следния начин:<br>1) Операция XOR на NBL STE и STE = 00h .. FFh<br>2) Конвертиране в 2 байта чрез добавяне на 30h, например: B5h -> 3Bh 35h |
| ETX | 1 | 0Ah (LF) |

Двата байта за състояние са двуцифрено ASCII число, в което първата цифра предоставя информация за грешката във ФУ, а втората – за грешка в командата.

#### Таблица Грешки:

| Стойност на байт | Грешки във ФУ | Стойност на байт | Грешки в командата |
|------------------|---------------|------------------|--------------------|
| 30 | OK | 30 | OK |
| 31 | Няма хартия, повреда на принтера | 31 | Невалидна команда |
| 32 | Препълване на регистри | 32 | Неразрешена команда |
| 33 | Повреда на часовника или неправилна дата и час | 33 | Дневният отчет Z не е нулев |
| 34 | Отворена фискална бележка | 34 | Синтактична грешка |
| 35 | Остатък от плащане по сметка | 35 | Препълване на входни регистри |
| 36 | Отворена нефискална бележка | 36 | Нулеви входни регистри |
| 37 | Регистрирано плащане, но бележката не е затворена | 37 | Недостъпна транзакция за корекция |
| 38 | Повреда на фискалната памет | 38 | Недостатъчна сума в наличност |
| 39 | - | 39 | Неправилна парола |
| 3a | Липсващ външен дисплей | - | - |
| 3b | 24 часов блок – липсва Z отчет | - | - |
| 3c | Прегрята печатаща глава на принтера | - | - |
| 3d | Прекъсване на захранването във фискална бележка (еднократно докато се прочете състоянието) | - | - |
| 3e | Препълване на ЕД | - | - |
| 3f | Недостатъчни условия | - | - |

Двуцифреното число се съставя в зависимост от типа на грешката.

**Пример**: Грешка 32 – Неразрешена команда поради повреда на часовника

**Отрицателен потвърдителен отговор** – Изпраща се, когато форматът на пакета е неправилен. Това е 1-байт `NACK = 15h` без контролна сума.

**Искане за повторение** – Изпраща се, когато ФУ е заето с изпълнението на предходната команда. Това е 1 байт `RETRY = 0Eh` без контролна сума.

#### 1.2.2. Съобщение отговор

Има формата на пакетното съобщение, изпратено от СП към ФУ (виж 3.1.), но се връща от ФУ към СП и съдържа информация – отговор на заявката (виж описание на командите).

### 1.3. КРАТКИ СЪОБЩЕНИЯ ЗА ПРОВЕРКА НА СТАТУСА НА ФУ

Протоколът за обмен включва два непакетирани еднобайтови кода за проверка на статуса на ФУ, които могат бързо да определят състоянието на устройството. Двата кода и тяхното значение са показани в таблицата по-долу:

| Заявка СП | Отговор ФУ | Значение |
|-----------|------------|----------|
| 04 | 04 | ФУ е включено |
| 09 | 40 (Bit.0) | ФУ е ГОТОВО |
| | 41 | ФУ е заето |
| | 42 (Bit.1) | ФУ няма хартия |
| | 43 | ФУ няма хартия и е заето |
| | 44 (Bit.2) | Принтерът на ФУ е прегрят |
| | 45 | Принтерът на ФУ е прегрят и е заето |
| | 48 (Bit.3) | ФУ липсващ външен дисплей |
| | 49 | ФУ липсващ външен дисплей и е заето |
| | 50 | ФУ очаква парола (само LAN или WiFi връзка) |
| | 60 | ФУ вече е заето с друга връзка (само LAN или WiFi връзка) |
| | 70 | Грешна парола (само LAN или WiFi връзка) |

---

## 2. ОПИСАНИЕ НА КОМАНДИТЕ

### 2.1. ФОРМАТ И ПРЕДСТАВЯНЕ НА КОМАНДИТЕ

Всички команди се описват и представят с помощта на следните термини и символи:

#### Ключови термини:

- **Команда** – стойността на полето CMD на съобщението, изпратено от софтуерното приложение и в съобщението отговор на ФУ.
- **вход** – структура на полетата, включени в полето DATA на съобщението, изпратено от софтуерното приложение.
- **изход** – за всяка команда може да бъде едно от следните:
  - Потвърдителен отговор.
  - Структура на полетата, включени в полето DATA на съобщението отговор, изпратено от ФУ.
- **Входни данни** – описание на съдържанието на полетата "вход".
- **Изходни данни** – описание на съдържанието на полетата "изход".

#### Ключови символи:

- `' '` – задължителен символ
- `" "` – задължителен формат DateTime
- `< >` – задължително поле с данни
- `<;>` – разделител на полета
- `[ ]` – дължина на поле
- `{ }` – незадължително поле с данни
- **zfpdef:** - име на функция в генерирания изходен код и име на файл на файловия сървър

#### Общи правила:

- **Формат на полето цена/стойност** – от 1 до 10 символа, число с плаваща десетична точка, предшествано от +, - или ИНТЕРВАЛ.
  - Примери: -12.34 +56.7 8

- **Формат на полето количество** – от 1 до 10 символа, число с плаваща десетична точка, до три цифри след десетичната точка.
  - Примери: 1.234 56.78 9

- **Формат на полето процент** – от 2 до 7 символа, число с плаваща десетична точка, до две цифри след десетичната точка, предшествано от символа за процент - %.
  - Примери: -12.34% +5.67% 8.9% 10%

**Номер на плащане 0** съответства на основното плащане – В БРОЙ, номер на плащане **11** съответства на специалното валутно плащане - ДДС сметка.

---

## 2.2. ОБЩИ КОМАНДИ

Това са команди за общите функции на ФУ, свързани с получаване на диагностична информация и директен достъп до някои от функциите на устройството (подаване на хартия, рязане на хартия и визуализация на дисплея).

### 2.2.1. Команда: 20h / SP - Статус

**вход**: няма

**изход**: `<StatusBytes[7]>`

**Операция на ФПУ**: Предоставя подробна 7-байтова информация за текущото състояние на фискалния принтер.

**Входни данни**: няма

**Изходни данни**:

| N байт | N бит | Флаг за състояние |
|--------|-------|-------------------|
| **ST0** | 0 | ФП само за четене |
| | 1 | Спиране на захранването при отворена фискална бележка |
| | 2 | Принтерът не е готов - прегряване |
| | 3 | Дата и час не са зададени |
| | 4 | Грешна дата и час |
| | 5 | Нулиране на RAM |
| | 6 | Грешка в хардуерния часовник |
| | 7 | 1 |
| **ST1** | 0 | Принтерът не е готов - няма хартия |
| | 1 | Препълване на регистрите на отчетите |
| | 2 | Клиентският отчет не е нулиран |
| | 3 | Дневният отчет не е нулиран |
| | 4 | Артикулният отчет не е нулиран |
| | 5 | Операторският отчет не е нулиран |
| | 6 | Отпечатан дубликат |
| | 7 | 1 |
| **ST2** | 0 | Отворена нефискална бележка |
| | 1 | Отворена фискална бележка |
| | 2 | Отворена подробна фискална бележка |
| | 3 | Отворена фискална бележка с ДДС |
| | 4 | Отворена фактурна фискална бележка |
| | 5 | SD картата е почти пълна |
| | 6 | SD картата е пълна |
| | 7 | 1 |
| **ST3** | 0 | Няма ФП модул |
| | 1 | Грешка във ФП |
| | 2 | ФП е пълна |
| | 3 | ФП е почти пълна |
| | 4 | Десетична точка (1=дробно, 0=цяло) |
| | 5 | ФП е фискализирана |
| | 6 | ФП е произведена |
| | 7 | 1 |
| **ST4** | 0 | Принтер: автоматично рязане |
| | 1 | Външен дисплей: прозрачен дисплей |
| | 2 | Скоростта е 9600 |
| | 3 | резерв |
| | 4 | Чекмедже: автоматично отваряне |
| | 5 | Логото на клиента е включено в бележката |
| | 6 | резерв |
| | 7 | 1 |
| **ST5** | 0 | Грешна SIM карта |
| | 1 | Блокиране 3 дни без мобилен оператор |
| | 2 | Няма задача от НАП |
| | 3 | резервирано |
| | 4 | резервирано |
| | 5 | Грешна SD карта |
| | 6 | Дерегистриран |
| | 7 | 1 |
| **ST6** | 0 | Няма SIM карта |
| | 1 | Няма GPRS модем |
| | 2 | Няма мобилен оператор |
| | 3 | Няма GPRS услуга |
| | 4 | Близък край на хартията |
| | 5 | Неизпратени данни за 24 часа |
| | 6 | резервирано |
| | 7 | 1 |

**zfpdef**: `ReadStatus()`

### 2.2.2. Команда: 21h / ! – Версия

**вход**: няма

**изход**: `<DeviceType[1..2]>` `<;>` `<CertificateNum[6]>` `<;>` `<CertificateDateTime "DD-MM-YYYY HH:MM">` `<;>` `<Model[50]>` `<;>` `<Version[20]>`

**Операция на ФПУ**: Предоставя информация за типа на устройството, номер на сертификата, дата и час на сертификата и модел на устройството.

**Входни данни**: няма

**Изходни данни**:

- **DeviceType**: 1 или 2 символа за тип на фискално устройство:
  - '1' – ЕКР
  - '11' – ЕКР за онлайн магазин
  - '2' – ФПр
  - '21' – ФПр за онлайн магазин
  - '3' – Гориво
  - '31' – Горивна система
  - '5' – за FUVAS устройство
- **CertificateNum**: 6 символа за номер на сертификация на модела на устройството
- **CertificateDateTime**: 16 символа за дата и час на сертификата във формат: DD-MM-YYYY HH:MM
- **Model**: До 50 символа за име на модела
- **Version**: До 20 символа за име на версията и контролна сума

**zfpdef**: `ReadVersion()`

### 2.2.3. Команда: 22h / " – Диагностика

**вход**: няма

**изход**: ACK

**Операция на ФПУ**: Отпечатва диагностична бележка.

**Входни данни**: няма

**Изходни данни**: няма

**zfpdef**: `PrintDiagnostics()`

### 2.2.4. Команда: 24h / $ – Изчистване на дисплея

**вход**: няма

**изход**: ACK

**Операция на ФПУ**: Изчиства външния дисплей.

**Входни данни**: няма

**Изходни данни**: няма

**zfpdef**: `ClearDisplay()`

### 2.2.5. Команда: 25h / % – Показване на текст на ред 1 на дисплея

**вход**: `<Text[20]>`

**изход**: ACK

**Операция на ФПУ**: Показва 20-символен текст в горния ред на външния дисплей.

**Входни данни**:
- **Text**: 20 символа текст

**Изходни данни**: няма

**zfpdef**: `DisplayTextLine1(Text)`

### 2.2.6. Команда: 26h / & – Показване на текст на ред 2 на дисплея

**вход**: `<Text[20]>`

**изход**: ACK

**Операция на ФПУ**: Показва 20-символен текст в долния ред на външния дисплей.

**Входни данни**:
- **Text**: 20 символа текст

**Изходни данни**: няма

**zfpdef**: `DisplayTextLine2(Text)`

### 2.2.7. Команда: 27h / ' – Показване на текст на редове 1 и 2 на дисплея

**вход**: `<Text[40]>`

**изход**: ACK

**Операция на ФПУ**: Показва 20-символен текст в първия ред и последните 20 символа текст във втория ред на външните дисплейни редове.

**Входни данни**:
- **Text**: 40 символа текст

**Изходни данни**: няма

**zfpdef**: `DisplayTextLines1and2(Text)`

### 2.2.8. Команда: 28h / ( – Показване на дата и час на дисплея

**вход**: няма

**изход**: ACK

**Операция на ФПУ**: Показва текущата дата и час на външния дисплей.

**Входни данни**: няма

**Изходни данни**: няма

**zfpdef**: `DisplayDateTime()`

### 2.2.9. Команда: 29h / ) – Рязане на хартия, само за ФП

**вход**: няма

**изход**: ACK

**Операция на ФПУ**: Стартира резачката за хартия. Командата работи само на фискални принтерни устройства.

**Входни данни**: няма

**Изходни данни**: няма

**zfpdef**: `CutPaper()`

### 2.2.10. Команда: 2Ah / * – Отваряне на касово чекмедже

**вход**: няма

**изход**: ACK

**Операция на ФПУ**: Отваря касовото чекмедже.

**Входни данни**: няма

**Изходни данни**: няма

**zfpdef**: `CashDrawerOpen()`

### 2.2.11. Команда: 2Bh / + – Подаване на хартия

**вход**: няма

**изход**: ACK

**Операция на ФПУ**: Подава един ред хартия.

**Входни данни**: няма

**Изходни данни**: няма

**zfpdef**: `PaperFeed()`

---

## 2.3. ФИСКАЛНИ КОМАНДИ

Това са команди, изискващи записване на данни във фискалната памет на устройството. Изисква се достъп с парола.

### 2.3.1.1. Команда: 56h / V – Задаване на тип на фискално устройство, Опция T

**вход**: `<'T'>` `<;>` `<FDType[1]>` `<;>` `<Password[3]>`

**изход**: ACK

**Операция на ФПУ**: Дефинира типа на фискалното устройство. Командата е разрешена само в нефискален режим, преди фискализация и след дерегистрация преди следващата фискализация. Типът на устройството може да се прочете с команда Версия 0x21.

**Входни данни**:
- **'T'**: 1 символ за опция 'T'
- **FDType**: 1 символ за тип на фискално устройство със стойност:
  - '0' - ФПр за Гориво тип 3
  - '1' – Основен ФПр за Горивна система тип 31
  - '2' - ЕКР за онлайн магазин тип 11
  - '3' - ФПр за онлайн магазин тип 21
  - '*' – възстановяване на типа по подразбиране
- **Password**: 3-символен низ

**Изходни данни**: няма

**zfpdef**: `SetFiscalDeviceType(FDType, Password)`

### 2.3.1.2. Команда: 41h / A – Задаване на информация за ЕИК на клиента, Опция 1

**вход**: `<Password[6]>` `<;>` `<'1'>` `<;>` `<UIC[13]>` `<;>` `<UICType[1]>`

**изход**: ACK

**Операция на ФПУ**: Записва Единния идентификационен код (ЕИК) и типа ЕИК в оперативната памет.

**Входни данни**:
- **Password**: 6-символен низ
- **'1'**: Един символ със стойност 1
- **UIC**: 13 символа за ЕИК
- **UICType**: 1 символ за тип на номер ЕИК:
  - '0' - Булстат
  - '1' - ЕГН
  - '2' – Номер на чужденец
  - '3' – Служебен номер на НАП

**Изходни данни**: няма

**zfpdef**: `SetCustomerUIC(Password, UIC, UICType)`

### 2.3.1.3. Команда: 41h / A – Потвърждаване на фискализация, Опция 2

**вход**: `<Password[6]>` `<;>` `<'2'>`

**изход**: ACK

**Операция на ФПУ**: Потвърждава Единния идентификационен код (ЕИК) и типа ЕИК в оперативната памет.

**Входни данни**:
- **Password**: 6-символен низ
- **'2'**: Един символ със стойност '2'

**Изходни данни**: няма

**zfpdef**: `ConfirmFiscalization(Password)`

### 2.3.2. Команда: 42h / B – Промяна на ДДС ставки

**вход**: `<Password[6]>` `<;>` `<VATrate0[6]>` `<;>` `<VATrate1[6]>` `<;>` `<VATrate2[6]>` `<;>` `<VATrate3[6]>` `<;>` `<VATrate4[6]>` `<;>` `<VATrate5[6]>` `<;>` `<VATrate6[6]>` `<;>` `<VATrate7[6]>`

**изход**: ACK

**Операция на ФПУ**: Записва блок, съдържащ стойностите на ДДС ставките във фискалната памет. Отпечатва стойностите на принтера.

**Входни данни**:
- **Password**: 6-символен низ
- **VATrate0**: Стойност на ДДС ставка А от 6 символа във формат ##.##
- **VATrate1**: Стойност на ДДС ставка Б от 6 символа във формат ##.##
- **VATrate2**: Стойност на ДДС ставка В от 6 символа във формат ##.##
- **VATrate3**: Стойност на ДДС ставка Г от 6 символа във формат ##.##
- **VATrate4**: Стойност на ДДС ставка Д от 6 символа във формат ##.##
- **VATrate5**: Стойност на ДДС ставка Е от 6 символа във формат ##.##
- **VATrate6**: Стойност на ДДС ставка Ж от 6 символа във формат ##.##
- **VATrate7**: Стойност на ДДС ставка З от 6 символа във формат ##.##

**Изходни данни**: няма

**zfpdef**: `ProgVATrates(Password, VATrate0, VATrate1, VATrate2, VATrate3, VATrate4, VATrate5, VATrate6, VATrate7)`

### 2.3.3. Команда: 43h / C – Промяна на позицията на десетичната точка

**вход**: `<Password[6]>` `<;>` `<DecimalPointPosition[1]>`

**изход**: ACK

**Операция на ФПУ**: Записва блок, съдържащ формата на числата във фискалната памет. Отпечатва текущото състояние на принтера.

**Входни данни**:
- **Password**: 6-символен низ
- **DecimalPointPosition**: 1 символ със стойности:
  - '0'- Цели числа
  - '2' - Дроби

**Изходни данни**: няма

**zfpdef**: `ProgDecimalPointPosition(Password, DecimalPointPosition)`

---

## 2.4. ПРОГРАМИРАЩИ КОМАНДИ

Набор от команди за програмиране на конфигурацията на ФУ според изискванията на POS и нуждите на потребителя.

### 2.4.1. Команда: 44h / D – Програмиране на видове плащане

**вход**: `<PaymentNum[1..2]>` `<;>` `<Name[10]>` `{` `<;>` `<Rate[1..10]>` `}`

**изход**: ACK

**Операция на ФПУ**: Предварително програмира името на вида плащане.

**Входни данни**:
- **PaymentNum** (Видове плащане): 1 символ за вид плащане:
  - '9' – Плащане 9
  - '10' – Плащане 10
  - '11' – Плащане 11
- **Name**: 10 символа за име на вида плащане
- **Rate** (Обменен курс): До 10 символа за обменен курс във формат: ####.##### на 11-ия вид плащане, максимална стойност 0420.00000

**Изходни данни**: няма

**zfpdef**: `ProgPayment(PaymentNum, Name, PaymentRate)`

### 2.4.2. Команда: 44h / D – Програмиране на видове плащане, KL

**вход**: `<Number[1]>` `<;>` `<Name[10]>` `{` `<;>` `<Rate[1..10]>` `<;>` `<CodePayment[1]>` `}`

**изход**: ACK

**Операция на ФПУ**: Предварително програмира името на вида плащане. Командата работи за устройства KL версия 2.

**Входни данни**:
- **Number**: 1 символ за вид плащане:
  - '1' – Плащане 1
  - '2' – Плащане 2
  - '3' – Плащане 3
  - '4' – Плащане 4
- **Name**: 10 символа за име на вида плащане
- **Rate** (Обменен курс): До 10 символа за обменен курс във формат: ####.##### на 4-ия вид плащане, максимална стойност 0420.00000
- **CodePayment**: 1 символ за код на вида плащане с име:
  - '1' – Чек
  - '2' – Талон
  - '3' – В. Талон
  - '4' – Опаковка
  - '5' – Услуга
  - '6' – Повреда
  - '7' – Карта
  - '8' – Банка
  - '9' – Програмиране Име1
  - ':' – Програмиране Име2

**Изходни данни**: няма

**Забележка**: За вид плащане 4 не може да се избере код на вида плащане

**zfpdef**: `ProgPayment_Old(Number, Name, PaymentRate, CodePayment)`

### 2.4.3. Команда: 45h / E – Програмиране на параметри

**вход**: `<POSNum[4]>` `<;>` `<PrintLogo[1]>` `<;>` `<AutoOpenDrawer[1]>` `<;>` `<AutoCut[1]>` `<;>` `<ExternalDispManagement[1]>` `<;>` `<ArticleReportType[1]>` `<;>` `<EnableCurrency[1]>` `<;>` `<EJFontType[1]>` `<;>` `<reserved['0']>` `<;>` `<WorkOperatorCount[1]>`

**изход**: ACK

**Операция на ФПУ**: Програмира номера на POS, печат на лого, отваряне на касово чекмедже, разрешение за рязане, режим на управление на външния дисплей, тип артикулен отчет, активиране или деактивиране на валута в бележката, тип шрифт на ЕД и брояч на работещите оператори.

**Входни данни**:
- **POSNum** (Номер на POS): 4 символа за номер на POS във формат ####
- **PrintLogo** (Печат на лого): 1 символ със стойност:
  - '1' - Да
  - '0' - Не
- **AutoOpenDrawer** (Автоматично отваряне на чекмедже): 1 символ със стойност:
  - '1' - Да
  - '0' - Не
- **AutoCut** (Автоматично рязане): 1 символ със стойност:
  - '1' - Да
  - '0' - Не
- **ExternalDispManagement** (Управление на външен дисплей): 1 символ със стойност:
  - '1' - Ръчно
  - '0' - Автоматично
- **ArticleReportType** (Артикулен отчет): 1 символ със стойност:
  - '1' - Подробен
  - '0' - Кратък
- **EnableCurrency** (Активиране на валута): 1 символ със стойност:
  - '1' – Да
  - '0' – Не
- **EJFontType** (Шрифт на ЕД): 1 символ със стойност:
  - '1' - Нисък шрифт
  - '0' - Нормален шрифт
- **reserved**: 1 символ резервиран '0'
- **WorkOperatorCount** (Брой работещи оператори): 1 символ със стойност:
  - '1' - Един
  - '0' - Повече

**Изходни данни**: няма

**Забележки**:
Логото е графичен файл в BMP формат с размери 384x80 / 448 Х 160 / 576x80 точки, който се отпечатва в началото на всяка бележка.

"ExternalDispManagement" е режим, в който ФУ не изпраща информация към дисплея освен при изпълнение на командите 25h, 26h и 27h. Когато този режим е изключен, ФУ "използва" дисплея за показване на данни по време на продажби, при финализиране на бележката и т.н.

**zfpdef**: `ProgParameters(POSNum, PrintLogo, AutoOpenDrawer, AutoCut, ExternalDispManagement, EJFormat, ArticleRepType, EnableCurrency, EJFontType, WorkOperatorCount)`

### 2.4.4. Команда: 47h / G – Програмиране на отдел

**вход**: `<Number[2]>` `<;>` `<Name[20]>` `<;>` `<OptionVATClass[1]>` `{` `<;>` `<Price[1..10]>` `<;>` `<OptionDepPrice[1]>` `<;>` `<AdditionalName[14]>` `}`

**изход**: ACK

**Операция на ФПУ**: Задава данни за състоянието на отделния номер от вътрешната база данни на ФУ. Параметрите Price, OptionDepPrice и AdditionalName не са задължителни и изискват предходния незадължителен параметър.

**Входни данни**:
- **Number**: 2 символа номер на отдел във формат ##
- **Name**: 20 символа име на отдел
- **OptionVATClass**: 1 символ за ДДС клас:
  - 'А' – ДДС клас 0
  - 'Б' – ДДС клас 1
  - 'В' – ДДС клас 2
  - 'Г' – ДДС клас 3
  - 'Д' – ДДС клас 4
  - 'Е' – ДДС клас 5
  - 'Ж' – ДДС клас 6
  - 'З' – ДДС клас 7
  - '*' - Забранено
- **Price**: До 10 символа за цена на отдела
- **OptionDepPrice**: 1 символ за флагове на цената на отдела със следната стойност:
  - '0' - Свободна цена деактивирана
  - '1' - Свободна цена активирана
  - '2' - Ограничена цена
  - '4' - Свободна цена деактивирана за единична транзакция
  - '5' - Свободна цена активирана за единична транзакция
  - '6' - Ограничена цена за единична транзакция
- **AdditionalName**: 14 символа допълнително име на отдел

**Изходни данни**: няма

**Забележка**:
При промяна на ДДС групата на отдела трябва да се актуализират ДДС групите на всички артикули, свързани с този отдел. В противен случай те няма да бъдат достъпни за продажба.

**zfpdef**: `ProgDepartment(Number, Name, OptionVATClass, Price, OptionDepPrice, AdditionalName)`

### 2.4.5. Команда: 48h / H – Програмиране на дата и час

**вход**: `<DateTime "DD-MM-YY HH:MM:SS">`

**изход**: ACK

**Операция на ФПУ**: Задава датата и часа и отпечатва текущите стойности.

**Входни данни**:
- **DateTime**: Параметър дата час във формат: DD-MM-YY HH:MM:SS

**Изходни данни**: няма

**zfpdef**: `SetDateTime(DateTime)`

### 2.4.6. Команда: 49h / I – Програмиране на поздравително съобщение на дисплея

**вход**: `<'0'>` `<;>` `<DisplayGreetingText[20]>`

**изход**: ACK

**Операция на ФПУ**: Програмира съдържанието на поздравително съобщение на дисплея.

**Входни данни**:
- **'0'**: 1 символ със стойност '0'
- **DisplayGreetingText**: 20 символа за поздравително съобщение на дисплея

**Изходни данни**: няма

**zfpdef**: `ProgDisplayGreetingMessage(DisplayGreetingText)`

### 2.4.7. Команда: 49h / I – Програмиране на заглавни редове

**вход**: `<OptionHeaderLine[1]>` `<;>` `<HeaderText[TextLength]>`

**изход**: ACK

**Операция на ФПУ**: Програмира съдържанието на заглавните редове.

**Входни данни**:
- **OptionHeaderLine** (Номер на ред): 1 символ със стойност:
  - '1' – Заглавие 1
  - '2' – Заглавие 2
  - '3' – Заглавие 3
  - '4' – Заглавие 4
  - '5' – Заглавие 5
  - '6' – Заглавие 6
  - '7' – Заглавие 7
- **HeaderText**: TextLength символи за заглавни редове

**Изходни данни**: няма

**zfpdef**: `ProgHeader(OptionHeaderLine, HeaderText)`

### 2.4.8. Команда: 49h / I – Програмиране на долен ред

**вход**: `<'8'>` `<;>` `<FooterText[TextLength]>`

**изход**: ACK

**Операция на ФПУ**: Програмира съдържанието на долния ред.

**Входни данни**:
- **'8'**: 1 символ със стойност '8'
- **FooterText**: TextLength символи за долен ред

**Изходни данни**: няма

**zfpdef**: `ProgFooter(FooterText)`

### 2.4.9. Команда: 49h / I – Програмиране на префикс на ЕИК в заглавието

**вход**: `<'9'>` `<;>` `<HeaderUICprefix[12]>`

**изход**: ACK

**Операция на ФПУ**: Програмира съдържанието на префикса на ЕИК в заглавието.

**Входни данни**:
- **'9'**: 1 символ със стойност '9'
- **HeaderUICprefix**: 12 символа за префикс на ЕИК в заглавието

**Изходни данни**: няма

**zfpdef**: `ProgHeaderUICprefix(HeaderUICprefix)`

### 2.4.10. Команда: 4Ah / J – Програмиране на име и парола на оператор

**вход**: `<Number[1..2]>` `<;>` `<Name[20]>` `<;>` `<Password[6]>`

**изход**: ACK

**Операция на ФПУ**: Програмира името и паролата на оператора.

**Входни данни**:
- **Number**: Символи от '1' до '20', съответстващи на номера на оператора
- **Name**: 20 символа за име на оператора
- **Password**: 6 символа за парола на оператора

**Изходни данни**: няма

**zfpdef**: `ProgOperator(Number, Name, Password)`

### 2.4.11. Команда: 4Bh / K – Програмиране на артикул

**вход**: `<PLUNum[5]>` `<;>` `<Name[20]>` `<;>` `<Price[1..10]>` `<;>` `<OptionVATClass[1]>` `<;>` `<BelongToDepNum[1..2]>`

**изход**: ACK

**Операция на ФПУ**: Програмира данните за определен артикул (позиция) във вътрешната база данни. Цената може да има променлива дължина, докато полето за име е фиксирано.

**Входни данни**:
- **PLUNum**: 5 символа за номер на артикул във формат: #####
- **Name**: 20 символа за име на артикул
- **Price**: До 10 символа за цена на артикул
- **OptionVATClass**: 1 символ за ДДС клас:
  - 'А' – ДДС клас 0
  - 'Б' – ДДС клас 1
  - 'В' – ДДС клас 2
  - 'Г' – ДДС клас 3
  - 'Д' – ДДС клас 4
  - 'Е' – ДДС клас 5
  - 'Ж' – ДДС клас 6
  - 'З' – ДДС клас 7
  - '*' - Забранено
- **BelongToDepNum** (Номер на отдел): BelongToDepNum + 80h, 1 символ за принадлежност на артикула към отдел, формиран по следния начин: BelongToDepNum [HEX] + 80h пример: Отд01 = 81h, Отд02 = 82h … Отд19 = 93h

**Изходни данни**: няма

**Забележки**:
При програмиране на принадлежност към отдел, ФУ проверява дали съответният отдел е свързан със същата ДДС група. В случай че не съвпадат, няма да се приложат промени. Програмирането на стойност 0 (без принадлежност към отдел) е възможно по всяко време.

Ако не е въведен номер в полето за принадлежност към отдел, командата ще се изпълни със стойност 0 (без принадлежност към отдел).

**zfpdef**: `ProgPLU_Old(PLUNum, Name, Price, OptionVATClass, BelongToDepNum)`

### 2.4.12. Команда: 4Bh / K – Програмиране на общи регистри на артикул, Опция 1

**вход**: `<PLUNum[5]>` `<;>` `<Option['#@1+$']>` `<;>` `<Name[34]>` `<;>` `<Price[1..10]>` `<;>` `<OptionPrice[1]>` `<;>` `<OptionVATClass[1]>` `<;>` `<BelongToDepNum[1..2]>` `<;>` `<SingleTransaction[1]>`

**изход**: ACK

**Операция на ФПУ**: Програмира общите данни за определен артикул във вътрешната база данни. Цената може да има променлива дължина, докато полето за име е фиксирано.

**Входни данни**:
- **PLUNum**: 5 символа за номер на артикул във формат: #####
- **Option**: 5 символа със стойност '#@1+$'
- **Name**: 34 символа за име на артикул
- **Price**: До 10 символа за цена на артикул
- **OptionPrice**: 1 символ за флаг на цена със следната стойност:
  - '0'- Свободна цена е деактивирана, валидна само програмирана цена
  - '1'- Свободна цена е активирана
  - '2'- Ограничена цена
- **OptionVATClass**: 1 символ за ДДС клас:
  - 'А' – ДДС клас 0
  - 'Б' – ДДС клас 1
  - 'В' – ДДС клас 2
  - 'Г' – ДДС клас 3
  - 'Д' – ДДС клас 4
  - 'Е' – ДДС клас 5
  - 'Ж' – ДДС клас 6
  - 'З' – ДДС клас 7
  - '*' - Забранено
- **BelongToDepNum** (Номер на отдел): BelongToDepNum + 80h, 1 символ за принадлежност на артикула към отдел, формиран по следния начин: BelongToDepNum[HEX] + 80h пример: Отд01 = 81h, Отд02 = 82h … Отд19 = 93h
- **SingleTransaction**: 1 символ със стойност:
  - '0' – Неактивна, стойност по подразбиране
  - '1' - Активна единична транзакция в бележка

**Изходни данни**: няма

**zfpdef**: `ProgPLUgeneral(PLUNum, Name, Price, OptionPrice, OptionVATClass, BelongToDepNum, SingleTransaction)`

### 2.4.13. Команда: 4Bh / K – Програмиране на количество в наличност на артикул, Опция 2

**вход**: `<PLUNum[5]>` `<;>` `<Option['#@2+$']>` `<;>` `<AvailableQuantity[1..11]>` `<;>` `<OptionQuantityType[1]>`

**изход**: ACK

**Операция на ФПУ**: Програмира наличното количество и тип количество за определен артикул във вътрешната база данни.

**Входни данни**:
- **PLUNum**: 5 символа за номер на артикул във формат: #####
- **Option**: 5 символа със стойност '#@2+$'
- **AvailableQuantity** (Налично количество): До 11 символа за налично количество в наличност
- **OptionQuantityType**: 1 символ за флаг на количество със следната стойност:
  - '0'- Наличността на PLU запас не се наблюдава
  - '1'- Деактивиране на отрицателно количество
  - '2'- Активиране на отрицателно количество

**Изходни данни**: няма

**zfpdef**: `ProgPLUqty(PLUNum, AvailableQty, OptionQuantityType)`

### 2.4.14. Команда: 4Bh / K – Програмиране на баркод на артикул, Опция 3

**вход**: `<PLUNum[5]>` `<;>` `<Option['#@3+$']>` `<;>` `<Barcode[13]>`

**изход**: ACK

**Операция на ФПУ**: Програмира баркод на артикул във вътрешната база данни.

**Входни данни**:
- **PLUNum**: 5 символа за номер на артикул във формат: #####
- **Option**: 5 символа със стойност '#@3+$'
- **Barcode**: 13 символа за баркод

**Изходни данни**: няма

**zfpdef**: `ProgPLUbarcode(PLUNum, Barcode)`

### 2.4.15. Команда: 4Bh / K – Програмиране на цена на артикул, Опция 4

**вход**: `<PLUNum[5]>` `<;>` `<Option['#@4+$']>` `<;>` `<Price[1..10]>` `<;>` `<OptionPrice[1]>`

**изход**: ACK

**Операция на ФПУ**: Програмира цена и тип цена за определен артикул във вътрешната база данни.

**Входни данни**:
- **PLUNum**: 5 символа за номер на артикул във формат: #####
- **Option**: 5 символа със стойност '#@4+$'
- **Price**: До 10 символа за цена на артикул
- **OptionPrice**: 1 символ за флаг на цена със следната стойност:
  - '0'- Свободна цена е деактивирана, валидна само програмирана цена
  - '1'- Свободна цена е активирана
  - '2'- Ограничена цена

**Изходни данни**: няма

**zfpdef**: `ProgPLUprice(PLUNum, Price, OptionPrice)`

### 2.4.16. Команда: 4Bh / K – Изтриване на всички PLU бази данни

**вход**: `<PLUNum['00000']>` `<;>` `<Option['#@$+$']>` `<;>` `<Password[6]>`

**изход**: ACK

**Операция на ФПУ**: Изтрива всички артикули в PLU базата данни.

**Входни данни**:
- **PLUNum**: 5 символа '00000'
- **Option**: 5 символа със стойност '#@$+$'
- **Password**: 6 символа за парола

**Изходни данни**: няма

**zfpdef**: `EraseAllPLUs(Password)`

### 2.4.17. Команда: 4Ch / L – Програмиране на лого без задаване на номер (номер по подразбиране 0)

**вход**: `<BMPfile[9022]>`

**изход**: ACK

**Операция на ФПУ**: Записва в паметта графичния файл под номер 0. Отпечатва информация за зареденените в принтера графични файлове.

**Входни данни**:
- **BMPfile**: *BMP файл с фиксиран размер 9022 байта

**Изходни данни**: няма

**Забележки**:
ФУ има възможност да съхранява до 10 различни BMP файла за лого с номера от 0 до 9, като един от тях е "активен" и се отпечатва като лого на бележка. Ако няма зареден файл под номера, посочен като "активен", ФУ ще работи като е зададено да работи без лого.

**zfpdef**: `ProgLogo(BMPfile)`

### 2.4.18. Команда: 4Dh / M – Програмиране на лого със задаване на номер

**вход**: `<LogoNumber[1]>` `<BMPfile[3902/9022/5822]>`

**изход**: ACK

**Операция на ФПУ**: Записва в паметта графичния файл под посочен номер. Отпечатва информация за зареденените в принтера графични файлове.

**Входни данни**:
- **LogoNumber**: 1 символна стойност от '0' до '9', задаваща номера, под който логото ще бъде запазено.
- **BMPfile**: BMP файл с фиксиран размер 3902/9022/5822 байта

**Изходни данни**: няма

**zfpdef**: `ProgLogoNum(LogoNumber, BMPfile)`

### 2.4.19. Команда: 23h / # – Програмиране на номер на активно лого

**вход**: `<LogoNumber[1]>`

**изход**: ACK

**Операция на ФПУ**: Задава номер на лого, което е активно и ще бъде отпечатано като лого в заглавката на бележката. Отпечатва информация за активния номер.

**Входни данни**:
- **LogoNumber**: 1 символна стойност от '0' до '9' или '?'. Номерът задава активния файл, а '?' извиква само отпечатване на информация

**Изходни данни**: няма

**zfpdef**: `SetActiveLogoNum(LogoNumber)`

### 2.4.20. Команда: 51h / Q – Печат на баркод 'QP' (само за ФП)

**вход**: `<'P'>` `<;>` `<CodeType[1]>` `<;>` `<CodeLen[1..2]>` `<;>` `<CodeData[100]>`

**изход**: ACK

**Операция на ФПУ**: Отпечатва баркод от тип, посочен от CodeType и CodeLen и с данни, посочени в полето CodeData. Командата работи само за устройства фискален принтер. ЕКР не поддържа тази команда.

**Входни данни**:
- **'P'**: 1 символ 'P'
- **CodeType**: 1 символ с възможни стойности:
  - '0' – UPC A
  - '1' – UPC E
  - '2' – EAN 13
  - '3' – EAN 8
  - '4' – CODE 39
  - '5' – ITF
  - '6' – CODABAR
  - 'H' – CODE 93
  - 'I' – CODE 128
- **CodeLen**: До 2 байта за брой байтове според таблицата
- **CodeData**: До 100 байта данни в диапазон според таблицата

**Изходни данни**: няма

**Таблица**:

| Тип баркод | <CodeType> | <CodeLen> | Обхват на <CodeData> |
|------------|------------|-----------|----------------------|
| UPC-A | '0' или 'A' | 11 или 12 | Цифри от '0' до '9' |
| UPC-E | '1' или 'B' | 11 или 12 | Цифри от '0' до '9' |
| JAN13 (EAN13) | '2' или 'C' | 12 или 13 | Цифри от '0' до '9' |
| JAN8 (EAN8) | '3' или 'D' | 7 или 8 | Цифри от '0' до '9' |
| CODE 39 | '4' или 'E' | от 1 до 10 | Символи: 'SP' '$' '%' '+' '-' '.' '/' Цифри от '0' до '9' букви от 'A' до 'Z' |
| ITF | '5' или 'F' | от 2 до 18 (само четни) | Цифри от '0' до '9' |
| CODABAR | '6' или 'G' | От 1 до 15 | Символи: '$' '+' '-' '/' цифри от '0' до '9' букви от 'A' до 'D' |
| CODE 93 | 'H' | От 1 до 14 | Байтове от 0 до 7F |
| CODE 128 | 'I' | От 1 до 12 | Байтове от 0 до 7F |

Ограничението на дължината за някои от типовете баркод е поради зоната за печат, а не поради стандарта на баркода. Ако се изпратят повече данни, отпечатаният баркод може да не бъде прочетен правилно.

**zfpdef**: `PrintBarcode(CodeType, CodeLen, CodeData)`

### 2.4.21. Команда: 50h / P – Програмиране на диапазон на номера на фактури

**вход**: `<StartNum[10]>` `<;>` `<EndNum[10]>`

**изход**: ACK

**Операция на ФПУ**: Задава начален и краен номер на диапазон за фактури. За да се изпълни командата е необходимо да се изпълни следното условие: номерният диапазон да е изразходван, неизползван или незададен след последното нулиране на RAM.

**Входни данни**:
- **StartNum**: 10 символа за начален номер във формат: ##########
- **EndNum**: 10 символа за краен номер във формат: ##########

**Изходни данни**: няма

**zfpdef**: `SetInvoiceRange(StartNumber, EndNumber)`

### 2.4.22. Команда: 52h / R – Програмиране на база данни на клиенти

**вход**: `<Option['P']>` `<;>` `<CustomerNum[4]>` `<;>` `<CustomerCompanyName[26]>` `<;>` `<CustomerFullName[16]>` `<;>` `<VATNumber[13]>` `<;>` `<UIC[13]>` `<;>` `<Address[30]>` `<;>` `<UICType[1]>`

**изход**: ACK

**Операция на ФПУ**: Програмира клиент в базата данни на ФУ.

**Входни данни**:
- **Option**: 1 символ със стойност 'P'
- **CustomerNum** (Номер на клиент): 4 символа за номер на клиент във формат ####
- **CustomerCompanyName** (Име на фирма): 26 символа за име на клиент
- **CustomerFullName** (Име на купувач): 16 символа за име на купувач
- **VATNumber**: 13 символа за ДДС номер на клиент
- **UIC**: 13 символа за Единен идентификационен код на клиент
- **Address**: 30 символа за адрес на клиент
- **UICType**: 1 символ за тип на Единен идентификационен код:
  - '0' - Булстат
  - '1' - ЕГН
  - '2' – Номер на чужденец
  - '3' – Служебен номер на НАП

**Изходни данни**: няма

**zfpdef**: `ProgCustomerData(CustomerNum, CustomerFirmName, CustomerFullName, UIC, FiscNum, Address, UICType)`

---

## 2.5. КОМАНДИ ЗА ЧЕТЕНЕ НА ДАННИ

Набор от команди за получаване на информация от ФУ за програмирани стойности, както и допълнителна информация.

### 2.5.1. Команда: 60h / ' – Четене на номера на ФУ

**вход**: няма

**изход**: `<SerialNumber[8]>` `<;>` `<FMNumber[8]>`

**Операция на ФПУ**: Предоставя информация за производствения номер на фискалното устройство и номера на ФП.

**Входни данни**: няма

**Изходни данни**:
- **SerialNumber**: 8 символа за индивидуален номер на фискалното устройство
- **FMNumber**: 8 символа за индивидуален номер на фискалната памет

**zfpdef**: `ReadSerialAndFiscalNums()`

### 2.5.2. Команда: 61h / a – Четене на регистрационна информация

**вход**: няма

**изход**: `<UIC[13]>` `<;>` `<UICType[1]>` `<;>` `<NRARegistrationNumber[6]>` `<;>` `<NRARegistrationDate "DD-MM-YYYY HH:MM">`

**Операция на ФПУ**: Предоставя информация за програмирания ДДС номер, тип на ДДС номер, регистрационен номер в НАП и дата на регистрация в НАП.

**Входни данни**: няма

**Изходни данни**:
- **UIC**: 13 символа за Единен идентификационен код
- **UICType**: 1 символ за тип на Единен идентификационен код:
  - '0' - Булстат
  - '1' - ЕГН
  - '2' – Номер на чужденец
  - '3' – Служебен номер на НАП
- **NRARegistrationNumber**: Регистрационен номер на фискалното устройство от НАП
- **NRARegistrationDate**: Дата на регистрация в НАП

**zfpdef**: `ReadRegistrationInfo()`

### 2.5.3. Команда: 62h / b – Четене на ДДС ставки

**вход**: няма

**изход**: `<VATrate0[7]>` `<;>` `<VATrate1[7]>` `<;>` `<VATrate2[7]>` `<;>` `<VATrate3[7]>` `<;>` `<VATrate4[7]>` `<;>` `<VATrate5[7]>` `<;>` `<VATrate6[7]>` `<;>` `<VATrate7[7]>`

**Операция на ФПУ**: Предоставя информация за текущите ДДС ставки, които са последните стойности, запазени във ФП.

**Входни данни**: няма

**Изходни данни**:
- **VATrate0**: Стойност на ДДС ставка А от 7 символа във формат ##.##%
- **VATrate1**: Стойност на ДДС ставка Б от 7 символа във формат ##.##%
- **VATrate2**: Стойност на ДДС ставка В от 7 символа във формат ##.##%
- **VATrate3**: Стойност на ДДС ставка Г от 7 символа във формат ##.##%
- **VATrate4**: Стойност на ДДС ставка Д от 7 символа във формат ##.##%
- **VATrate5**: Стойност на ДДС ставка Е от 7 символа във формат ##.##%
- **VATrate6**: Стойност на ДДС ставка Ж от 7 символа във формат ##.##%
- **VATrate7**: Стойност на ДДС ставка З от 7 символа във формат ##.##%

**zfpdef**: `ReadVATrates()`

### 2.5.4. Команда: 63h / c – Четене на позицията на десетичната точка

**вход**: няма

**изход**: `<DecimalPointPosition[1]>`

**Операция на ФПУ**: Предоставя информация за текущия (последната стойност, запазена във ФП) формат на десетичната точка.

**Входни данни**: няма

**Изходни данни**:
- **DecimalPointPosition**: 1 символ със стойности:
  - '0'- Цели числа
  - '2' - Дроби

**zfpdef**: `ReadDecimalPoint()`

### 2.5.5. Команда: 64h / d – Четене на видове плащане

**вход**: няма

**изход**: `<NamePayment0[10]>` `<;>` `<NamePayment1[10]>` `<;>` `<NamePayment2[10]>` `<;>` `<NamePayment3[10]>` `<;>` `<NamePayment4[10]>` `<;>` `<NamePayment5[10]>` `<;>` `<NamePayment6[10]>` `<;>` `<NamePayment7[10]>` `<;>` `<NamePayment8[10]>` `<;>` `<NamePayment9[10]>` `<;>` `<NamePayment10[10]>` `<;>` `<NamePayment11[10]>` `<;>` `<ExchangeRate[1..10]>`

**Операция на ФПУ**: Предоставя информация за всички програмирани видове плащане, име на валута и обменен курс на валута.

**Входни данни**: няма

**Изходни данни**:
- **NamePayment0**: 10 символа за име на вид плащане 0
- **NamePayment1**: 10 символа за име на вид плащане 1
- **NamePayment2**: 10 символа за име на вид плащане 2
- **NamePayment3**: 10 символа за име на вид плащане 3
- **NamePayment4**: 10 символа за име на вид плащане 4
- **NamePayment5**: 10 символа за име на вид плащане 5
- **NamePayment6**: 10 символа за име на вид плащане 6
- **NamePayment7**: 10 символа за име на вид плащане 7
- **NamePayment8**: 10 символа за име на вид плащане 8
- **NamePayment9**: 10 символа за име на вид плащане 9
- **NamePayment10**: 10 символа за име на вид плащане 10
- **NamePayment11**: 10 символа за име на вид плащане 11
- **ExchangeRate**: До 10 символа за обменен курс на вид плащане 11 във формат: ####.#####

**zfpdef**: `ReadPayments()`

### 2.5.6. Команда: 64h / d – Четене на видове плащане, KL

**вход**: няма

**изход**: `<NamePaym0[10]>` `<;>` `<NamePaym1[10]>` `<;>` `<NamePaym2[10]>` `<;>` `<NamePaym3[10]>` `<;>` `<NamePaym4[10]>` `<;>` `<ExRate[1..10]>` `<;>` `<CodePaym0[1]>` `<;>` `<CodePaym1[1]>` `<;>` `<CodePaym2[1]>` `<;>` `<CodePaym3[1]>` `<;>` `<CodePaym4[1]>`

**Операция на ФПУ**: Предоставя информация за всички програмирани видове плащане. Командата работи за устройства KL версия 2.

**Входни данни**: няма

**Изходни данни**:
- **NamePaym0**: 10 символа за име на вид плащане 0
- **NamePaym1**: 10 символа за име на вид плащане 1
- **NamePaym2**: 10 символа за име на вид плащане 2
- **NamePaym3**: 10 символа за име на вид плащане 3
- **NamePaym4**: 10 символа за име на вид плащане 4
- **ExRate**: До 10 символа за обменен курс на вид плащане 4 във формат: ####.#####
- **CodePaym0**: 1 символ за код на плащане 0 = 0xFF (валута в брой)
- **CodePaym1**: 1 символ за код на плащане 1 (стойност по подразбиране е '7')
- **CodePaym2**: 1 символ за код на плащане 2 (стойност по подразбиране е '1')
- **CodePaym3**: 1 символ за код на плащане 3 (стойност по подразбиране е '2')
- **CodePaym4**: 1 символ за код на плащане 4 = 0xFF (валута в брой)

**zfpdef**: `ReadPayments_Old()`

### 2.5.7. Команда: 65h / e – Четене на параметри

**вход**: няма

**изход**: `<POSNum[4]>` `<;>` `<PrintLogo[1]>` `<;>` `<AutoOpenDrawer[1]>` `<;>` `<AutoCut[1]>` `<;>` `<ExternalDispManagement[1]>` `<;>` `<ArticleReportType[1]>` `<;>` `<EnableCurrency[1]>` `<;>` `<EJFontType[1]>` `<;>` `<reserved['0']>` `<;>` `<WorkOperatorCount[1]>`

**Операция на ФПУ**: Предоставя информация за номера на POS, печат на лого, отваряне на касово чекмедже, разрешение за рязане, режим на дисплея, тип артикулен отчет, Активиране/Деактивиране на валута в бележка, тип шрифт на ЕД и брояч на работещите оператори.

**Входни данни**: няма

**Изходни данни**:
- **POSNum** (Номер на POS): 4 символа за номер на POS във формат ####
- **PrintLogo** (Печат на лого): 1 символ със стойност:
  - '1' - Да
  - '0' - Не
- **AutoOpenDrawer** (Автоматично отваряне на чекмедже): 1 символ със стойност:
  - '1' - Да
  - '0' - Не
- **AutoCut** (Автоматично рязане): 1 символ със стойност:
  - '1' - Да
  - '0' - Не
- **ExternalDispManagement** (Управление на външен дисплей): 1 символ със стойност:
  - '1' - Ръчно
  - '0' - Автоматично
- **ArticleReportType** (Артикулен отчет): 1 символ със стойност:
  - '1' - Подробен
  - '0' - Кратък
- **EnableCurrency** (Активиране на валута): 1 символ със стойност:
  - '1' – Да
  - '0' – Не
- **EJFontType** (Шрифт на ЕД): 1 символ със стойност:
  - '1' - Нисък шрифт
  - '0' - Нормален шрифт
- **reserved**: 1 символ резервиран '0'
- **WorkOperatorCount** (Брой работещи оператори): 1 символ със стойност:
  - '1' - Един
  - '0' - Повече

**zfpdef**: `ReadParameters()`

### 2.5.8. Команда: 66h / f – Четене на подробен статус на принтера

**вход**: няма

**изход**: `<ExternalDisplay[1]>` `<;>` `<StatPRN[4]>` `<;>` `<FlagServiceJumper[1]>`

**Операция на ФПУ**: Предоставя допълнителна информация за състоянието

**Входни данни**: няма

**Изходни данни**:
- **ExternalDisplay**: 1 символ – връзка с външен дисплей
  - 'Y' - Да
  - 'N' - Не
- **StatPRN**: 4 символа за подробен статус на принтера (само за принтери с ASB)

| N байт | N бит | Флаг за състояние |
|--------|-------|-------------------|
| **ST0** | 0 | Резервиран |
| | 1 | Резервиран |
| | 2 | Ниво на сигнала за чекмедже |
| | 3 | Принтерът не е готов |
| | 4 | Резервиран |
| | 5 | Отворен капак |
| | 6 | Състояние на подаване на хартия |
| | 7 | Резервиран |
| **ST1** | 0 | Резервиран |
| | 1 | Резервиран |
| | 2 | Резервиран |
| | 3 | Грешка в резачката |
| | 4 | Резервиран |
| | 5 | Фатална грешка |
| | 6 | Прегряване |
| | 7 | Резервиран |
| **ST2** | 0 | JNP (близък край на хартия за дневник) |
| | 1 | RNP (близък край на хартия за бележка) |
| | 2 | JPE (край на хартия за дневник) |
| | 3 | RPE (край на хартия за бележка) |
| | 4 | Резервиран |
| | 5 | Резервиран |
| | 6 | Резервиран |
| | 7 | Резервиран |
| **ST3** | 0 | Съществуват данни в буфера за печат |
| | 1 | Резервиран |
| | 2 | Резервиран |
| | 3 | Резервиран |
| | 4 | Резервиран |
| | 5 | Резервиран |
| | 6 | Резервиран |
| | 7 | Резервиран |

- **FlagServiceJumper**: 1 символ със стойност:
  - 'J' - Да
  - ' ' – Не

**zfpdef**: `ReadDetailedPrinterStatus()`

### 2.5.9. Команда: 67h / g – Четене на регистри на отдел

**вход**: `<DepNum[2]>`

**изход**: `<DepNum[2]>` `<;>` `<DepName[20]>` `<;>` `<OptionVATClass[1]>` `<;>` `<Turnover[1..13]>` `<;>` `<SoldQuantity[1..13]>` `<;>` `<LastZReportNumber[1..5]>` `<;>` `<LastZReportDate "DD-MM-YYYY HH:MM">`

**Операция на ФПУ**: Предоставя информация за програмираните данни, оборота от посочения номер на отдел

**Входни данни**:
- **DepNum** (Номер на отдел): 2 символа за номер на отдел във формат: ##

**Изходни данни**:
- **DepNum**: 2 символа за номер на отдел във формат: ##
- **DepName**: 20 символа за име на отдел
- **OptionVATClass**: 1 символ за ДДС клас:
  - 'А' – ДДС клас 0
  - 'Б' – ДДС клас 1
  - 'В' – ДДС клас 2
  - 'Г' – ДДС клас 3
  - 'Д' – ДДС клас 4
  - 'Е' – ДДС клас 5
  - 'Ж' – ДДС клас 6
  - 'З' – ДДС клас 7
  - '*' - Забранено
- **Turnover**: До 13 символа за натрупан оборот на артикула
- **SoldQuantity**: До 13 символа за продадено количество на отдела
- **LastZReportNumber**: До 5 символа за номера на последния Z отчет
- **LastZReportDate**: 16 символа за дата и час на последния Z отчет във формат "DD-MM-YYYY HH:MM"

**zfpdef**: `ReadDepartment(DepNum)`

### 2.5.10. Команда: 67h / g – Четене на регистри на отдел, Опция "(All)

**вход**: `<DepNum[2]>` `<;>` `<reserved['"']>`

**изход**: `<DepNum[2]>` `<;>` `<reserved['"']>` `<;>` `<DepName[34]>` `<;>` `<OptionVATClass[1]>` `<;>` `<Price[1..10]>` `<;>` `<OptionDepPrice[1]>` `<;>` `<TurnoverAmount[1..13]>` `<;>` `<SoldQuantity[1..13]>` `<;>` `<StornoAmount[1..13]>` `<;>` `<StornoQuantity[1..13]>` `<;>` `<LastZReportNumber[1..5]>` `<;>` `<LastZReportDate "DD-MM-YYYY HH:MM">`

**Операция на ФПУ**: Предоставя информация за програмираните данни, оборотите от посочения номер на отдел

**Входни данни**:
- **DepNum** (Номер на отдел): 2 символа за номер на отдел във формат: ##
- **Reserved**: 1 символ със стойност '"'

**Изходни данни**:
- **DepNum**: 2 символа за номер на отдел във формат: ##
- **reserved**: 1 символ със стойност '"' кавички.
- **DepName**: 20 символа за име на отдел
- **OptionVATClass**: 1 символ за ДДС клас (вж. по-горе)
- **Price**: До 10 символа за цена на отдел
- **OptionDepPrice**: 1 символ за флагове на отдел със следната стойност:
  - '0' - Свободна цена деактивирана
  - '1' - Свободна цена активирана
  - '2' - Ограничена цена
  - '4' - Свободна цена деактивирана за единична транзакция
  - '5' - Свободна цена активирана за единична транзакция
  - '6' - Ограничена цена за единична транзакция
- **TurnoverAmount**: До 13 символа за натрупан оборот на артикула
- **SoldQuantity**: До 13 символа за продадено количество на отдела
- **StornoAmount**: До 13 символа за натрупана сторно сума
- **StornoQuantity**: До 13 символа за натрупано сторно количество
- **LastZReportNumber**: До 5 символа за номера на последния Z отчет
- **LastZReportDate**: 16 символа за дата и час на последния Z отчет във формат "DD-MM-YYYY HH:MM"

**zfpdef**: `ReadDepartmentAll(DepNum)`

### 2.5.11. Команда: 68h / h – Четене на дата и час

**вход**: няма

**изход**: `<DateTime "DD-MM-YYYY HH:MM">`

**Операция на ФПУ**: Предоставя информация за текущата дата и час.

**Входни данни**: няма

**Изходни данни**:
- **DateTime**: Параметър дата час във формат: DD-MM-YYYY HH:MM

**zfpdef**: `ReadDateTime()`

### 2.5.12-2.5.25. [Допълнителни команди за четене - скъсено за място]

**zfpdef функции**: `ReadDisplayGreetingMessage()`, `ReadHeader()`, `ReadFooter()`, `ReadHeaderUICPrefix()`, `ReadOperatorNamePassword()`, `ReadPLU_Old()`, `ReadPLUallData()`, `ReadPLUgeneral()`, `ReadPLUqty()`, `ReadPLUbarcode()`, `ReadPLUprice()`, `PrintLogo()`, `ReadCustomerData()`, `ReadDailyReportParameter()`

---

## 2.6. КОМАНДИ ЗА ОПЕРАЦИИ С КАСОВИ БЕЛЕЖКИ

Тези команди се използват главно за регистриране на продажби във ФУ. Групата включва също някои спомагателни команди, предоставящи информация за текущата бележка, както и команди за суми ВС и ИС.

### 2.6.1. Команда: 2Eh / . – Отваряне на нефискална бележка

**вход**: `<OperNum[1..2]>` `<;>` `<OperPass[6]>` `{` `<;>` `<Reserved['0']>` `<;>` `<NonFiscalPrintType[1]>` `}`

**изход**: ACK

**Операция на ФПУ**: Отваря нефискална бележка, назначена на посочения номер на оператор, парола на оператор и тип печат.

**Входни данни**:
- **OperNum** (Номер на оператор): Символи от 1 до 20, съответстващи на номера на оператора
- **OperPass** (Парола на оператор): 6 символа за парола на оператора
- **Reserved**: 1 символ със стойност '0'
- **NonFiscalPrintType** (Тип печат): 1 символ със стойност:
  - '0' – Стъпка по стъпка печат
  - '1' – Отложен печат

**Изходни данни**: няма

**zfpdef**: `OpenNonFiscalReceipt(OperNum, OperPass, NonFiscalPrintType)`

### 2.6.2. Команда: 2Fh / / – Затваряне на нефискална бележка

**вход**: няма

**изход**: ACK

**Операция на ФПУ**: Затваря нефискалната бележка.

**Входни данни**: няма

**Изходни данни**: няма

**zfpdef**: `CloseNonFiscalReceipt()`

### 2.6.3. Команда: 30h / 0 – Отваряне на фискална продажбена бележка

**вход**: `<OperNum[1..2]>` `<;>` `<OperPass[6]>` `<;>` `<ReceiptFormat[1]>` `<;>` `<PrintVAT[1]>` `<;>` `<FiscalRcpPrintType[1]>` `{` `<'$'>` `<UniqueReceiptNumber[24]>` `}`

**изход**: ACK

**Операция на ФПУ**: Отваря фискална бележка, назначена на посочения номер на оператор и парола на оператор, параметри за формат на бележката, печат на ДДС, тип печат и уникален номер на бележката.

**Входни данни**:
- **OperNum** (Номер на оператор): Символи от 1 до 20, съответстващи на номера на оператора
- **OperPass** (Парола на оператор): 6 символа за парола на оператора
- **ReceiptFormat** (Формат): 1 символ със стойност:
  - '1' - Подробен
  - '0' - Кратък
- **PrintVAT** (ДДС включен в бележката): 1 символ със стойност:
  - '1' – Да
  - '0' – Не
- **FiscalRcpPrintType** (Тип печат): 1 символ със стойност:
  - '0' – Стъпка по стъпка печат
  - '2' – Отложен печат
  - '4' – Буфериран печат
- **UniqueReceiptNumber**: До 24 символа за уникален номер на бележката.
  НАП формат: XXXХХХХХ-ZZZZ-YYYYYYY където:
  * ХХХХХХXX – 8 символа [A-Z, a-z, 0-9] за индивидуален номер на устройството,
  * ZZZZ – 4 символа [A-Z, a-z, 0-9] за код на оператора,
  * YYYYYYY – 7 символа [0-9] за следващ номер на бележката

**Изходни данни**: няма

**zfpdef**: `OpenReceipt(OperNum, OperPass, RcpFormat, PrintVAT, FiscalRcpPrintType, UniqueReceiptNumber)`

### 2.6.4. Команда: 30h / 0 – Отваряне на ЕЛЕКТРОННА фискална продажбена бележка

**вход**: `<OperNum[1..2]>` `<;>` `<OperPass[6]>` `<;>` `<ReceiptFormat[1]>` `<;>` `<PrintVAT[1]>` `<;>` `<FiscalRcpPrintType['8']>` `{` `<'$'>` `<UniqueReceiptNumber[24]>` `}`

**изход**: ACK

**Операция на ФПУ**: Отваря отложена електронна фискална бележка с 1 минута таймаут, назначена на посочения номер на оператор и парола на оператор, параметри за формат на бележката, печат на ДДС, тип печат и уникален номер на бележката.

**Входни данни**:
- (Същите като 2.6.3, освен)
- **FiscalRcpPrintType**: 1 символ със стойност '8' за отложен печат на електронна бележка

**Изходни данни**: няма

**zfpdef**: `OpenElectronicReceipt(OperNum, OperPass, RcpFormat, PrintVAT, UniqueReceiptNumber)`

### 2.6.5. Команда: 30h / 0 – Отваряне на фискална сторно бележка

**вход**: `<OperNum[1..2]>` `<;>` `<OperPass[6]>` `<;>` `<ReceiptFormat[1]>` `<;>` `<PrintVAT[1]>` `<;>` `<StornoRcpPrintType[1]>` `<;>` `<StornoReason[1]>` `<;>` `<RelatedToRcpNum[1..6]>` `<;>` `<RelatedToRcpDateTime "DD-MM-YY HH:MM:SS">` `<;>` `<FMNum[8]>` `{` `<;>` `<RelatedToURN[24]>` `}`

**изход**: ACK

**Операция на ФПУ**: Отваря фискална сторно бележка, назначена на посочения номер на оператор и парола на оператор, параметри за формат на бележката, печат на ДДС, тип печат и параметри за свързаната сторно бележка.

**Входни данни**:
- **OperNum** (Номер на оператор): Символи от 1 до 20, съответстващи на номера на оператора
- **OperPass** (Парола на оператор): 6 символа за парола на оператора
- **ReceiptFormat** (Формат): 1 символ със стойност:
  - '1' - Подробен
  - '0' - Кратък
- **PrintVAT** (ДДС включен в бележката): 1 символ със стойност:
  - '1' – Да
  - '0' – Не
- **StornoRcpPrintType** (Тип печат): 1 символ със стойност:
  - '@' – Стъпка по стъпка печат
  - 'B' – Отложен печат
  - 'D' – Буфериран печат
- **StornoReason**: 1 символ за причина за сторно операция със стойност:
  - '0' – Грешка на оператора
  - '1' – Рекламация или връщане на стока
  - '2' – Данъчно облекчение
- **RelatedToRcpNum** (Номер на бележка): До 6 символа за номер на издадената бележка
- **RelatedToRcpDateTime** (Дата и час на бележка): 17 символа за дата и час на издадената бележка във формат DD-MM-YY HH:MM:SS
- **FMNum**: 8 символа за номер на фискалната памет
- **RelatedToURN**: До 24 символа за уникален номер на издадената бележка (НАП формат)

**Изходни данни**: няма

**Забележка**:
Ако е активиран отложен печат след отворена фискална бележка, всички следващи команди ще се изпълнят, но няма да бъдат отпечатани веднага. Данните за цялата бележка се съхраняват, за да бъдат отпечатани докато СП изпрати информация за затваряне на бележката. Ако в рамките на 5 сек. таймаут няма команда ЕКР затваряне на бележката...

**zfpdef**: `OpenStornoReceipt(OperNum, OperPass, ReceiptFormat, PrintVAT, StornoRcpPrintType, StornoReason, RelatedToRcpNum, RelatedToRcpDateTime, FMNum, RelatedToURN)`

### 2.6.6-2.6.11. [Команди за фактури - съкратени]

Включват: отваряне на фискални фактури със свободни данни за клиент, електронни фактури, кредитни бележки, както със свободни данни, така и от ФУ база данни.

**zfpdef функции**: `OpenInvoiceWithFreeCustomerData()`, `OpenElectronicInvoiceWithFreeCustomerData()`, `OpenCreditNoteWithFreeCustomerData()`, `OpenInvoiceWithFDCustomerDB()`, `OpenElectronicInvoiceWithFDCustomerDB()`, `OpenCreditNoteWithFDCustomerDB()`

### 2.6.12. Команда: 31h / 1 – Продажба/Корекция на артикул, принадлежащ към ДДС клас

**вход**: `<NamePLU[36]>` `<;>` `<OptionVATClass[1]>` `<;>` `<Price[1..10]>` `{` `<'*'>` `<Quantity[1..10]>` `}` `{` `<','>` `<DiscAddP[1..7]>` `}` `{` `<':'>` `<DiscAddV[1..8]>` `}`

**изход**: ACK

**Операция на ФПУ**: Регистрира продажбата (за корекция използвайте минус знак в полето за цена) на артикул с посочено име, цена, количество, ДДС клас и/или отстъпка/надбавка върху транзакцията.

**Входни данни**:
- **NamePLU** (Име на PLU): 36 символа за име на артикул. 34 символа се отпечатват на хартия. Символ 0x7C '|' е разделител за нов ред.
- **OptionVATClass**: 1 символ за ДДС клас:
  - 'А' – ДДС клас 0
  - 'Б' – ДДС клас 1
  - 'В' – ДДС клас 2
  - 'Г' – ДДС клас 3
  - 'Д' – ДДС клас 4
  - 'Е' – ДДС клас 5
  - 'Ж' – ДДС клас 6
  - 'З' – ДДС клас 7
  - '*' - Забранено
- **Price**: До 10 символа за цена на артикула. Използвайте минус знак '-' за корекция
- **'*'**: 1 символ '*' указващ наличието на поле за количество
- **Quantity**: До 10 символа за количество
- **','**: 1 символ ',' указващ наличието на поле за отстъпка/надбавка
- **DiscAddP** (Отстъпка/Надбавка %): До 7 символа за процент на отстъпка/надбавка. Използвайте минус знак '-' за отстъпка
- **':'**: 1 символ ':' указващ наличието на поле за стойностна отстъпка/надбавка
- **DiscAddV** (Отстъпка/Надбавка Стойност): До 8 символа за стойност на отстъпка/надбавка. Използвайте минус знак '-' за отстъпка

**Изходни данни**: няма

**Забележки**:
Полетата за количество не са задължителни. Ако не е посочена стойност за тях, ФУ изпълнява командата за количество по подразбиране 1.000

Полетата за отстъпка/надбавка не са задължителни. Отстъпката/надбавката трябва да бъде в проценти и се определя от наличието или отсъствието на символа '-'.

**zfpdef**: `SellPLUwithSpecifiedVAT(NamePLU, OptionVATClass, Price, Quantity, DiscAddP, DiscAddV)`

### 2.6.13-2.6.30. [Допълнителни команди за продажби]

Включват различни варианти за продажба/корекция:
- От отдел
- С посочен ДДС от отдел
- От ФУ база данни
- Междинна сума
- Плащане
- Затваряне на бележка
- Отмяна на бележка
- С дробно количество
- И др.

**zfpdef функции**: `SellPLUfromDep()`, `SellPLUwithSpecifiedVATfromDep()`, `SellPLUFromFD_DB()`, `Subtotal()`, `SellPLUwithSpecifiedVATfromDep_()`, `SellPLUfromDep_()`, `Payment()`, `PayExactSum()`, `CashPayCloseReceipt()`, `PrintText()`, `CloseReceipt()`, `CancelReceipt()`, `PrintLastReceiptDuplicate()`, `ReceivedOnAccount_PaidOut()`, `PrintDiscountOrAddition()`, `SellFractQtyPLUwithSpecifiedVAT()`, `SellFractQtyPLUfromDep()`, `SellFractQtyPLUwithSpecifiedVATfromDep()`

---

## 2.7. КОМАНДИ ЗА ЧЕТЕНЕ НА ДАННИ В РЕГИСТРИТЕ НА ФУ

Този набор от команди предоставя информация за състоянието на регистрите на ФУ без да причинява активност на устройството, т.е. информацията се получава чрез комуникационния интерфейс без печат или визуализация на дисплея.

### 2.7.1. Команда: 6Dh / m – Четене на дневни суми на продажби и сторно по ДДС групи

**вход**: няма

**изход**: `<SaleAmountVATGr0[1..13]>` `<;>` ... `<StornoAllVATGr[1..13]>`

**Операция на ФПУ**: Предоставя информация за натрупаните суми на продажби и сторно по ДДС група.

**Входни данни**: няма

**Изходни данни**:
- **SaleAmountVATGr0-7**: До 13 символа за сумата, натрупана от продажби по ДДС група А-З
- **SumAllVATGr**: До 13 символа за сума на всички ДДС групи
- **StornoAmountVATGr0-7**: До 13 символа за сумата, натрупана от сторно по ДДС група А-З
- **StornoAllVATGr**: До 13 символа за сумата, натрупана от сторно по всички групи

**zfpdef**: `ReadDailySaleAndStornoAmountsByVAT()`

### 2.7.2-2.7.38. [Допълнителни команди за четене на регистри]

Включват команди за четене на:
- Налични суми (в наличност)
- Общи регистри
- ВС (Внесена Сума)
- ИС (Изплатена Сума)
- Получени суми от продажби
- Броячи
- Върната ресто
- Суми във ФУ
- Електронен подпис
- Операторски отчети
- Диапазон на номера на фактури
- Номер на последна бележка
- Информация за текуща отворена бележка
- Информация за плащанията
- QR код данни
- Електронни бележки
- Информация за последен дневен отчет
- Свободни записи във ФП
- Съдържание на ФП

**zfpdef функции**: `ReadDailyAvailableAmounts()`, `ReadGeneralDailyRegisters()`, `ReadDailyRA()`, `ReadDailyPO()`, `ReadDailyReceivedSalesAmounts()`, `ReadDailyCounters()`, `ReadDailyReturnedChangeAmounts()`, `ReadGrandFiscalSalesAndStornoAmounts()`, `ReadLastDailySignature()`, `DisplayDailyTurnover()`, `ReadDailyGeneralRegistersByOperator()`, `ReadDailyRAbyOperator()`, `ReadDailyPObyOperator()`, `ReadDailyReceivedSalesAmountsByOperator()`, `ReadDailyCountersByOperator()`, `ReadDailyReturnedChangeAmountsByOperator()`, `ReadInvoiceRange()`, `ReadLastReceiptNum()`, `ReadCurrentReceiptInfo()`, `ReadCurrentOrLastReceiptPaymentAmounts()`, `ReadLastReceiptQRcodeData()`, `ReadSpecifiedReceiptQRcodeData()`, `ReadElectronicReceipt_QR_Data()`, `ReadElectronicReceipt_QR_ASCII()`, `ReadElectronicReceipt_QR_BMP()`, `ReadLastDailyReportInfo()`, `ReadFMfreeRecords()`, `ReadFMcontent()`

---

## 2.8. КОМАНДИ ЗА ПЕЧАТ НА ОТЧЕТИ

Набор от команди за печат на отчети, генерирани от ФУ.

### 2.8.1. Команда: 76h / v – Печат на отчет по отдели

**вход**: `<OptionZeroing[1]>`

**изход**: ACK

**Операция на ФПУ**: Отпечатва отчет по отдели с или без нулиране ('Z' или 'X').

**Входни данни**:
- **OptionZeroing** (Параметър нулиране): 1 символ със стойност:
  - 'Z' – Нулиране
  - 'X' – Без нулиране

**Изходни данни**: няма

**zfpdef**: `PrintDepartmentReport(OptionZeroing)`

### 2.8.2. Команда: 77h / w – Печат на специални събития ФП отчет

**вход**: няма

**изход**: ACK

**Операция на ФПУ**: Отпечатва цял отчет за специални събития във ФП.

**Входни данни**: няма

**Изходни данни**: няма

**zfpdef**: `PrintSpecialEventsFMreport()`

### 2.8.3. Команда: 77h / w – Печат на кратък ФП отчет за плащания

**вход**: `<Option['P']>`

**изход**: ACK

**Операция на ФПУ**: Отпечатва кратък отчет за плащания от ФП.

**Входни данни**:
- **Option**: 1 символ със стойност 'P'

**Изходни данни**: няма

**zfpdef**: `PrintBriefFMPaymentsReport()`

### 2.8.4. Команда: 78h / x – Печат на подробен ФП отчет по номер на Z отчетни блокове

**вход**: `<StartZNum[4]>` `<;>` `<EndZNum[4]>`

**изход**: ACK

**Операция на ФПУ**: Отпечатва подробен ФП отчет по начален и краен ФП номер на отчет.

**Входни данни**:
- **StartZNum**: 4 символа за начален номер на отчет, включен в отчета, формат ####
- **EndZNum**: 4 символа за краен номер на отчет, включен в отчета, формат ####

**Изходни данни**: няма

**zfpdef**: `PrintDetailedFMReportByZBlocks(StartNo, EndNo)`

### 2.8.5-2.8.24. [Допълнителни команди за печат на отчети]

Включват различни варианти на отчети:
- Подробни/кратки ФП отчети по Z блокове
- Подробни/кратки ФП отчети по дата
- Дневен фискален отчет X или Z
- Печат/Запазване на отчет от Електронен Дневник
- Операторски отчет
- Артикулен отчет
- Подробен дневен отчет
- Отчет за клиенти

**zfpdef функции**: `PrintDetailedFMPaymentsReportByZBlocks()`, `PrintBriefFMReportByZBlocks()`, `PrintBriefFMPaymentsReportByZBlocks()`, `PrintDetailedFMReportByDate()`, `PrintDetailedFMPaymentsReportByDate()`, `PrintBriefFMReportByDate()`, `PrintBriefFMPaymentsReportByDate()`, `PrintDailyReport()`, `PrintOrStoreEJByDate()`, `PrintEJByDateCustom()`, `PrintOrStoreEJByRcpNum()`, `PrintEJByRcpNumCustom()`, `PrintOrStoreEJByZBlocks()`, `PrintEJByZBlocksCustom()`, `PrintOrStoreEJ()`, `PrintEJCustom()`, `PrintOperatorReport()`, `PrintArticleReport()`, `PrintDetailedDailyReport()`, `PrintCustomerReport()`

---

## 2.9. КОМАНДИ ЗА ЧЕТЕНЕ НА ОТЧЕТИ

Набор от команди за четене на отчети, генерирани от ФУ.

### 2.9.1. Команда: 7Ch / | – Четене на отчет от Електронен Дневник от дата до дата

**вход**: `<ReportFormat[2]>` `<;>` `<'D'>` `<;>` `<StartRepFromDate "DDMMYY">` `<;>` `<EndRepFromDate "DDMMYY">`

**изход**: ACK+

**Операция на ФПУ**: Чете отчет от Електронен Дневник по начална до крайна дата.

**Входни данни**:
- **ReportFormat** (Формат на ЕД отчет): 1 символ със стойност:
  - 'J0' – Подробен ЕД
  - 'J8' – Кратък ЕД
- **'D'**: 1 символ 'D'
- **StartRepFromDate**: 6 символа за начална дата във формат DDMMYY
- **EndRepFromDate**: 6 символа за крайна дата във формат DDMMYY

**Изходни данни**: няма

**zfpdef**: `ReadEJByDate(ReportFormat, StartRepFromDate, EndRepFromDate)`

### 2.9.2. Команда: 7Ch / | – Четене/Запазване на отчет от Електронен Дневник от дата до дата с избрано съдържание на документи и формат

**вход**: `<StorageReport[2]>` `<;>` `<CSVformat[1]>` `<;>` `<FlagsReceipts[1]>` `<;>` `<FlagsReports[1]>` `<;>` `<'D'>` `<;>` `<StartRepFromDate "DDMMYY">` `<;>` `<EndRepFromDate "DDMMYY">`

**изход**: ACK+

**Операция на ФПУ**: Чете или запазва отчет от Електронен Дневник по начална до крайна дата, опция за CSV формат и съдържание на документа. Ако CSV форматът е зададен, съдържанието може да включва само фискални бележки. FlagsReceipts е char с битове, представляващи типовете бележки. FlagsReports е char с битове, представляващи типа отчет.

**Входни данни**:
- **StorageReport** (Съхранение на ЕД отчет): 1 символ със стойност:
  - 'j0' – Към PC
  - 'j2' – Към USB Flash Drive
  - 'j4' – Към SD карта
- **CSVformat**: 1 символ със стойност:
  - 'C' – Да
  - 'X' – Не
- **FlagsReceipts** (Бележки, включени в ЕД): 1 символ за бележки, включени в ЕД:
  - Flags.7=0
  - Flags.6=1, 0=w
  - Flags.5=1 Да, Flags.5=0 Не (Включи ИС)
  - Flags.4=1 Да, Flags.4=0 Не (Включи ВС)
  - Flags.3=1 Да, Flags.3=0 Не (Включи кредитна бележка)
  - Flags.2=1 Да, Flags.2=0 Не (Включи сторно бележка)
  - Flags.1=1 Да, Flags.1=0 Не (Включи фактура)
  - Flags.0=1 Да, Flags.0=0 Не (Включи фискална бележка)
- **FlagsReports** (Отчети, включени в ЕД): 1 символ за отчети, включени в ЕД:
  - Flags.7=0
  - Flags.6=1, 0=w
  - Flags.5=1, 0=w
  - Flags.4=1 Да, Flags.4=0 Не (Включи ФП отчети)
  - Flags.3=1 Да, Flags.3=0 Не (Включи други отчети)
  - Flags.2=1 Да, Flags.2=0 Не (Включи дневен X)
  - Flags.1=1 Да, Flags.1=0 Не (Включи дневен Z)
  - Flags.0=1 Да, Flags.0=0 Не (Включи дубликати)
- **'D'**: 1 символ 'D'
- **StartRepFromDate**: 6 символа за начална дата във формат DDMMYY
- **EndRepFromDate**: 6 символа за крайна дата във формат DDMMYY

**Изходни данни**: няма

**zfpdef**: `ReadEJByDateCustom(StorageReport, CSVformat, FlagsReceipts, FlagsReports, StartRepFromDate, EndRepFromDate)`

### 2.9.3-2.9.8. [Допълнителни команди за четене на отчети от ЕД]

Включват четене на отчети:
- По номер на бележка
- По номер на Z отчет
- От начало до край
- С избрано съдържание и формат

**zfpdef функции**: `ReadEJByReceiptNum()`, `ReadEJByReceiptNumCustom()`, `ReadEJByZBlocks()`, `ReadEJByZBlocksCustom()`, `ReadEJ()`, `ReadEJCustom()`

---

## 2.10. КОМАНДИ ЗА МРЕЖОВИ НАСТРОЙКИ

Набор от команди за мрежови настройки.

### 2.10.1. Команда: 4Eh / N – Четене на информация за последна изпратена и първа неизпратена бележка

**вход**: `<Option['R']>` `<;>` `<'R'>` `<;>` `<'R'>`

**изход**: `<LastSentRcpNum[1..6]>` `<;>` `<LastSentRcpDateTime "DD-MM-YYYY HH:MM">` `<;>` `<FirstUnsentRcpNum[1..6]>` `<;>` `<FirstUnsentRcpDateTime "DD-MM-YYYY HH:MM">` `<;>` `<NRA_ErrorMessage[100]>`

**Операция на ФПУ**: Предоставя информация за номер и дата час на последната изпратена бележка до НАП сървър и номер и дата час на първата неизпратена бележка до НАП. Ако няма неизпратена бележка, номерът ще бъде 0 и дата час ще бъде 00-00-0000 00:00. Параметър NRA_ErrorMessage предоставя съобщение за грешка от НАП сървър, ако съществува. Командата не е разрешена, ако устройството е дерегистрирано, не е фискализирано или е в отворена бележка.

**Входни данни**:
- **Option**: 1 символ със стойност 'R'
- **'R'**: 1 символ със стойност 'R'
- **'R'**: 1 символ със стойност 'R'

**Изходни данни**:
- **LastSentRcpNum**: До 6 символа за номера на последната изпратена бележка до НАП сървър
- **LastSentRcpDateTime**: 16 символа за датата и часа на последната изпратена бележка до НАП сървър във формат DD-MM-YYYY HH:MM
- **FirstUnsentRcpNum**: До 6 символа за номера на първата неизпратена бележка до НАП сървър
- **FirstUnsentRcpDateTime**: 16 символа за датата и часа на първата неизпратена бележка до НАП сървър във формат DD-MM-YYYY HH:MM
- **NRA_ErrorMessage**: До 100 символа за съобщение за грешка от НАП сървър, ако съществува

**zfpdef**: `ReadSentRcpInfoStatus()`

---

## 3. ИЗИСКВАНИЯ КЪМ СОФТУЕРНОТО ПРИЛОЖЕНИЕ

### 3.1. ПРАВИЛА ЗА ИЗПОЛЗВАНЕ НА КОМАНДИТЕ

Командите трябва да се използват, спазвайки следните правила:

- Не изпращайте следваща команда преди да получите отговор на предходната.
- Спазвайте последователността на изпратените и получени съобщения.
- Номерът на съобщението във всяка следваща команда трябва да се различава от този в предходната.
- Спазвайте двата байта за състояние на потвърдителния отговор.
- Когато получената информация е недостатъчна, поискайте подробна информация за състоянието – Команда 20h.
- Използвайте непакетирани съобщения за проверка на статуса на готовност на ФУ.

### 3.2. ПРИМЕРНА ПРОДАЖБЕНА ТРАНЗАКЦИЯ НА ФУ

Продажбената транзакция, контролирана от софтуерно приложение (СП), е процедура, която се състои от няколко команди, от които задължителни са: инициализация на клиентска фискална бележка (команда 30h), регистриране на продажба (команда 31h или 32h), плащане (команда 35h) и финализиране на фискалната бележка (команда 38h).

**Примерна последователност от команди за издаване на клиентска фискална бележка:**

- **Отваряне на фискална бележка** (команда 30h) – съдържа информация за номера и паролата на оператора, типа на бележката – подробна/кратка, с/без печат на ДДС.

- **Регистриране на продажба** (команда 31h) – съдържа информация за името на артикула, цената и ДДС групата, както и незадължителна информация за продаденото количество и стойност/процент отстъпка/надбавка;

- **Междинна сума** (команда 33h) – съдържа незадължителни параметри за печат, визуализация на външен дисплей и стойност/процент отстъпка/надбавка на натрупаната сума;

- **Информация за текуща бележка** (команда 72h) – изисква отговор от ФУ, който съдържа текущите параметри на бележката, броя продажби, натрупаните суми по ДДС групи, информация за инициирани или финализирани плащания;

- **Изчисление и плащане на ДДС по ДДС сметка** (команда 36h) – извършва автоматично изчисление на ДДС в бележката и неговото плащане по ДДС сметка;

- **Плащане** (команда 35h) – съдържа информация за дължимата сума и тип плащане, който може да покрие частично или изцяло общата дължима сума, както и параметър за изчисление на дължимото ресто;

- **Затваряне на фискална бележка** (команда 38h).

---

## 4. СПОМАГАТЕЛЕН GS ПРОТОКОЛ (КОМАНДИ 1Dh)

| GS команда | Съобщение от СП | Отговор на ФП |
|------------|-----------------|---------------|
| **Информация** | `<1Dh><Info>` където: Info – символ 49h - 'I' | `<'I'><Брой печатаеми символи на ред[2]>` `<;>` `<PLU номер[5]>` `<;>` `<Номер на отдели[2]>` `<;>` `<Номер на оператори[2]>` `<;>` `<Номер на ДДС класове[1]>` `<;>` `<Номер на заглавни редове[2]>` `<;>` `<Номер на плащания[2]>` `<;>` `<Номер на лога[2]>` `<;>` `<резерв='00'[2]>` `<;>` `<Номер на транзакции в бележка[3]>` `<;>` `<Информация за база данни на клиенти[4]>` `<0Ah>` |
| **Модел** | `<1Dh><Model>` където: Model – символ 77h - 'M' | `<'M'>` `<държава[2]>` `<;>` `<кодиране[1..20]>` `<;>` `<тип устройство[2]>` `<;>` `<№ лиценз[2..4]>` `<;>` `<дата лиценз[10]>` `<;>` `<интерфейси[1..40]>` `<;>` `<текущ интерфейс[1..4]>` `<;>` `<поддръжка на батерия[0..12]>` `<;>` `<текущо захранване от батерия ('E' или 'B')[1]>` `<;>` `<режим на заспиване[1]>` `<;>` `<Sd карта дневник[1]>` `<;>` `<SD карта формат[1..4]>` `<;>` `<SD карта допълнителна БД[1]>` `<;>` `<обмен със сървър[1]>` `<;>` `<Брой печатаеми символи на ред[2]>` `<;>` `<брой печатаеми свободен текст[2]>` `<;>` `<символи име на артикул в команда[2]>` `<;>` `<печатаеми символи име на артикул[2]>` `<;>` `<символи име на отдел в команда[2]>` `<;>` `<печатаеми символи име на отдел[2]>` `<;>` `<първи номер на отдел[1]>` `<;>` `<последен PLU номер[5]>` `<;>` `<общ брой заглавия>` `<;>` `<брой само фискални заглавия>` `<;>` `<брой долни редове>` `<0Ah>` |

---

## КРАЙ НА ДОКУМЕНТА

**Комуникационен протокол Tremol**  
**Версия: 1910211454**

*Документът съдържа пълното описание на комуникационния протокол за фискални устройства Tremol, включително всички команди за общи операции, фискални операции, програмиране, четене на данни, операции с бележки, отчети и мрежови настройки.*

*За повече информация и техническа поддръжка, моля посетете официалния сайт на Tremol или се свържете с техническата поддръжка.*

