# DATECS Програмен интерфейс на каси DP-05, DP-25, DP-35, WP-50, DP-150
## Версия 2.04BG

---

## ВЪВЕДЕНИЕ

Фискалното устройство (ФУ) работи под управлението на приложна програма, комуникирайки с нея чрез асинхронен сериен канал за връзка RS232. То е предназначено да изпълнява предварително определен набор от команди, логически подредени в зависимост от вида на операциите, които трябва да се изпълнят. Приложната програма няма директен достъп до ресурсите на ФУ, но може да извлича данни, свързани със състоянието на ФУ и фискалната памет (ФП).

### Видове операции на ФУ

ФУ изпълнява следните видове операции:

- Запомняне на индивидуалния номер на ФУ и номера на ФП
- Запомняне на фискалните параметри (ЕИК, данъчен номер, дата на въвеждане в експлоатация и др.)
- Запомняне на информация за собственика (адрес, име и др.)
- Запомняне на стойностите на продажбите и генериране на клиентски бон
- Запомняне на дневния оборот във ФП и генериране на дневен финансов отчет
- Запомняне на текста от фискалните бонове и дневните отчети в КЛЕН и справки от КЛЕН при заявка
- Генериране на отчети за реализираните продажби и съдържанието на ФП
- Отпечатване на отчети, генерирани от приложението
- Извеждане на данни към приложната програма

---

## ДАНЪЧНИ ГРУПИ И ИЗЧИСЛЯВАНЕ НА ДДС

Всяка продажба е причислена към определена данъчна група (ДДС), която определя данъчната ставка, приложена към базовата цена за формиране цената на продажбата. ФУ може да работи с най-много **8 данъчни групи**, обозначени обикновено с първите букви от азбуката – **'А', 'Б', 'В', 'Г', 'Д', 'Е', 'Ж' и 'З'**.

За всяка от данъчните групи се задава данъчна ставка (в проценти), която трябва да бъде число не по-голямо от **99.00**, с не повече от два десетични знака. Част от данъчните групи могат да се забраняват, чрез установяване на `Enabled_taxes` в команда 83 (53H).

Командите за продажба приемат като параметър главните букви 'А', 'Б', 'В', 'Г', 'Д', 'Е', 'Ж' и 'З' (в DOS-овска или 1251 кодова таблица). Същото се отнася и за всички команди, очакващи данъчна група като входен параметър.

> **Забележка:** Навсякъде при печат данъчните групи са на кирилица!

---

## РЕЖИМИ НА РАБОТА НА ФУ

ФУ може да работи в два режима:

### Нефискален режим
Устройството не е фискализирано. Всички данни, необходими за нормалната му работа са въведени и записани във ФП с изключение на ЕИК на собственика и данъчните ставки. Могат да се отварят и издават клиентски бонове, но винаги върху тях се изписва, че са нефискални. Могат да се извършват дневни финансови отчети с нулиране, но те не се записват във ФП.

### Фискален режим
Устройството е фискализирано. ЕИК на собственика е въведен и записан във ФП. Прилагат се всички фискални правила.

---

## СЪСТОЯНИЯ НА ФУ

ФУ може да се намира в няколко състояния. Преминаването му от едно състояние в друго не винаги е възможно. Управлението на ФУ, както и преходите между състоянията, когато това е възможно, се осъществяват от приложната програма в Host (PC), която трябва да бъде строго съобразена с използвания протокол.

### А) СЪСТОЯНИЕ ПРИ ПРЕДОСТАВЯНЕ НА КЛИЕНТ

В това състояние трябва да се зададат **"header"** и **"footer"**. В "header"-а обикновено се записва информация за собственика (име на фирмата, адрес и др.), а във "footer"-a някакъв рекламен текст.

Трябва да се изпълни командата **43 (2BH)** толкова пъти колкото редове се установяват.

### Б) НЕФИСКАЛЕН РЕЖИМ

В това състояние ФУ се намира докато не се фискализира. Възможно е издаването на бонове, като трябва да се има предвид, че дори и клиентските бонове в този режим се маркират като нефискални. 

Възможно е и извършването на дневен финансов отчет с нулиране (Z-отчет), но не се прави запис във ФП. Зададен е ЕИК, но той не е записан във ФП и може да се променя. Отчетите на ФП не се изпълняват. Нулиранията на паметта, ако има такива, не предизвикват запис във ФП. Часовникът може да се сверява произволно.

> **ВАЖНО:** В нефискален режим ФУ НЕ МОЖЕ ДА БЪДЕ ИЗПОЛЗВАНО в търговски обекти – предназначението му е само за обучение.

### Г) ФИСКАЛИЗИРАНА И РЕГИСТРИРАНА КАСА

В това състояние могат да се издават клиентски финансови бонове, маркирани като фискални. При извършване на дневен финансов отчет с нулиране (Z-отчет) се прави запис във ФП. Сверяването на датата е допустимо само напред спрямо последния запис във ФП. ЕИК се записва във ФП и повече не може да се променя.

> **ВАЖНО:** НЕ Е ВЪЗМОЖНО излизането на ФУ от фискален режим без смяна на ФП.

Преди фискализация трябва да се установи ЕИК на притежателя на устройството, ако вече не е зададен (команда 98 (62H)), и после да се изпълни командата 72 (48H). За нормална работа ФУ трябва да се регистрира в НАП с предвидената за това програма.

### Е) НЕОБРАТИМА ГРЕШКА ВЪВ ФУ

В това състояние ФУ попада в случай, че е установена сериозна техническа или логическа грешка при работа, както и в случай на неизправност на модула ФП, КЛЕН или данъчния терминал. В този режим се индицира грешка и командите за отваряне на фискални бонове или свързаните със запис във ФП не се изпълняват.

**Събития довеждащи до това състояние:**

- Невъзможно извършване на верен запис във ФП
- Невалидна контролна сума на ЕИК, индивидуален номер на ФУ, номер на ФП или някой от записите с данъчни ставки
- Неразпознаване формата на модула ФП
- Невалидна контролна сума на фискален запис от дневен финансов отчет
- Липсваща комуникация с данъчния терминал
- Липсваща комуникация с КЛЕН или заключен с невалидна парола КЛЕН
- Запълнен КЛЕН

---

## СТАТУС БИТОВЕ НА ФУ

Текущото състояние на устройството е кодирано в поле с дължина **6 байта**, което се предава в рамката на всяко съобщение от ФУ.

### Байт 0: Общо предназначение

| Бит | Описание |
|-----|----------|
| 0.7 | Резервиран – винаги е 1 |
| 0.6 | Резервиран – винаги е 0 |
| 0.5 | **Обща грешка** - OR на всички грешки, маркирани с '#' |
| 0.4 | Резервиран – винаги е 0 |
| 0.3 | Не е свързан клиентски дисплей |
| 0.2 | Не е сверен часовника |
| 0.1 | **#** Кодът на получената команда е невалиден |
| 0.0 | **#** Получените данни имат синтактична грешка |

### Байт 1: Общо предназначение

| Бит | Описание |
|-----|----------|
| 1.7 | Резервиран – винаги е 1 |
| 1.6 | Вграденият данъчен терминал не отговаря |
| 1.5 | Има неизпратени документи за повече от настроеното време за предупреждение |
| 1.4 | Резервиран – винаги е 0 |
| 1.3 | Резервиран – винаги е 0 |
| 1.2 | Резервиран – винаги е 0 |
| 1.1 | **#** Изпълнението на командата не е позволено в текущия фискален режим |
| 1.0 | При изпълнение на командата се е получило препълване на някои полета от сумите |

### Байт 2: Общо предназначение

| Бит | Описание |
|-----|----------|
| 2.7 | Резервиран – винаги е 1 |
| 2.6 | Не се използува |
| 2.5 | Отворен е служебен бон |
| 2.4 | Близък край на КЛЕН (по-малко от 10 MB свободни) |
| 2.3 | Отворен е фискален бон |
| 2.2 | Край на КЛЕН (по-малко от 1 MB свободни) |
| 2.1 | Резервиран – винаги е 0 |
| 2.0 | **#** Свършила е хартията |

### Байт 3: За състояние на конфигурационните ключета

| Бит | Описание |
|-----|----------|
| 3.7 | Резервиран – винаги е 1 |
| 3.6-3.0 | Резервирани – винаги са 0 |

### Байт 4: За ФП

| Бит | Описание |
|-----|----------|
| 4.7 | Резервиран – винаги е 1 |
| 4.6 | Не се използува |
| 4.5 | OR на всички грешки, маркирани с '*' от байтове 4 и 5 |
| 4.4 | **\*** ФП е пълна |
| 4.3 | Има място за по-малко от 50 записа във ФП |
| 4.2 | Зададени са индивидуален номер на ФУ и номер на ФП |
| 4.1 | Зададен е ЕИК |
| 4.0 | **\*** Грешка при запис във фискалната памет |

### Байт 5: За ФП

| Бит | Описание |
|-----|----------|
| 5.7 | Резервиран – винаги е 1 |
| 5.6 | Резервиран – винаги е 0 |
| 5.5 | Резервиран – винаги е 0 |
| 5.4 | Зададени са поне веднъж данъчните ставки |
| 5.3 | ФУ е във фискален режим |
| 5.2 | Резервиран – винаги е 0 |
| 5.1 | ФП е форматирана |
| 5.0 | Резервиран – винаги е 0 |

---

## ПРЕКЪСВАНЕ НА ЗАХРАНВАНЕТО

Във всеки момент състоянието на ФУ е отразено в неговите байтове на състоянието. Когато ФУ се включи след като е спирало захранването, приложната програма, чрез командите **76 (4AH)** и **103 (67H)** трябва да се осведоми за състоянието му.

Приложната програма трябва да вземе решение за по нататъшното поведение в зависимост от състоянието на ФУ. Ако е отпаднало захранването по време на печат, то след включването на ФУ ще се отпечати един ред **"***СПАД НАПРЕЖЕНИЕ***"** и ще довърши печата.

---

## ИЗДАВАНЕ НА ФИСКАЛНИ И СЛУЖЕБНИ БОНОВЕ

### А) СЛУЖЕБНИ БОНОВЕ

Бонът първо се отваря, след това се отпечатва текст и накрая се затваря.

**Използвани команди:**
- **38 (26H)** - Отваряне на служебен бон
- **42 (2АH)** - Печат на свободен текст (неограничен брой пъти)
- **39 (27H)** - Затваряне на служебен бон

### Б) ФИСКАЛНИ БОНОВЕ

Първо се отваря фискален бон, регистрират се продажбите, извършва се плащането и накрая бона се затваря.

**Използвани команди:**
- **48 (30H)** - Отваряне на фискален бон
- **49 (31H)** - Регистриране на продажба
- **51 (33H)** - Междинна сума
- **52 (34H)** - Регистриране и показване на дисплея
- **53 (35H)** - Изчисляване на сбор (плащане)
- **54 (36H)** - Печат на фискален текст
- **58 (3AH)** - Продажба на артикул
- **56 (38H)** - Затваряне на фискален бон

Накрая на деня се извършва дневен финансов отчет с нулиране (Z-отчет), за да се запише информацията във ФП. Това става с командата **69 (45H)**.

---

## КЛЕН (КОНТРОЛНА ЛЕНТА НА ЕЛЕКТРОНЕН НОСИТЕЛ)

ФУ запомня всеки ред от фискалните бонове, служебните бонове, документите със сервизна информация при инициализация, X- и Z-отчетите във енергонезависима контролна лента (КЛЕН). 

КЛЕН е с обем **минимум 2 GB** и при нормална работа би трябвало да поеме всички данни от работата на ФУ до запълване на ФП. При повреда или при запълване, КЛЕН може да се смени с празна, като старата се съхранява за евентуални справки.

### Възможни справки от КЛЕН:

- Печат на копие от документ със посочени дата и час
- Проверка валидността на SHA-1 контролната сума за документите от цял Z-отчет
- Сравняване на SHA-1 контролните суми за един или повече Z-отчети с тези, записани във ФП

### Предупреждения:

Два флага от статус-байтовете предупреждават за:
- **Близък край на КЛЕН** (10 MB свободни)
- **Край на КЛЕН** (1 MB свободни)

Ако е вдигнат флагът "Край на КЛЕН", следните команди са забранени:
- 38 - Отваряне на служебен бон
- 42 - Свободен текст в служебен бон
- 48 - Отваряне на фискален бон
- 49 - Регистриране на продажба
- 52 - Регистриране и показване на дисплея
- 54 - Печат на фискален текст
- 58 - Продажба на артикул

---

## ГЕНЕРИРАНЕ НА ОТЧЕТИ

Отчетите се генерират изцяло от ФУ при получаване на съответната команда от PC.

### Команди за отчети:

| Команда | Описание |
|---------|----------|
| 50 (32H) | Отчет промени на данъчните ставки и десетичните знаци |
| 69 (45H) | Дневен финансов отчет с или без нулиране |
| 108 (6CH) | Дневен финансов отчет с разпечатка на сумите по артикули |
| 117 (75H) | Дневен финансов отчет с разпечатка на сумите по департаменти |
| 118 (76H) | Дневен финансов отчет с разпечатка на артикули и департаменти |
| 79 (4FH) / 95 (5FH) | Съкратен отчет на ФП от дата до дата / от номер до номер |
| 73 (49H) / 94 (5EH) | Пълен отчет на ФП от дата до дата / от номер до номер |

---

## ПРОТОКОЛ НА НИСКО НИВО

### А) ТИП НА ПРОТОКОЛА - Master (Host) / Slave

ФУ изпълнява командите изпратени му от Host и връща съобщение, зависещо от резултата. ФУ не може да инициира комуникация. Само съобщения, които са резултати от изпълнението на получени команди се изпращат до Host.

Съобщенията в протокола са или **пакетирани съобщения** или **единични байтове**.

### Б) ПОСЛЕДОВАТЕЛНОСТ НА СЪОБЩЕНИЯТА

1. Host изпраща пакетирано съобщение, съдържащо командата към ФУ
2. ФУ извършва исканата операция и отговаря с пакетирано съобщение отговор
3. Host трябва да чака отговора от ФУ преди да изпрати друго съобщение

### В) НЕПАКЕТИРАНИ СЪОБЩЕНИЯ, TIME-OUT

При нормална работа на всички съобщения от Host, Slave отговаря не по-късно от **60 ms** или с пакетирано съобщение или с еднобайтов код. Host трябва да има **500 ms time-out** за получаване на отговор от Slave.

**Непакетирани съобщения:**

#### а) NAK (15H)
Този код се изпраща от Slave когато открие грешка в контролната сума или формата на полученото съобщение. Когато Host получи NAK, той трябва да предаде отново съобщение със същия пореден номер.

#### б) SYN (16H)
Този код се изпраща от Slave, когато получи команда, за която е необходимо по-дълго време за изпълнение. SYN се изпраща на всеки 60 ms, докато не е готово пакетираното съобщение за отговор.

### Г) ПАКЕТИРАНИ СЪОБЩЕНИЯ

#### Host към каса (Send):
```
<01><LEN><SEQ><CMD><DATA><05><BCC><03>
```

#### Каса към Host (Receive):
```
<01><LEN><SEQ><CMD><DATA><04><STATUS><05><BCC><03>
```

### Описание на полетата:

| Поле | Описание | Дължина | Стойност |
|------|----------|---------|----------|
| `<01>` | Preamble | 1 байт | 01H |
| `<LEN>` | Брой байтове от `<01>` (без него) до `<05>` (вкл.) плюс 20H | 1 байт | 20H - FFH |
| `<SEQ>` | Пореден номер на рамката | 1 байт | 20H - 7FH |
| `<CMD>` | Код на командата | 1 байт | 20H - 7FH |
| `<DATA>` | Данни | 0-213/218 байта | 20H-FFH, 09H, 0AH |
| `<04>` | Разделител (само от каса към Host) | 1 байт | 04H |
| `<STATUS>` | Текущо състояние на ФУ | 6 байта | 80H - FFH |
| `<05>` | Postamble | 1 байт | 05H |
| `<BCC>` | Контролна сума | 4 байта | 30H - 3FH |
| `<03>` | Terminator | 1 байт | 03H |

---

## КОМПОЗИРАНЕ НА СЪОБЩЕНИЯ, СИНТАКСИС

### Правила:

- Параметрите изпратени до ФУ могат да бъдат разделени със запетая и/или да бъдат с фиксирана дължина
- `< >` означава задължителен параметър (скобите не се съдържат в съобщението)
- `[ ]` означава незадължителен параметър (скобите не се съдържат в съобщението)
- Символите с ASCII кодове под 32 (20H) имат специално значение
- Ако трябва да изпратим такъв символ, той трябва да се предшества от 16 (10H) и да му се добави отместване 40H

### Пример:
Когато за областта за данни пишем `2500,100,Text`, то в областта за данни има:
```
2D 32 35 30 30 2C 31 30 30 2C 54 65 78 74
```
където всяко шестнайсетично число представлява ASCII стойност.

---

## СПИСЪК НА КОМАНДИТЕ ПО ПРЕДНАЗНАЧЕНИЕ

### ИНИЦИАЛИЗАЦИЯ

| Hex (Dec) | Команда |
|-----------|---------|
| 2BH (43) | Установяване на HEADER и FOOTER и опции на печат |
| 3DH (61) | Установяване на дата и час |
| 42H (66) | Задаване на допустим интервал на номерата на фактурите |
| 53H (83) | Установяване на множител, десетични знаци, име на валута и данъчни ставки |
| 55H (85) | Програмиране на допълнителните типове плащане |
| 57H (87) | Задаване име на департамент |
| 62H (98) | Установяване на ЕИК |
| 65H (101) | Задаване на парола на оператор |
| 66H (102) | Задаване на име на оператор |
| 6BH (107) | Дефиниране и отчитане на артикули |
| 73H (115) | Зареждане на графично лого |
| 8CH (140) | Съхранение данните на клиента в паметта на ФУ |
| FFH (255) | Програмиране на артикул с баркод |

### ПРОДАЖБИ

| Hex (Dec) | Команда |
|-----------|---------|
| 2ЕH (46) | Отваряне на сторно бон |
| 30H (48) | Отваряне на фискален бон |
| 31H (49) | Регистриране на продажба |
| 33H (51) | Междинна сума |
| 34H (52) | Регистриране на продажба и показване на дисплея |
| 35H (53) | Изчисляване на сбор (Плащане) |
| 36H (54) | Печатане на фискален свободен текст |
| 38H (56) | Затваряне на фискален бон |
| 39H (57) | Печат на информация за клиента |
| 3AH (58) | Регистриране продажба на програмиран артикул |
| 3CH (60) | Прекратяване (анулиране) на фискален бон |
| 6DH (109) | Печат на дублиращ бон |

### ПРИКЛЮЧВАНЕ НА ДЕНЯ

| Hex (Dec) | Команда |
|-----------|---------|
| 45H (69) | Дневен финансов отчет (с или без нулиране) |
| 6CH (108) | Разширен дневен финансов отчет (с разпечатка на артикулите) |
| 75H (117) | Разширен дневен финансов отчет (с разпечатка на департаментите) |
| 76H (118) | Разширен дневен финансов отчет (с разпечатка на департаментите и артикулите) |

### ОТЧЕТИ

| Hex (Dec) | Команда |
|-----------|---------|
| 32H (50) | Отчет на промените в данъчни ставки и десетичните знаци |
| 49H (73) | Детайлен отчет на ФП (от номер до номер) |
| 4FH (79) | Съкратен отчет на ФП (от дата до дата) |
| 5EH (94) | Детайлен отчет на ФП (от дата до дата) |
| 5FH (95) | Съкратен отчет на ФП (от номер до номер) |
| 69H (105) | Отчет оператори |
| 6FH (111) | Отчет по артикули |

### ИНФОРМАЦИЯ КЪМ HOST

| Hex (Dec) | Команда |
|-----------|---------|
| 3EH (62) | Прочита датата и часа |
| 40H (64) | Информация за последния фискален запис |
| 41H (65) | Информация за сумите за деня |
| 44H (68) | Брой на свободните записи във ФП |
| 4AH (74) | Получаване на статус-байтовете |
| 4CH (76) | Статус на фискалната транзакция |
| 56H (86) | Дата на последен запис във ФП |
| 58H (88) | Информация за натрупаните суми в департамент |
| 5AH (90) | Получаване на диагностична информация |
| 61H (97) | Получаване на данъчните ставки |
| 63H (99) | Получаване на ЕИК |
| 67H (103) | Информация за текущия бон |
| 6ЕH (110) | Получаване на информация за суми по типове плащане |
| 70H (112) | Получаване на информация за оператор |
| 71H (113) | Получаване номера на последния отпечатан документ |
| 72H (114) | Получаване информация за фискален запис или зададен период |

### ПРИНТЕРСКИ КОМАНДИ

| Hex (Dec) | Команда |
|-----------|---------|
| 2CH (44) | Придвижване на хартията |

### ДИСПЛЕЙ

| Hex (Dec) | Команда |
|-----------|---------|
| 21H (33) | Изчистване на дисплея |
| 23H (35) | Показване на текст (долен ред) |
| 2FH (47) | Показване на текст (горен ред) |
| 3FH (63) | Показване на датата и часа |
| 64H (100) | Дисплей - пълен контрол |

### ДРУГИ

| Hex (Dec) | Команда |
|-----------|---------|
| 26H (38) | Отваряне на служебен бон |
| 27H (39) | Затваряне на служебен бон |
| 2AH (42) | Печатане на свободен текст в служебен бон |
| 46H (70) | Служебно въвеждане и извеждане на пари |
| 47H (71) | Печат на диагностична информация |
| 50H (80) | Издаване на звуков сигнал |
| 59H (89) | Програмиране на производствената тестова област |
| 5CH (92) | Печат на разделителна линия |
| 6AH (106) | Отваряне на чекмедже |
| 77H (119) | Поддръжка на КЛЕН – четене, печат и информация |

---

## ПОДРОБНО ОПИСАНИЕ НА КОМАНДИТЕ

### 21H (33) - ИЗЧИСТВАНЕ НА ДИСПЛЕЯ

**Област за данни:** Няма данни  
**Отговор:** Няма данни

Изпраща се команда за изчистване на дисплея. Ако е отворен фискален бон, изчиства се само долния ред.

---

### 23H (35) - ПОКАЗВАНЕ НА ТЕКСТ НА ДОЛНИЯ РЕД НА ДИСПЛЕЯ

**Област за данни:** `<Text>`  
**Отговор:** Няма данни

**Параметри:**
- `Text` - Текст до 20 символа, който се изпраща директно към дисплея

Преди него се изпраща команда за позициониране и изчистване на долния ред.

---

### 26H (38) - ОТВАРЯНЕ НА СЛУЖЕБЕН БОН

**Област за данни:** Няма данни  
**Отговор:** `Allreceipt`

**Параметри на отговора:**
- `Allreceipt` - Броят на всички издадени бонове (фискални и служебни) от последното приключване на деня до момента (4 байта)

**ФУ извършва следните действия:**
- Отпечатва се HEADER
- Връща се отговор, съдържащ Allreceipt

**Командата не може да се изпълни, ако:**
- Има отворен фискален бон
- Вече е отворен служебен бон

---

### 27H (39) - ЗАТВАРЯНЕ НА СЛУЖЕБЕН БОН

**Област за данни:** Няма данни  
**Отговор:** `Allreceipt`

**Параметри на отговора:**
- `Allreceipt` - Броят на всички издадени бонове (фискални и служебни) от последното приключване на деня до момента (4 байта)

**ФУ извършва следните действия:**
- Отпечатва се FOOTER
- Отпечатва се поредния номер, датата и часа на документа
- Отпечатва се "СЛУЖЕБЕН БОН"
- Връща се отговор, съдържащ Allreceipt

---

### 2AH (42) - ПЕЧАТАНЕ НА СВОБОДЕН ТЕКСТ В СЛУЖЕБЕН БОН

**Област за данни:** `<Height><tab>[<Data>]` или `[<Data>]`  
**Отговор:** Няма данни

**Параметри:**
- `Height` - Височина на символите:
  - '1' - Нормална височина
  - '2' - 2x височина
  - '3' - 3x височина
- `tab` - Разделител (0x09)
- `Data` - Текст до 40 символа (опционален)

В началото и края на реда се отпечатва символът '#'.

---

### 2BH (43) - УСТАНОВЯВАНЕ НА HEADER И FOOTER И ОПЦИИ ЗА ПЕЧАТ

**Област за данни:** `<Item><Text>`  
**Отговор:** Зависи от областта за данни

HEADER се състои от 6 реда текст, които се отпечатват в началото на всеки фискален или служебен бон. За нормална работа на ФУ е необходимо да се зададат поне 2 реда Header. ЕИК се печати винаги на трети ред.

FOOTER се състои от 2 линии текст, които се отпечатват в края на всеки бон.

**Параметър Item - опции:**

| Item | Описание |
|------|----------|
| '0'-'7' | Номер на линията (0-5 за HEADER, 6-7 за FOOTER) |
| 'A' | Автоматично форматиране на продажбите като за фактура |
| 'B' | Размер на баркода (24-240) |
| 'D' | Плътност на печат (1-5) |
| 'E' | Печат на обща сума в EUR |
| 'L' | Разрешаване/забраняване на графично лого |
| 'N' | Печат на името на департамента |
| 'T' | Печат на натрупан ДДС за бона |
| 'X' | Автоматично отваряне на чекмедже |
| 'I' | Прочитане на зададени стойности |

---

### 2CH (44) - ПРИДВИЖВАНЕ НА ХАРТИЯТА

**Област за данни:** `[Lines]`  
**Отговор:** Няма данни

**Параметри:**
- `Lines` - Броят на редовете (1-99). Ако липсва, подразбира се 1 ред

---

### 2EH (46) - ОТВАРЯНЕ НА СТОРНО ФИСКАЛЕН БОН

**Област за данни:** 
```
<OpCode>,<OpPwd>,<NSale>,<TillNmb>,<DocType>,<DocNumber>,<DocDateTime>,
<FMNumber>[,<Invoice>,<InvNumber>,<Reason>]
```

**Отговор:** `<ErrCode>` или `<AllReceipt>,<StrReceipt>`

**Задължителни параметри:**
- `OpCode` - Номер на оператор (1-30)
- `OpPwd` - Парола на оператора (до 8 символа)
- `NSale` - УНП (21 символа формат CCCCCCCC-CCCC-DDDDDDD)
- `TillNmb` - Номер на касово място (1-99999)
- `DocType` - Причина за сторно:
  - 0 - операторска грешка
  - 1 - връщане/замяна
  - 2 - намаление на данъчната основа
- `DocNumber` - Номер на документа (1-9999999)
- `DocDateTime` - Дата и час (ДДММГГччмм или ДДММГГччммсс)
- `FMNumber` - Номер на ФП (8 знака)

**Опционални параметри:**
- `Invoice` - Сторно по фактура ('I')
- `InvNumber` - Номер на фактура (1-9999999999)
- `Reason` - Причина за издаване (до 42 символа)

---

### 30H (48) - ОТВАРЯНЕ НА ФИСКАЛЕН БОН

**Област за данни:** 
```
<OpCode>,<OpPwd>,<NSale>,<TillNmb>[,<Invoice>]
или
<OpCode>,<OpPwd>,<TillNmb>[,<Invoice>]
```

**Отговор:** `<ErrCode>` или `<AllReceipt>,<FiscalReceipt>`

**Параметри:**
- `OpCode` - Номер на оператор (1-30)
- `OpPwd` - Операторска парола (1-8 цифри)
- `NSale` - УНП (21 символа, задължителен в първия синтаксис)
- `TillNmb` - Номер на касово място (1-99999)
- `Invoice` - "I" за фактура (опционално)

**Отговор:**
- `Allreceipt` - Брой всички бонове (4 байта)
- `FiscReceipt` - Брой фискални бонове (4 байта)

**ФУ извършва:**
- Отпечатва HEADER
- Отпечатва номер и име на оператор и номер на касово място
- Връща AllReceipt и FiscReceipt

---

### 31H (49) - РЕГИСТРИРАНЕ НА ПРОДАЖБА

**Област за данни:**
```
[<L1>][<Lf><L2>]<Tab><TaxCd><[Sign]Price>[*<Qwan>][,Perc|;Abs]
или
[<L1>][<Lf><L2>]<Tab><Dept><Tab><[Sign]Price>[*<Qwan>][,Perc|;Abs]
```

**Отговор:** Няма данни

**Параметри:**
- `L1` - Текст до 22 байта (първи ред)
- `Lf` - Line feed (0Ah)
- `L2` - Текст до 22 байта (втори ред)
- `Tab` - Табулация (09h)
- `TaxCd` - Данъчна група ('А'-'З')
- `Dept` - Номер на департамент (1-9)
- `Sign` - Знак минус ('-')
- `Price` - Единична цена (до 8 значещи цифри)
- `Qwan` - Количество (до 8 значещи цифри, до 3 след десетичната точка)
- `Perc` - Надбавка/отстъпка в проценти (-99.00 до 99.00)
- `Abs` - Надбавка/отстъпка като сума

**ФУ извършва:**
- Отпечатва име на департамент (ако е разрешено)
- Отпечатва текст, цена и данъчна група
- Актуализира регистри
- Отпечатва отстъпка/надбавка (ако има)

---

### 33H (51) - МЕЖДИННА СУМА

**Област за данни:** `<Print><Display>[,Perc|;Abs]`  
**Отговор:** `SubTotal,TaxA,TaxB,TaxC,TaxD,TaxE,TaxF,TaxG,TaxH`

**Параметри:**
- `Print` - '1' за отпечатване
- `Display` - '1' за показване на дисплея
- `Perc` - Отстъпка/надбавка в проценти
- `Abs` - Отстъпка/надбавка като сума

**Отговор:**
- `SubTotal` - Сума до момента (до 10 байта)
- `TaxA-H` - Суми по данъчни групи (до 10 байта всяка)

---

### 35H (53) - ИЗЧИСЛЯВАНЕ НА СБОР (ПЛАЩАНЕ)

**Област за данни:** `[<Line1>][<Lf><Line2>]<Tab>[[<PaidMode>]<[Sign]Amount>][*<Type>]`  
**Отговор:** `<PaidCode><Amount>`

**Параметри:**
- `Line1`, `Line2` - Текст до 42 байта
- `Lf` - Line feed (0Ah)
- `Tab` - Табулация (09h)
- `PaidMode` - Начин на плащане:
  - 'P' - В брой (по подразбиране)
  - 'N' - С кредит
  - 'C' - С дебитна карта
  - 'D' - С НЗОК
  - 'I' - С ваучер
  - 'J' - С купон
- `Sign` - Знак ('+')
- `Amount` - Сума (до 10 значещи цифри)
- `Type` - Тип на плащане с пинпад

**Отговор PaidCode:**
- 'F' - Грешка
- 'E' - Отрицателна междинна сума
- 'D' - Недостатъчно платена сума
- 'R' - Ресто
- 'I' - Отрицателна сума по данъчна група

При плащане с пинпад отговорът може да съдържа и информация за грешки или детайли за транзакцията.

---

### 38H (56) - ЗАТВАРЯНЕ НА ФИСКАЛЕН БОН

**Област за данни:** Няма данни  
**Отговор:** `Allreceipt, FiscReceipt`

**Параметри на отговора:**
- `Allreceipt` - Всички издадени бележки от последното приключване на деня
- `FiscReceipt` - Всички издадени фискални бележки от последното приключване на деня

Натрупаните суми от фискалния бон се прибавят към дневните суми в регистрите на оперативната памет.

**Командата не може да се изпълни, ако:**
- Не е отворен фискален бон
- Команда 53 (35h) не е изпълнена успешно
- Платената сума е по-малка от общата сума на бона

---

### 3AH (58) - РЕГИСТРИРАНЕ НА АРТИКУЛ

**Област за данни:** `[D]<[Sign]PLU>[<Tab><Dept><Tab>][*<Qwan>][,Perc|;Abs]`  
**Отговор:** Няма данни

**Параметри:**
- `D` - 'D' за показване на дисплея
- `Sign` - Знак минус ('-')
- `PLU` - Номер на артикула (1-999999999)
- `Tab` - Табулация (ASCII 9)
- `Dept` - Номер на департамент (1-9)
- `Qwan` - Количество (до 8 значещи цифри, до 3 след десетичната точка)
- `Perc` - Отстъпка/надбавка в проценти (-99.00 до 99.00)
- `Abs` - Отстъпка/надбавка като сума

**ФУ извършва:**
- Прочита от таблицата името, цената и данъчната група
- Отпечатва името, количеството и цената
- Актуализира регистри за суми и количества

---

### 45H (69) - ДНЕВЕН ФИНАНСОВ ОТЧЕТ

**Област за данни:** `[<Option>]`  
**Отговор:** `Closure,FM_Total,TotA,TotB,TotC,TotD,TotE,TotF,TotG,TotH`

**Параметри:**
- `Option` - Вид на отчета:
  - '0' - Z-отчет (с нулиране и запис във ФП)
  - '2' - X-отчет (без нулиране и запис във ФП)

**Отговор:**
- `Closure` - Номер на фискалния запис (4 байта)
- `FM_Total` - Сумата от всички продажби (12 байта със знак)
- `TotA-H` - Суми по данъчни групи (12 байта със знак)

---

### 4AH (74) - ПОЛУЧАВАНЕ НА СТАТУСИТЕ

**Област за данни:** `[Option]`  
**Отговор:** `<S0><S1><S2><S3><S4><S5>`

**Параметри:**
- `Option`:
  - 'W' - Чака да се отпечатат всички буфери
  - 'X' - Не изчаква

**Отговор:**
- `S0-S5` - 6 статус байта

---

### 53H (83) - УСТАНОВЯВАНЕ НА ВАЛУТА И ДАНЪЧНИ СТАВКИ

**Област за данни:** `[Multiplier,Decimals,Currency,EnabledT,TaxA,...]`  
**Отговор:** `Multiplier,Decimals,Currency_name,EnabledT,TaxA,TaxB,TaxC,TaxD,...`

**Параметри:**
- `Multiplier` - Множител (0-3, деактивиран)
- `Decimals` - Десетични знаци (0-2)
- `Currency` - Име на валута (до 3 байта)
- `EnabledT` - 8 байта '0' или '1' за забранена/разрешена данъчна група
- `TaxA-H` - Стойности на данъчните ставки

Ако областта за данни е празна, ФУ връща текущите стойности.

> **ВАЖНО:** Установяването на нови данъчни ставки е разрешено само преди издаването на първия фискален бон за деня.

---

### 62H (98) - УСТАНОВЯВАНЕ НА ЕИК

**Област за данни:** `<Text>[,<Name>]`  
**Отговор:** `Result`

**Параметри:**
- `Text` - ЕИК (до 14 байта)
- `Name` - Коментарен текст (по подразбиране "ЕИК")

**Отговор:**
- `Result`:
  - 'P' - Няма грешка
  - 'F' - Грешка

---

### 6BH (107) - ДЕФИНИРАНЕ И ЧЕТЕНЕ НА АРТИКУЛИ

**Област за данни:** `<Option>[Parameters]`  
**Отговор:** `ErrorCode[,Data]`

**Опции:**

| Option | Операция |
|--------|----------|
| 'I' | Информация за артикули (общ брой, програмирани, макс. дължина) |
| 'P' | Програмиране на артикул |
| 'A' | Промяна на наличното количество |
| 'D' | Изтриване на артикул(и) |
| 'R' | Прочитане данни за артикул |
| 'F' | Първи програмиран артикул |
| 'L' | Последен програмиран артикул |
| 'N' | Следващ програмиран артикул |
| 'f' | Първи артикул с продажби |
| 'l' | Последен артикул с продажби |
| 'n' | Следващ артикул с продажби |
| 'X' | Първи свободен номер |
| 'x' | Последен свободен номер |

#### Програмиране на артикул ('P'):
```
<P><TaxGr><PLU>,<Group>,<SPrice>,[<Replace>]<Quantity>,<Name>
```

---

### 77H (119) - РАБОТА С КЛЕН

**Област за данни:** `<Type>[,<InpData>]`  
**Отговор:** Зависи от входните данни

**Типове команди:**

#### 'N' - Четене на следващ текстов ред
Връща следващия ред от документ, започнат с команда от клас 'R'.

#### 'R' - Четене на данни от КЛЕН

**Синтаксис:**
```
<Flg><DT1>,<DT2>
```

- `Flg` - Тип на документ ('A' за всички)
- `DT1` - Начална дата и час (DDMMYY[hhmmss])
- `DT2` - Крайна дата и час (DDMMYY[hhmmss])

**Отговори:**
- `P,Text` - Има пореден текстов ред
- `F` - Няма повече данни

**Директно четене:**
```
Q<Addr>,<Bytes>
```
Връща данни в шестнайсетичен вид.

---

### 8CH (140) - СЪХРАНЕНИЕ НА ДАННИ ЗА КЛИЕНТ

**Област за данни:** `[<Option>]<Data>`  
**Отговор:** Зависи от Option

**Опции:**

| Option | Операция |
|--------|----------|
| '+' | Запис/промяна на данни за клиент по ЕИК |
| '-' | Изтриване на данни за клиент по ЕИК |
| '#' | Четене на данни за клиент по ЕИК |
| '^' | Запис на име на продавач |
| '$' | Четене на име на продавач |
| '~' | Четене на първия клиент |
| '@' | Четене на следващия клиент |
| '!' | Изтриване на всички клиенти |

Апаратът може да съхранява до **1080 записа** с данни за клиенти.

---

## ПРИЛОЖЕНИЕ 1: НАБОР ОТ ЗНАЦИ

ФУ поддържа кирилица (Windows-1251 и DOS кодова таблица), латиница и специални символи.

---

## ПРИЛОЖЕНИЕ 2: СПИСЪК НА КОМАНДИТЕ ПО НОМЕР

Пълен списък на всички 80+ команди, подредени по шестнайсетичен номер от 21H до FFH, с кратко описание на всяка.

---

## ЗАКЛЮЧЕНИЕ

Този документ описва пълния програмен интерфейс на фискалните устройства DATECS серия DP. За успешна интеграция е необходимо:

1. Спазване на протокола на ниско ниво (пакетиране, контролни суми)
2. Правилна последователност на командите
3. Проверка на статус битовете след всяка команда
4. Обработка на грешки и изключителни ситуации
5. Редовно приключване на деня с Z-отчет
6. Поддръжка на КЛЕН

За допълнителна информация и техническа поддръжка: [DATECS](http://www.datecs.bg)

---

*Документ версия 2.04BG*  
*© DATECS*
